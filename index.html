        async login() {
          if (!this.email || !this.password) {
            this.showNotification('Preencha email e senha', 'error');
            return;
          }

          this.authLoading = true;
          try {
            await auth.signInWithEmailAndPassword(this.email, this.password);
            this.showNotification('Login realizado com sucesso!', 'success');
          } catch (error) {
            console.error('Erro no login:', error);
            this.showNotification('Erro no login: ' + error.message, 'error');
          }
          this.authLoading = false;
        },

        async register() {
          if (!this.email || !this.password || !this.displayName) {
            this.showNotification('Preencha todos os campos', 'error');
            return;
          }

          if (this.password.length < 6) {
            this.showNotification('Senha deve ter pelo menos 6 caracteres', 'error');
            return;
          }

          this.authLoading = true;
          try {
            const userCredential = await auth.createUserWithEmailAndPassword(this.email, this.password);
            await userCredential.user.updateProfile({ displayName: this.displayName });
            
            // Criar documento do usuário com configurações padrão
            await db.collection('users').doc(userCredential.user.uid).set({
              displayName: this.displayName,
              email: this.email,
              isPublic: false,
              createdAt: new Date()
            });
            
            this.showNotification('Conta criada com sucesso!', 'success');
          } catch (error) {
            console.error('Erro no registro:', error);
            this.showNotification('Erro no registro: ' + error.message, 'error');
          }
          this.authLoading = false;
        },

        confirmLogout() {
          if (confirm('Deseja realmente sair?')) {
            auth.signOut();
            this.showNotification('Logout realizado com sucesso!', 'success');
          }
        },

        async confirmAddRecord() {
          if (!this.newRecord.album || !this.newRecord.artist || !this.newRecord.format) {
            this.showNotification('Preencha os campos obrigatórios', 'error');
            return;
          }
        
          // Se não tiver capa definida, tenta buscar automaticamente
          if (!this.newRecord.cover_url) {
            await this.fetchAlbumCover();
          }
        
          if (confirm('Adicionar este item à coleção?')) {
            await this.addRecord();
          }
        },

        async addRecord() {
          this.formLoading = true;
          try {
            const userId = this.user.uid;
            const recordData = {
              ...this.newRecord,
              created_at: new Date(),
              user_id: userId
            };

            if (this.newRecord.id) {
              // Atualizar registro existente
              await db.collection('users').doc(userId).collection('records').doc(this.newRecord.id).update(recordData);
              this.showNotification('Item atualizado com sucesso!', 'success');
            } else {
              // Adicionar novo registro
              await db.collection('users').doc(userId).collection('records').add(recordData);
              this.showNotification('Item adicionado com sucesso!', 'success');
            }
            
            this.resetForm();
            this.currentView = 'collection';
          } catch (error) {
            console.error('Erro ao salvar:', error);
            this.showNotification('Erro ao salvar item', 'error');
          }
          this.formLoading = false;
        },

        editRecord(record) {
          this.newRecord = { ...record };
          this.currentView = 'add-record';
          this.showNotification('Editando item...', 'info');
          // Close mobile sidebar if open
          this.showMobileSidebar = false;
        },
    
        confirmDeleteRecord(recordId) {
          if (confirm('Deseja realmente excluir este item?')) {
            this.deleteRecord(recordId);
          }
        },

        async deleteRecord(recordId) {
          try {
            const userId = this.user.uid;
            await db.collection('users').doc(userId).collection('records').doc(recordId).delete();
            this.showNotification('Item excluído com sucesso!', 'success');
          } catch (error) {
            console.error('Erro ao excluir:', error);
            this.showNotification('Erro ao excluir item', 'error');
          }
        },

        filterAndSortCollection() {
          let filtered = this.collection;
          
          // Aplicar filtro de busca
          if (this.searchFilter.trim()) {
            const filter = this.searchFilter.toLowerCase();
            filtered = filtered.filter(record => 
              record.album?.toLowerCase().includes(filter) ||
              record.artist?.toLowerCase().includes(filter) ||
              record.format?.toLowerCase().includes(filter) ||
              record.year?.toString().includes(filter)
            );
          }
          
          // Aplicar ordenação
          filtered.sort((a, b) => {
            let valueA, valueB;
            
            switch(this.sortBy) {
              case 'album':
                valueA = (a.album || '').toLowerCase();
                valueB = (b.album || '').toLowerCase();
                break;
              case 'artist':
                valueA = (a.artist || '').toLowerCase();
                valueB = (b.artist || '').toLowerCase();
                break;
              case 'year':
                valueA = parseInt(a.year) || 0;
                valueB = parseInt(b.year) || 0;
                break;
              default:
                return 0;
            }
            
            if (this.sortOrder === 'asc') {
              return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
            } else {
              return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
            }
          });
          
          this.filteredCollection = filtered;
        },

        filterCollection() {
          this.filterAndSortCollection();
        },

        setSortBy(field) {
          if (this.sortBy === field) {
            this.toggleSortOrder();
          } else {
            this.sortBy = field;
            this.sortOrder = 'asc';
          }
          this.filterAndSortCollection();
          setTimeout(() => lucide.createIcons(), 10);
        },

        toggleSortOrder() {
          this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
          this.filterAndSortCollection();
          setTimeout(() => lucide.createIcons(), 10);
        },

        resetForm() {
          this.newRecord = {
            album: '', 
            artist: '', 
            format: '', 
            year: '', 
            catalog_number: '', 
            cover_url: '',
            description: '' // NOVA linha
          };
        },

        searchCoverOnGoogle() {
          const query = `${this.newRecord.album} ${this.newRecord.artist} album cover`;
          window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`, '_blank');
        },

        async fetchAlbumCover() {
          try {
            const query = `${this.newRecord.album} ${this.newRecord.artist}`.trim();
            if (!query) return;
            
            this.showNotification('Buscando capa...', 'info');
            
            // Usando iTunes Search API que não tem restrições de CORS
            const itunesUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=album&limit=1`;
            
            const response = await fetch(itunesUrl);
            
            if (!response.ok) {
              throw new Error('Erro na busca do iTunes');
            }
            
            const data = await response.json();

            if (data.results && data.results.length > 0) {
              const album = data.results[0];
              if (album.artworkUrl100) {
                // Pega a versão em alta resolução da capa
                const highResUrl = album.artworkUrl100.replace('100x100bb', '600x600bb');
                this.newRecord.cover_url = highResUrl;
                this.showNotification('Capa encontrada automaticamente!', 'success');
                return;
              }
            }

            this.showNotification('Nenhuma capa encontrada automaticamente', 'info');
          } catch (error) {
            console.error('Erro ao buscar capa:', error);
            this.showNotification('Não foi possível buscar capa automática', 'error');
          }
        },

        toggleTheme() {
          this.darkMode = !this.darkMode;
          localStorage.setItem('katalog-theme', this.darkMode ? 'dark' : 'light');
        },

        async updateDisplayName() {
          if (!this.newDisplayName?.trim()) return;

          try {
            await this.user.updateProfile({ displayName: this.newDisplayName.trim() });
            
            // Atualizar também no documento do usuário
            await db.collection('users').doc(this.user.uid).set({
              displayName: this.newDisplayName.trim(),
              email: this.user.email,
              updatedAt: new Date()
            }, { merge: true });
            
            this.showNotification('Nome atualizado com sucesso!', 'success');
            this.newDisplayName = '';
          } catch (error) {
            console.error('Erro ao atualizar nome:', error);
            this.showNotification('Erro ao atualizar nome', 'error');
          }
        },

        confirmDeleteAccount() {
          this.deleteAccountModal = { 
            show: true, 
            email: '', 
            password: '', 
            confirmed: false, 
            loading: false 
          };
          this.configModal = false;
        },

        cancelDeleteAccount() {
          this.deleteAccountModal = { 
            show: false, 
            email: '', 
            password: '', 
            confirmed: false, 
            loading: false 
          };
        },

        async proceedDeleteAccount() {
          if (!this.deleteAccountModal.email || !this.deleteAccountModal.password || !this.deleteAccountModal.confirmed) {
            this.showNotification('Preencha todos os campos e confirme a ação', 'error');
            return;
          }

          if (this.deleteAccountModal.email !== this.user.email) {
            this.showNotification('Email não confere com o da conta', 'error');
            return;
          }

          this.deleteAccountModal.loading = true;
          
          try {
            const user = firebase.auth().currentUser;
            
            // 1. Reautenticar usuário com tratamento de erro melhorado
            const credential = firebase.auth.EmailAuthProvider.credential(
              this.deleteAccountModal.email.trim(), 
              this.deleteAccountModal.password
            );
            
            await user.reauthenticateWithCredential(credential);

            // 2. Deletar todos os registros do Firestore
            const userId = user.uid;
            const recordsSnapshot = await db.collection('users').doc(userId).collection('records').get();
            
            if (!recordsSnapshot.empty) {
              const batch = db.batch();
              recordsSnapshot.forEach(doc => batch.delete(doc.ref));
              await batch.commit();
            }

            // 3. Deletar documento do usuário
            await db.collection('users').doc(userId).delete();

            // 4. Excluir usuário
            await user.delete();

            this.showNotification('Conta excluída com sucesso!', 'success');
            
            // 5. Resetar estado
            this.cancelDeleteAccount();
            
            // 6. Logout será automático após delete()

          } catch (error) {
            console.error('Erro ao excluir conta:', error);
            
            let errorMessage = 'Erro ao excluir conta';
            
            switch(error.code) {
              case 'auth/wrong-password':
                errorMessage = 'Senha incorreta';
                break;
              case 'auth/too-many-requests':
                errorMessage = 'Muitas tentativas. Tente novamente mais tarde';
                break;
              case 'auth/requires-recent-login':
                errorMessage = 'É necessário fazer login novamente antes de excluir a conta';
                break;
              case 'auth/user-token-expired':
                errorMessage = 'Sessão expirada. Faça login novamente';
                break;
              default:
                errorMessage = `Erro: ${error.message}`;
            }
            
            this.showNotification(errorMessage, 'error');
          }
          
          this.deleteAccountModal.loading = false;
        },
        
        handleFileUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const sheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[sheetName];
              const jsonData = XLSX.utils.sheet_to_json(worksheet);

              this.processImportData(jsonData);
            } catch (error) {
              console.error('Erro ao processar arquivo:', error);
              this.showNotification('Erro ao processar arquivo Excel', 'error');
            }
          };
          reader.readAsArrayBuffer(file);
        },

        processImportData(data) {
          const validRecords = data.filter(row => 
            row.album && row.artist && row.format
          ).map(row => ({
            album: row.album?.toString().trim(),
            artist: row.artist?.toString().trim(),
            format: row.format?.toString().trim(),
            year: row.year ? parseInt(row.year) : '',
            catalog_number: row.catalog_number?.toString().trim() || '',
            cover_url: row.cover_url?.toString().trim() || '',
            description: row.description?.toString().trim() || '' // NOVA linha
          }));

          this.importModal.data = validRecords;
          this.importModal.preview = validRecords.slice(0, 3);

          if (validRecords.length === 0) {
            this.showNotification('Nenhum registro válido encontrado no arquivo', 'error');
          }
        },
      
        async importRecords() {
          if (this.importModal.data.length === 0) return;
        
          this.importModal.loading = true;
          try {
            const userId = this.user.uid;
            const batch = db.batch();
        
            // Buscar capas para itens que não têm cover_url
            for (let i = 0; i < this.importModal.data.length; i++) {
              const record = this.importModal.data[i];
              
              // Se não tem capa, tenta buscar automaticamente
              if (!record.cover_url && record.album && record.artist) {
                try {
                  const query = `${record.album} ${record.artist}`.trim();
                  const itunesUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=album&limit=1`;
                  
                  const response = await fetch(itunesUrl);
                  if (response.ok) {
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                      const album = data.results[0];
                      if (album.artworkUrl100) {
                        const highResUrl = album.artworkUrl100.replace('100x100bb', '600x600bb');
                        record.cover_url = highResUrl;
                      }
                    }
                  }
                } catch (error) {
                  console.log(`Não foi possível buscar capa para: ${record.album} - ${record.artist}`);
                }
                
                // Pequeno delay para não sobrecarregar a API
                await new Promise(resolve => setTimeout(resolve, 100));
              }
            }
        
            // Salvar todos os registros no Firebase
            this.importModal.data.forEach(record => {
              const docRef = db.collection('users').doc(userId).collection('records').doc();
              batch.set(docRef, {
                ...record,
                created_at: new Date(),
                user_id: userId
              });
            });
        
            await batch.commit();
            this.showNotification(`${this.importModal.data.length} itens importados com sucesso!`, 'success');
            this.closeImportModal();
            
          } catch (error) {
            console.error('Erro na importação:', error);
            this.showNotification('Erro ao importar registros', 'error');
          }
          
          this.importModal.loading = false;
        },

        closeImportModal() {
          this.importModal = { show: false, data: [], preview: [], loading: false };
        },

        // Export de coleção (backup) em arquivo Excel
        exportToExcel() {
          if (this.collection.length === 0) {
            this.showNotification('Nenhum item na coleção para exportar', 'error');
            return;
          }
        
          try {
            // Preparar dados para exportação
            const exportData = this.collection.map(record => ({
              'Álbum': record.album || '',
              'Artista': record.artist || '',
              'Formato': record.format || '',
              'Ano': record.year || '',
              'Número de Catálogo': record.catalog_number || '',
              'Descrição': record.description || '', // NOVA linha
              'URL da Capa': record.cover_url || '',
              'Data de Adição': record.created_at ? new Date(record.created_at.seconds * 1000).toLocaleDateString('pt-BR') : ''
            }));
        
            // Criar workbook
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            
            // Definir larguras das colunas
            ws['!cols'] = [
              { wch: 30 }, // Álbum
              { wch: 25 }, // Artista  
              { wch: 10 }, // Formato
              { wch: 8 },  // Ano
              { wch: 20 }, // Número de Catálogo
              { wch: 40 }, // Descrição
              { wch: 50 }, // URL da Capa
              { wch: 15 }  // Data de Adição
            ];
        
            XLSX.utils.book_append_sheet(wb, ws, "Minha Coleção");
        
            // Gerar nome do arquivo com data
            const today = new Date().toISOString().split('T')[0];
            const fileName = `katalog-backup-${today}.xlsx`;
        
            // Download do arquivo
            XLSX.writeFile(wb, fileName);
        
            this.showNotification(`Backup exportado: ${fileName}`, 'success');
            
          } catch (error) {
            console.error('Erro ao exportar:', error);
            this.showNotification('Erro ao gerar backup', 'error');
          }
        },

        showNotification(message, type = 'success') {
          this.notification = { show: true, message, type };
          setTimeout(() => {
            this.notification.show = false;
          }, 4000);
          setTimeout(() => lucide.createIcons(), 10);
        }

      }));
    });

    // Inicializar ícones após carregamento
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => lucide.createIcons(), 100);
      // Re-criar ícones periodicamente para garantir que apareçam
      setInterval(() => lucide.createIcons(), 1000);
    });
  </script>
</body>
</html>          
          <!-- Empty State -->
          <div x-show="collection.length === 0" class="text-center py-12 md:py-20 bg-card rounded-lg">
            <i data-lucide="folder-x" class="mx-auto h-12 w-12 md:h-16 md:w-16 text-muted mb-4"></i>
            <h3 class="text-lg md:text-xl font-semibold">Sua coleção está vazia</h3>
            <p class="text-muted mt-2">Comece adicionando seu primeiro item!</p>
            <button @click="currentView = 'add-record'" class="mt-4 md:mt-6 px-4 py-2 md:px-6 md:py-2 rounded-full btn-primary">
              Adicionar Item
            </button>
          </div>
        </div>

        <!-- Form Adicionar -->
        <div x-show="currentView === 'add-record'">
          <h2 class="text-2xl md:text-3xl font-bold mb-6">Adicionar Novo Item</h2>
          <form @submit.prevent="confirmAddRecord()" class="max-w-3xl mx-auto bg-card p-4 md:p-8 rounded-lg space-y-4 md:space-y-6">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Álbum/Título *</label>
                <input x-model="newRecord.album" required 
                       class="w-full p-3 bg-input border border-custom rounded-md">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Artista *</label>
                <input x-model="newRecord.artist" required 
                       class="w-full p-3 bg-input border border-custom rounded-md">
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Formato *</label>
                <select x-model="newRecord.format" required
                        class="w-full p-3 bg-input border border-custom rounded-md">
                  <option value="">Selecione...</option>
                  <option value="CD">CD</option>
                  <option value="Vinil">Vinil</option>
                  <option value="Cassete">Cassete</option>
                  <option value="Digital">Digital</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Ano</label>
                <input x-model="newRecord.year" type="number" min="1900" max="2030"
                       class="w-full p-3 bg-input border border-custom rounded-md">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Número de Catálogo</label>
                <input x-model="newRecord.catalog_number"
                       class="w-full p-3 bg-input border border-custom rounded-md">
              </div>
            </div>

            <!-- Campo Descrição -->
            <div>
              <label class="block text-sm font-medium mb-1">Descrição</label>
              <textarea x-model="newRecord.description" rows="3"
                        placeholder="Descreva detalhes sobre esta edição, estado de conservação, etc..."
                        class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom"></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium mb-3">Capa do Álbum</label>
              
              <div class="mb-4">
                <button type="button" @click="searchCoverOnGoogle()" 
                        :disabled="!newRecord.album || !newRecord.artist"
                        class="w-full md:w-auto px-4 py-2 btn-primary rounded-md flex items-center justify-center">
                  <i data-lucide="search" class="w-4 h-4 mr-2"></i>
                  Buscar Capa no Google Imagens
                </button>
                <p class="text-xs text-muted mt-1">
                  Clique com o botão direito na imagem → "Copiar endereço da imagem"
                </p>
              </div>
              
              <input x-model="newRecord.cover_url" placeholder="Cole aqui a URL da capa..."
                     class="w-full p-3 bg-input border border-custom rounded-md mb-4">
              
              <div x-show="newRecord.cover_url" class="mb-4">
                <p class="text-sm text-muted mb-2">Preview:</p>
                <img :src="newRecord.cover_url" class="w-24 h-24 md:w-32 md:h-32 object-cover rounded-md" 
                     @error="newRecord.cover_url = ''">
              </div>
            </div>
            
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
              <button type="submit" :disabled="formLoading" 
                      class="flex-1 py-3 btn-primary rounded-md">
                <span x-show="!formLoading">Salvar Item</span>
                <span x-show="formLoading">Salvando...</span>
              </button>
              <button type="button" @click="resetForm()" 
                      class="px-6 py-3 btn-secondary rounded-md">Limpar</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

    <!-- Mobile Bottom Navigation (apenas para usuários logados) -->
  <nav x-show="user && !isSharedView" class="mobile-bottom-nav mobile-only md:hidden">
    <div class="flex justify-around items-center py-3">
      <button @click="currentView = 'collection'" 
              :class="{'text-green-400': currentView === 'collection'}"
              class="flex flex-col items-center space-y-1 px-3 py-2">
        <i data-lucide="album" class="w-5 h-5"></i>
        <span class="text-xs">Coleção</span>
      </button>
      <button @click="currentView = 'add-record'" 
              :class="{'text-green-400': currentView === 'add-record'}"
              class="flex flex-col items-center space-y-1 px-3 py-2">
        <i data-lucide="plus-circle" class="w-5 h-5"></i>
        <span class="text-xs">Adicionar</span>
      </button>
      <button @click="currentView = 'stats'" 
              :class="{'text-green-400': currentView === 'stats'}"
              class="flex flex-col items-center space-y-1 px-3 py-2 text-yellow-300">
        <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
        <span class="text-xs">Gráficos</span>
      </button>
      <button @click="importModal.show = true" 
              class="flex flex-col items-center space-y-1 px-3 py-2 text-blue-300">
        <i data-lucide="upload" class="w-5 h-5"></i>
        <span class="text-xs">Importar</span>
      </button>
    </div>
  </nav>

  <!-- Floating Action Button (Mobile, apenas para usuários logados) -->
  <button x-show="currentView === 'collection' && collection.length === 0 && !isSharedView" 
          @click="currentView = 'add-record'"
          class="fab btn-primary mobile-only">
    <i data-lucide="plus" class="w-6 h-6"></i>
  </button>

  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAzEu2hLmvPzaFLgQtXUAUkuXvwokD2F-A",
      authDomain: "katalog-1178e.firebaseapp.com",
      projectId: "katalog-1178e",
      storageBucket: "katalog-1178e.firebasestorage.app",
      messagingSenderId: "998961219093",
      appId: "1:998961219093:web:6afddd14ad2ddd9ed3301c"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    document.addEventListener('alpine:init', () => {
      Alpine.data('app', () => ({
        loading: true,
        user: null,
        authLoading: false,
        formLoading: false,
        
        // NOVAS VARIÁVEIS PARA COMPARTILHAMENTO
        isSharedView: false,
        sharedUserId: null,
        sharedCollection: { records: [], owner: null },
        filteredSharedCollection: [],
        sharedSearchFilter: '',
        sharedViewMode: 'grid',
        collectionIsPublic: false,
        privacyUpdateLoading: false,
        shareUrl: '',
        
        // Device Detection
        isMobile: window.innerWidth < 769,
        showMobileSidebar: false,
        
        // Tema
        darkMode: localStorage.getItem('katalog-theme') !== 'light',
        
        // UI
        currentView: 'collection',
        viewMode: 'grid',
        showRegister: false,
        configModal: false,
        searchFilter: '',
        
        // Modals
        importModal: { show: false, data: [], preview: [], loading: false },
        
        // NOVO: Modal de detalhes do álbum
        albumDetailsModal: { show: false, record: {} },
        
        // NOVO: Estatísticas
        stats: {
          duplicates: [],
          uniqueArtists: 0,
          averageYear: 0,
          oldestYear: 0
        },
        
        // Data
        collection: [],
        filteredCollection: [],
        sortBy: 'album',
        sortOrder: 'asc',
        newRecord: { 
          album: '', 
          artist: '', 
          format: '', 
          year: '', 
          catalog_number: '', 
          cover_url: '',
          description: '' // NOVO campo
        },
        
        // Auth
        email: '',
        password: '',
        displayName: '',
        newDisplayName: '',
        
        // Notification
        notification: { show: false, message: '', type: 'success' },

        // Modal de exclusão de conta
        deleteAccountModal: { 
          show: false, 
          email: '', 
          password: '', 
          confirmed: false, 
          loading: false 
        },

        async init() {
          try {
            // NOVA LÓGICA: Verificar se é uma URL compartilhada
            await this.checkForSharedCollection();
            
            if (this.isSharedView) {
              this.loading = false;
              lucide.createIcons();
              return;
            }

            // Device detection
            this.checkDevice();
            window.addEventListener('resize', () => {
              this.checkDevice();
            });

            auth.onAuthStateChanged((user) => {
              this.user = user;
              if (user) {
                this.setupCollection(user.uid);
                this.loadUserSettings(user.uid);
              } else {
                this.collection = [];
                this.filteredCollection = [];
              }
              this.loading = false;
              setTimeout(() => lucide.createIcons(), 100);
            });
            
            lucide.createIcons();
            setTimeout(() => lucide.createIcons(), 50);
          } catch (error) {
            console.error('Erro na inicialização:', error);
            this.showNotification('Erro ao carregar aplicação', 'error');
            this.loading = false;
          }
        },

        // NOVA FUNÇÃO: Verificar se é uma coleção compartilhada
        async checkForSharedCollection() {
          const urlParams = new URLSearchParams(window.location.search);
          const sharedId = urlParams.get('shared');
          
          if (sharedId) {
            this.isSharedView = true;
            this.sharedUserId = sharedId;
            await this.loadSharedCollection(sharedId);
          }
        },

        // NOVA FUNÇÃO: Carregar coleção compartilhada
        async loadSharedCollection(userId) {
          try {
            this.loading = true;
            
            // Verificar se a coleção é pública
            const userDoc = await db.collection('users').doc(userId).get();
            
            if (!userDoc.exists || !userDoc.data().isPublic) {
              this.showNotification('Esta coleção é privada ou não existe', 'error');
              this.isSharedView = false;
              this.loading = false;
              return;
            }

            // Carregar informações do usuário
            const userData = userDoc.data();
            this.sharedCollection.owner = {
              displayName: userData.displayName,
              email: userData.email
            };

            // Carregar registros da coleção
            const recordsSnapshot = await db.collection('users').doc(userId).collection('records').get();
            this.sharedCollection.records = recordsSnapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));

            this.filteredSharedCollection = [...this.sharedCollection.records];
            this.loading = false;
            
          } catch (error) {
            console.error('Erro ao carregar coleção compartilhada:', error);
            this.showNotification('Erro ao carregar coleção compartilhada', 'error');
            this.isSharedView = false;
            this.loading = false;
          }
        },

        // NOVA FUNÇÃO: Filtrar coleção compartilhada
        filterSharedCollection() {
          let filtered = this.sharedCollection.records;
          
          if (this.sharedSearchFilter.trim()) {
            const filter = this.sharedSearchFilter.toLowerCase();
            filtered = filtered.filter(record => 
              record.album?.toLowerCase().includes(filter) ||
              record.artist?.toLowerCase().includes(filter) ||
              record.format?.toLowerCase().includes(filter) ||
              record.year?.toString().includes(filter)
            );
          }
          
          this.filteredSharedCollection = filtered;
        },

        // NOVA FUNÇÃO: Ir para tela de login
        goToLogin() {
          window.location.href = window.location.origin + window.location.pathname;
        },

        // NOVA FUNÇÃO: Abrir detalhes do álbum
        openAlbumDetails(record) {
          this.albumDetailsModal = { show: true, record: record };
          setTimeout(() => lucide.createIcons(), 10);
        },

        // NOVA FUNÇÃO: Fechar detalhes do álbum
        closeAlbumDetails() {
          this.albumDetailsModal = { show: false, record: {} };
        },

        // NOVA FUNÇÃO: Buscar em serviços de música
        searchOnService(service) {
          const album = this.albumDetailsModal.record.album;
          const artist = this.albumDetailsModal.record.artist;
          const query = `${artist} ${album}`.trim();
          
          const urls = {
            youtube: `https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`,
            spotify: `https://open.spotify.com/search/${encodeURIComponent(query)}`,
            deezer: `https://www.deezer.com/search/${encodeURIComponent(query)}`,
            rateyourmusic: `https://rateyourmusic.com/search?searchterm=${encodeURIComponent(query)}`
          };
          
          window.open(urls[service] || urls.youtube, '_blank');
        },

        // NOVA FUNÇÃO: Calcular estatísticas
        calculateStats() {
          if (this.collection.length === 0) {
            this.stats = { duplicates: [], uniqueArtists: 0, averageYear: 0, oldestYear: 0 };
            return;
          }

          // Duplicatas
          const albumMap = {};
          this.collection.forEach(record => {
            const key = `${record.album}-${record.artist}`.toLowerCase();
            if (!albumMap[key]) {
              albumMap[key] = { ...record, count: 1 };
            } else {
              albumMap[key].count++;
            }
          });
          
          this.stats.duplicates = Object.values(albumMap)
            .filter(item => item.count > 1)
            .slice(0, 5);

          // Artistas únicos
          const artists = new Set(this.collection.map(r => r.artist?.toLowerCase()));
          this.stats.uniqueArtists = artists.size;

          // Anos
          const years = this.collection
            .map(r => parseInt(r.year))
            .filter(year => year && year > 1900 && year <= new Date().getFullYear());
          
          if (years.length > 0) {
            this.stats.averageYear = Math.round(years.reduce((a, b) => a + b, 0) / years.length);
            this.stats.oldestYear = Math.min(...years);
          } else {
            this.stats.averageYear = '-';
            this.stats.oldestYear = '-';
          }
        },

        // NOVA FUNÇÃO: Criar gráficos
        createCharts() {
          setTimeout(() => {
            this.createFormatChart();
            this.createDecadeChart();
          }, 100);
        },

        // NOVA FUNÇÃO: Gráfico de formatos
        createFormatChart() {
          const canvas = document.getElementById('formatChart');
          if (!canvas) return;

          const ctx = canvas.getContext('2d');
          
          // Contar formatos
          const formatCounts = {};
          this.collection.forEach(record => {
            const format = record.format || 'CD';
            formatCounts[format] = (formatCounts[format] || 0) + 1;
          });

          const colors = {
            'CD': '#3B82F6',
            'Vinil': '#8B5CF6', 
            'Cassete': '#F59E0B',
            'Digital': '#10B981'
          };

          new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: Object.keys(formatCounts),
              datasets: [{
                data: Object.values(formatCounts),
                backgroundColor: Object.keys(formatCounts).map(format => colors[format] || '#6B7280'),
                borderWidth: 0
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom',
                  labels: { color: this.darkMode ? '#E5E7EB' : '#374151' }
                }
              }
            }
          });
        },

        // NOVA FUNÇÃO: Gráfico por década
        createDecadeChart() {
          const canvas = document.getElementById('decadeChart');
          if (!canvas) return;

          const ctx = canvas.getContext('2d');
          
          // Contar por década
          const decadeCounts = {};
          this.collection.forEach(record => {
            if (record.year) {
              const decade = Math.floor(parseInt(record.year) / 10) * 10;
              const decadeLabel = `${decade}s`;
              decadeCounts[decadeLabel] = (decadeCounts[decadeLabel] || 0) + 1;
            }
          });

          const sortedDecades = Object.keys(decadeCounts).sort();

          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: sortedDecades,
              datasets: [{
                label: 'Quantidade',
                data: sortedDecades.map(decade => decadeCounts[decade]),
                backgroundColor: '#1DB954',
                borderRadius: 4
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { color: this.darkMode ? '#E5E7EB' : '#374151' },
                  grid: { color: this.darkMode ? '#374151' : '#E5E7EB' }
                },
                x: {
                  ticks: { color: this.darkMode ? '#E5E7EB' : '#374151' },
                  grid: { color: this.darkMode ? '#374151' : '#E5E7EB' }
                }
              }
            }
          });
        },

        // NOVA FUNÇÃO: Carregar configurações do usuário
        async loadUserSettings(userId) {
          try {
            const userDoc = await db.collection('users').doc(userId).get();
            if (userDoc.exists) {
              const userData = userDoc.data();
              this.collectionIsPublic = userData.isPublic || false;
              this.updateShareUrl();
            }
          } catch (error) {
            console.error('Erro ao carregar configurações:', error);
          }
        },

        // NOVA FUNÇÃO: Alternar privacidade da coleção
        async toggleCollectionPrivacy() {
          if (this.privacyUpdateLoading) return;
          
          this.privacyUpdateLoading = true;
          try {
            const newStatus = !this.collectionIsPublic;
            const userId = this.user.uid;
            
            await db.collection('users').doc(userId).set({
              isPublic: newStatus,
              displayName: this.user.displayName,
              email: this.user.email,
              updatedAt: new Date()
            }, { merge: true });

            this.collectionIsPublic = newStatus;
            this.updateShareUrl();
            
            this.showNotification(
              `Coleção agora é ${newStatus ? 'pública' : 'privada'}!`, 
              'success'
            );
            
          } catch (error) {
            console.error('Erro ao atualizar privacidade:', error);
            this.showNotification('Erro ao atualizar privacidade', 'error');
          }
          
          this.privacyUpdateLoading = false;
        },

        // NOVA FUNÇÃO: Atualizar URL de compartilhamento
        updateShareUrl() {
          if (this.collectionIsPublic && this.user) {
            const baseUrl = window.location.origin + window.location.pathname;
            this.shareUrl = `${baseUrl}?shared=${this.user.uid}`;
          } else {
            this.shareUrl = '';
          }
        },

        // NOVA FUNÇÃO: Copiar URL de compartilhamento
        async copyShareUrl() {
          try {
            await navigator.clipboard.writeText(this.shareUrl);
            this.showNotification('Link copiado para a área de transferência!', 'success');
          } catch (error) {
            console.error('Erro ao copiar URL:', error);
            this.showNotification('Erro ao copiar link', 'error');
          }
        },
        
        checkDevice() {
          this.isMobile = window.innerWidth < 769;
          if (!this.isMobile) {
            this.showMobileSidebar = false;
          }
        },

        async setupCollection(userId) {
          try {
            const collectionRef = db.collection('users').doc(userId).collection('records');
            collectionRef.onSnapshot((snapshot) => {
              this.collection = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              this.filterAndSortCollection();
              this.calculateStats(); // NOVA linha
              
              // Se estiver na view de stats, recriar gráficos
              if (this.currentView === 'stats') {
                this.createCharts();
              }
            });
          } catch (error) {
            console.error('Erro ao configurar coleção:', error);
            this.showNotification('Erro ao carregar coleção', 'error');
          }
        },

        // Observer para quando muda para view de stats
        $watch: {
          currentView(newValue) {
            if (newValue === 'stats') {
              setTimeout(() => this.createCharts(), 200);
            }
          }
        },<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Katalog</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  
  <style>
    body { font-family: 'Inter', sans-serif; }
    
    /* Tema Escuro (padrão) */
    .theme-dark {
      background-color: #121212;
      color: #E0E0E0;
    }
    .theme-dark .bg-card { background-color: #1E1E1E; }
    .theme-dark .bg-input { background-color: #2A2A2A; }
    .theme-dark .border-custom { border-color: #383838; }
    .theme-dark .text-muted { color: #888888; }
    
    /* Tema Claro */
    .theme-light {
      background-color: #f8fafc;
      color: #1f2937;
    }
    .theme-light .bg-card { background-color: #ffffff; }
    .theme-light .bg-input { background-color: #f1f5f9; }
    .theme-light .border-custom { border-color: #e2e8f0; }
    .theme-light .text-muted { color: #374151 !important; }
    .theme-light .bg-black { background-color: #1f2937 !important; color: #ffffff !important; }
    .theme-light .hover\:bg-gray-700:hover { background-color: #e5e7eb !important; }
    .theme-light .text-white { color: #1f2937 !important; }
    .theme-light aside.bg-black { background-color: #f8fafc !important; border-right: 1px solid #e2e8f0; }
    .theme-light aside .text-white { color: #1f2937 !important; }
    .theme-light aside .text-gray-400 { color: #64748b !important; }
    .theme-light aside .border-custom { border-color: #e2e8f0 !important; }
    .theme-light aside .hover\:bg-gray-700:hover { background-color: #e5e7eb !important; }
    
    .theme-light h1, .theme-light h2, .theme-light h3, .theme-light h4 { color: #1f2937 !important; }
    .theme-light table th { color: #1f2937 !important; }
    .theme-light table td { color: #1f2937 !important; }
    .theme-light .font-bold { color: #1f2937 !important; }
    .theme-light .font-semibold { color: #1f2937 !important; }
    .theme-light p, .theme-light span, .theme-light div { color: #1f2937 !important; }

    /* Estilos para ordenação */
    .sort-button { @apply px-2 py-1 text-xs rounded border; }
    .sort-active { @apply bg-green-500 text-white; }
    .sort-inactive { @apply bg-gray-200 text-gray-700 hover:bg-gray-300; }
    .theme-dark .sort-inactive { @apply bg-gray-600 text-gray-300 hover:bg-gray-500; }
    
    .btn-primary { background-color: #1DB954; color: #FFFFFF; }
    .btn-primary:hover { background-color: #1ED760; }
    .btn-secondary { background-color: #4A4A4A; color: #FFFFFF; }
    .btn-secondary:hover { background-color: #5A5A5A; }
    .btn-primary:disabled, button:disabled { background-color: #555; color: #aaa; cursor: not-allowed; }
    .placeholder-custom::placeholder { color: #888888; }
    [x-cloak] { display: none !important; }
    
    .format-badge { @apply px-2 py-1 text-xs font-semibold rounded-full; }
    .format-cd { @apply bg-blue-500 text-white; }
    .format-vinil { @apply bg-purple-500 text-white; }
    .format-cassete { @apply bg-orange-500 text-white; }
    .format-digital { @apply bg-green-500 text-white; }

    /* Estilos para visualização compartilhada */
    .shared-header {
      background: linear-gradient(135deg, #1DB954, #1ed760);
      color: white;
      padding: 2rem;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .shared-collection-info {
      background: rgba(29, 185, 84, 0.1);
      border: 1px solid rgba(29, 185, 84, 0.3);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    /* Modal de exclusão de conta e outros modais */
    .delete-account-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }
    
    .delete-account-form {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 0.5rem;
      max-width: 28rem;
      width: 100%;
      margin: 1rem;
    }
    
    .theme-dark .delete-account-form { background-color: #1E1E1E; }
    .theme-light .delete-account-form { background-color: #ffffff; }

    /* Mobile responsivo */
    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--nav-bg);
      border-top: 1px solid var(--border-color);
      z-index: 40;
    }
    
    .theme-dark .mobile-bottom-nav {
      background-color: #1E1E1E;
      border-color: #383838;
    }
    
    .theme-light .mobile-bottom-nav {
      background-color: #ffffff;
      border-color: #e2e8f0;
    }

    .mobile-sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 45;
    }

    .mobile-sidebar {
      position: fixed;
      top: 0;
      left: -100%;
      width: 80%;
      max-width: 300px;
      height: 100%;
      transition: left 0.3s ease;
      z-index: 50;
    }

    .mobile-sidebar.open { left: 0; }

    @media (max-width: 768px) {
      .desktop-sidebar { display: none; }
      .main-content { padding-bottom: 80px; }
      .mobile-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
      }
      .theme-dark .mobile-header { border-color: #383838; }
      .theme-light .mobile-header { border-color: #e2e8f0; }
    }

    @media (min-width: 769px) {
      .mobile-only { display: none !important; }
      .mobile-bottom-nav { display: none; }
    }

    .fab {
      position: fixed;
      bottom: 100px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 30;
    }

    @media (min-width: 769px) { .fab { display: none; } }
    @media (max-width: 768px) {
      .modal-content {
        margin: 1rem;
        max-height: calc(100vh - 2rem);
        overflow-y: auto;
      }
    }

    /* Novos estilos para modal de detalhes */
    .album-details-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }

    .album-details-content {
      background: var(--card-bg);
      border-radius: 0.75rem;
      max-width: 28rem;
      width: 100%;
      margin: 1rem;
      overflow: hidden;
    }

    .theme-dark .album-details-content { background-color: #1E1E1E; }
    .theme-light .album-details-content { background-color: #ffffff; }

    .service-button {
      transition: transform 0.2s ease;
    }

    .service-button:hover {
      transform: scale(1.1);
    }
  </style>
</head>
<body x-data="app" x-init="init()" x-cloak :class="`theme-${darkMode ? 'dark' : 'light'}`">

  <!-- Loading -->
  <div x-show="loading" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="flex flex-col items-center text-center p-4">
      <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
      <p class="text-white mt-4 text-lg">Carregando...</p>
    </div>
  </div>

  <!-- Notificação -->
  <div x-show="notification.show"
       class="fixed top-5 right-5 z-50 p-4 rounded-md shadow-lg text-white max-w-sm"
       :class="{'bg-green-600': notification.type === 'success', 'bg-red-600': notification.type === 'error', 'bg-blue-600': notification.type === 'info'}"
       x-transition>
    <p x-text="notification.message"></p>
  </div>

  <!-- NOVA SEÇÃO: Visualização de Coleção Compartilhada -->
  <div x-show="isSharedView && !loading">
    <div class="shared-header">
      <div class="flex items-center justify-center space-x-3 mb-4">
        <i data-lucide="disc-3" class="text-4xl"></i>
        <h1 class="text-3xl font-bold">Katalog</h1>
      </div>
      <div x-show="sharedCollection.owner">
        <h2 class="text-xl mb-2">Coleção de <span x-text="sharedCollection.owner?.displayName || sharedCollection.owner?.email || 'Usuário'"></span></h2>
        <p class="opacity-90">
          <span x-text="sharedCollection.records?.length || 0"></span> itens na coleção
        </p>
      </div>
    </div>

    <div class="container mx-auto px-4 pb-8">
      <!-- Informações sobre a visualização -->
      <div class="shared-collection-info mb-6">
        <div class="flex items-center space-x-2 text-green-700">
          <i data-lucide="eye" class="w-4 h-4"></i>
          <span class="text-sm font-medium">Você está visualizando uma coleção compartilhada</span>
        </div>
      </div>

      <!-- Botão para criar sua própria conta -->
      <div class="text-center mb-8">
        <p class="text-muted mb-4">Gostou desta coleção? Crie sua própria conta no Katalog!</p>
        <button @click="goToLogin()" class="px-6 py-3 btn-primary rounded-lg font-medium">
          Criar Minha Conta
        </button>
      </div>

      <!-- Busca (somente leitura) -->
      <div class="mb-6">
        <input x-model="sharedSearchFilter" @input="filterSharedCollection()" 
               placeholder="Buscar nesta coleção..." 
               class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
      </div>

      <!-- Controles de visualização -->
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-2xl font-bold">
          Itens (<span x-text="filteredSharedCollection.length"></span>)
        </h3>
        <div class="flex space-x-2">
          <button @click="sharedViewMode = 'grid'" 
                  :class="sharedViewMode === 'grid' ? 'btn-primary' : 'btn-secondary'"
                  class="px-4 py-2 rounded-md">
            <i data-lucide="grid-3x3" class="w-4 h-4"></i>
          </button>
          <button @click="sharedViewMode = 'list'" 
                  :class="sharedViewMode === 'list' ? 'btn-primary' : 'btn-secondary'"
                  class="px-4 py-2 rounded-md">
            <i data-lucide="list" class="w-4 h-4"></i>
          </button>
        </div>
      </div>

      <!-- Grid View Compartilhada -->
      <div x-show="sharedViewMode === 'grid' && filteredSharedCollection.length > 0" 
           class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-6">
        <template x-for="record in filteredSharedCollection" :key="record.id">
          <div class="bg-card rounded-lg overflow-hidden shadow-lg cursor-pointer"
               @click="openAlbumDetails(record)">
            <img :src="record.cover_url || `https://placehold.co/300x300/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`" 
                 class="w-full aspect-square object-cover">
            <div class="absolute top-2 left-2">
              <span :class="'format-' + (record.format?.toLowerCase() || 'cd')" 
                    class="format-badge text-xs" x-text="record.format || 'CD'"></span>
            </div>
            <div class="p-2 md:p-3">
              <h3 class="font-bold text-sm md:text-base truncate" x-text="record.album"></h3>
              <p class="text-xs md:text-sm text-muted truncate" x-text="record.artist"></p>
              <p x-show="record.year" class="text-xs text-muted" x-text="record.year"></p>
            </div>
          </div>
        </template>
      </div>

      <!-- List View Compartilhada -->
      <div x-show="sharedViewMode === 'list' && filteredSharedCollection.length > 0" 
           class="bg-card rounded-lg overflow-hidden shadow-lg">
        <!-- Mobile List View -->
        <div class="md:hidden">
          <template x-for="record in filteredSharedCollection" :key="record.id">
            <div class="border-b border-custom p-4 flex items-center space-x-3 cursor-pointer"
                 @click="openAlbumDetails(record)">
              <img :src="record.cover_url || `https://placehold.co/60x60/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`" 
                   class="w-12 h-12 object-cover rounded">
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-sm truncate" x-text="record.album"></h3>
                <p class="text-xs text-muted truncate" x-text="record.artist"></p>
                <div class="flex items-center space-x-2 mt-1">
                  <span :class="'format-' + (record.format?.toLowerCase() || 'cd')" 
                        class="format-badge text-xs" x-text="record.format || 'CD'"></span>
                  <span x-show="record.year" class="text-xs text-muted" x-text="record.year"></span>
                </div>
              </div>
            </div>
          </template>
        </div>
        
        <!-- Desktop Table View -->
        <table class="w-full hidden md:table">
          <thead class="bg-input">
            <tr>
              <th class="text-left p-4 font-semibold">Capa</th>
              <th class="text-left p-4 font-semibold">Álbum</th>
              <th class="text-left p-4 font-semibold">Artista</th>
              <th class="text-left p-4 font-semibold">Formato</th>
              <th class="text-left p-4 font-semibold">Ano</th>
            </tr>
          </thead>
          <tbody>
            <template x-for="record in filteredSharedCollection" :key="record.id">
              <tr class="border-b border-custom hover:bg-input cursor-pointer"
                  @click="openAlbumDetails(record)">
                <td class="p-4">
                  <img :src="record.cover_url || `https://placehold.co/60x60/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`" 
                       class="w-12 h-12 object-cover rounded">
                </td>
                <td class="p-4 font-semibold" x-text="record.album"></td>
                <td class="p-4" x-text="record.artist"></td>
                <td class="p-4">
                  <span :class="'format-' + (record.format?.toLowerCase() || 'cd')" 
                        class="format-badge" x-text="record.format || 'CD'"></span>
                </td>
                <td class="p-4" x-text="record.year || '-'"></td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <!-- Empty State -->
      <div x-show="filteredSharedCollection.length === 0" class="text-center py-20 bg-card rounded-lg">
        <i data-lucide="folder-x" class="mx-auto h-16 w-16 text-muted mb-4"></i>
        <h3 class="text-xl font-semibold" x-text="sharedSearchFilter ? 'Nenhum item encontrado' : 'Coleção vazia'"></h3>
        <p class="text-muted mt-2" x-text="sharedSearchFilter ? 'Tente uma busca diferente' : 'Esta coleção ainda não possui itens'"></p>
      </div>
    </div>
  </div>

  <!-- Modal de Detalhes do Álbum -->
  <div x-show="albumDetailsModal.show" class="album-details-modal" @click.self="closeAlbumDetails()">
    <div class="album-details-content">
      <!-- Header com capa -->
      <div class="relative h-48 bg-gradient-to-br from-green-600 to-green-800">
        <img x-show="albumDetailsModal.record.cover_url" 
             :src="albumDetailsModal.record.cover_url" 
             class="absolute inset-0 w-full h-full object-cover opacity-20">
        <div class="absolute inset-0 flex items-center justify-center">
          <img :src="albumDetailsModal.record.cover_url || `https://placehold.co/120x120/1E1E1E/E0E0E0?text=${albumDetailsModal.record.album?.charAt(0) || 'A'}`" 
               class="w-24 h-24 rounded-lg shadow-xl border-2 border-white">
        </div>
        <button @click="closeAlbumDetails()" 
                class="absolute top-4 right-4 bg-black bg-opacity-50 text-white rounded-full p-2 hover:bg-opacity-70">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <!-- Informações -->
      <div class="p-6">
        <div class="text-center mb-6">
          <h2 class="text-xl font-bold mb-2" x-text="albumDetailsModal.record.album"></h2>
          <p class="text-muted" x-text="albumDetailsModal.record.artist"></p>
          <div class="flex justify-center items-center space-x-4 mt-4">
            <span :class="'format-' + (albumDetailsModal.record.format?.toLowerCase() || 'cd')" 
                  class="format-badge" x-text="albumDetailsModal.record.format || 'CD'"></span>
            <span x-show="albumDetailsModal.record.year" class="text-sm text-muted">
              [<span x-text="albumDetailsModal.record.year"></span>]
            </span>
          </div>
        </div>

        <!-- Informações detalhadas -->
        <div class="space-y-3 mb-6">
          <div x-show="albumDetailsModal.record.catalog_number" class="text-sm">
            <span class="font-medium">Número de Série:</span>
            <span x-text="albumDetailsModal.record.catalog_number"></span>
          </div>
          <div x-show="albumDetailsModal.record.description" class="text-sm">
            <span class="font-medium">Descrição:</span>
            <p class="mt-1 text-muted" x-text="albumDetailsModal.record.description"></p>
          </div>
        </div>

        <!-- Serviços de música -->
        <div class="border-t border-custom pt-4">
          <p class="text-sm font-medium mb-3 text-center">Buscar em:</p>
          <div class="grid grid-cols-2 gap-3">
            <button @click="searchOnService('youtube')" 
                    class="service-button flex items-center justify-center space-x-2 p-3 bg-red-600 hover:bg-red-700 text-white rounded-lg">
              <i data-lucide="play" class="w-4 h-4"></i>
              <span>YouTube</span>
            </button>
            <button @click="searchOnService('spotify')" 
                    class="service-button flex items-center justify-center space-x-2 p-3 bg-green-600 hover:bg-green-700 text-white rounded-lg">
              <i data-lucide="music" class="w-4 h-4"></i>
              <span>Spotify</span>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-3 mt-3">
            <button @click="searchOnService('deezer')" 
                    class="service-button flex items-center justify-center space-x-2 p-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">
              <i data-lucide="headphones" class="w-4 h-4"></i>
              <span>Deezer</span>
            </button>
            <button @click="searchOnService('rateyourmusic')" 
                    class="service-button flex items-center justify-center space-x-2 p-3 bg-orange-600 hover:bg-orange-700 text-white rounded-lg">
              <i data-lucide="star" class="w-4 h-4"></i>
              <span>RateYourMusic</span>
            </button>
          </div>
        </div>

        <!-- Botões de ação para usuários logados -->
        <div x-show="user && !isSharedView" class="border-t border-custom pt-4 mt-4 flex space-x-3">
          <button @click="editRecord(albumDetailsModal.record); closeAlbumDetails()" 
                  class="flex-1 flex items-center justify-center space-x-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
            <i data-lucide="edit" class="w-4 h-4"></i>
            <span>Editar</span>
          </button>
          <button @click="confirmDeleteRecord(albumDetailsModal.record.id); closeAlbumDetails()" 
                  class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Sidebar Overlay (apenas para usuários logados) -->
  <div x-show="showMobileSidebar && isMobile && !isSharedView" class="mobile-sidebar-overlay mobile-only" @click="showMobileSidebar = false"></div>

  <!-- Mobile Sidebar (apenas para usuários logados) -->
  <aside x-show="showMobileSidebar && isMobile && !isSharedView" class="mobile-sidebar bg-black mobile-only" :class="{'open': showMobileSidebar}">
    <div class="p-4 flex items-center justify-between border-b border-custom">
      <div class="flex items-center space-x-2">
        <i data-lucide="disc-3" class="text-green-400"></i>
        <h1 class="text-xl font-bold text-white">Katalog</h1>
      </div>
      <button @click="showMobileSidebar = false" class="text-white">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
    </div>
    <nav class="flex-1 p-4 space-y-2">
      <a href="#" @click.prevent="currentView = 'collection'; showMobileSidebar = false" 
         :class="{'bg-green-500 text-white': currentView === 'collection'}"
         class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-white">
         <i data-lucide="album"></i><span>Minha Coleção</span>
      </a>
      <a href="#" @click.prevent="currentView = 'add-record'; showMobileSidebar = false" 
         :class="{'bg-green-500 text-white': currentView === 'add-record'}"
         class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-white">
         <i data-lucide="plus-circle"></i><span>Adicionar Item</span>
      </a>
      <button @click="currentView = 'stats'; showMobileSidebar = false" 
              :class="{'bg-green-500 text-white': currentView === 'stats'}"
              class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-yellow-300">
        <i data-lucide="bar-chart-3"></i><span>Gráficos</span>
      </button>
      <button @click="importModal.show = true; showMobileSidebar = false" 
              class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-blue-300">
        <i data-lucide="upload"></i><span>Importar Excel</span>
      </button>
    </nav>
    <div class="p-4 border-t border-custom space-y-2">
      <div class="px-3 py-2 text-xs text-gray-400 break-words">
        <span x-text="user?.email"></span>
      </div>
      <button @click="configModal = true; showMobileSidebar = false" 
              class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-white">
        <i data-lucide="settings"></i><span>Configurações</span>
      </button>
      <button @click="confirmLogout()" 
              class="w-full flex items-center space-x-3 px-3 py-

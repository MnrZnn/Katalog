<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Do Vinil ao Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- AlpineJS v3 -->
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #121212; color: #E0E0E0; }
    .bg-card { background-color: #1E1E1E; }
    .bg-input { background-color: #2A2A2A; }
    .border-custom { border-color: #383838; }
    .btn-primary { background-color: #1DB954; color: #FFFFFF; }
    .btn-primary:hover { background-color: #1ED760; }
    .btn-danger { background-color: #dc2626; color: #FFFFFF; }
    .btn-danger:hover { background-color: #b91c1c; }
    .btn-secondary { background-color: #4A4A4A; color: #FFFFFF; }
    .btn-secondary:hover { background-color: #5A5A5A; }
    .btn-primary:disabled, button:disabled { background-color: #555; color: #aaa; cursor: not-allowed; }
    .placeholder-custom::placeholder { color: #888888; }
    [x-cloak] { display: none !important; }
  </style>
</head>
<body x-data="app" x-init="init()" x-cloak>

  <!-- Loading Spinner -->
  <div x-show="isInitializing" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="flex flex-col items-center text-center p-4">
      <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
      <p class="text-white mt-4 text-lg">Conectando...</p>
    </div>
  </div>

  <!-- Notificação -->
  <div x-show="notification.show"
       class="fixed top-5 right-5 z-50 p-4 rounded-md shadow-lg text-white max-w-sm"
       :class="{'bg-green-600': notification.type === 'success', 'bg-red-600': notification.type === 'error'}"
       x-transition:enter="transition ease-out duration-300"
       x-transition:enter-start="opacity-0 translate-x-full"
       x-transition:enter-end="opacity-100 translate-x-0"
       x-transition:leave="transition ease-in duration-300"
       x-transition:leave-start="opacity-100 translate-x-0"
       x-transition:leave-end="opacity-0 translate-x-full">
    <p x-text="notification.message"></p>
  </div>

  <!-- Modal de Exclusão -->
  <div x-show="deleteModal.show" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40" @keydown.escape.window="cancelDelete()">
    <div class="bg-card rounded-lg p-8 max-w-sm w-full mx-4 shadow-xl" @click.outside="cancelDelete()">
      <h3 class="text-xl font-bold text-white mb-4">Confirmar Exclusão</h3>
      <p class="text-gray-300 mb-6">Você tem certeza que deseja excluir este disco?</p>
      <div class="flex justify-end space-x-4">
        <button @click="cancelDelete()" class="px-4 py-2 rounded-md font-semibold btn-secondary">Cancelar</button>
        <button @click="confirmDelete()" class="px-4 py-2 rounded-md font-semibold btn-danger">Excluir</button>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="app-dashboard" x-show="!isInitializing" class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-black flex-shrink-0 flex flex-col">
      <div class="p-4 flex items-center space-x-2 border-b border-custom">
        <i data-lucide="disc-3" class="text-green-400"></i>
        <h1 class="text-xl font-bold text-white">Do Vinil ao Digital</h1>
      </div>
      <nav class="flex-1 p-4 space-y-2">
        <a href="#" @click.prevent="appView = 'collection'" :class="{'bg-green-500 text-white': appView === 'collection'}" class="flex items-center space-x-3 px-3 py-2 rounded-md transition-colors hover:bg-gray-700"><i data-lucide="album"></i><span>Minha Coleção</span></a>
        <a href="#" @click.prevent="appView = 'add-record'" :class="{'bg-green-500 text-white': appView === 'add-record'}" class="flex items-center space-x-3 px-3 py-2 rounded-md transition-colors hover:bg-gray-700"><i data-lucide="plus-circle"></i><span>Adicionar Disco</span></a>
      </nav>
      <div class="p-4 border-t border-custom space-y-2">
        <div class="px-3 py-2 text-xs text-gray-400 break-words">
          <span class="font-semibold text-gray-300">ID de Usuário:</span>
          <span x-text="currentUser.id"></span>
        </div>
        <a href="#" @click.prevent="logout()" class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-red-800 bg-red-600/50 text-white transition-colors"><i data-lucide="log-out"></i><span>Sair</span></a>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-8 overflow-y-auto">
      <!-- Coleção -->
      <div x-show="appView === 'collection'">
        <h2 class="text-3xl font-bold mb-6">Minha Coleção (<span x-text="collection.length"></span>)</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" x-show="collection.length > 0">
          <template x-for="record in collection" :key="record.id">
            <div class="bg-card rounded-lg overflow-hidden shadow-lg group relative">
              <img :src="record.cover_url || `https://placehold.co/300x300/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`" class="w-full aspect-square object-cover">
              <div class="absolute top-2 right-2">
                <button @click="openDeleteModal(record.id)" class="bg-red-600 text-white rounded-full p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </div>
              <div class="p-3">
                <h3 class="font-bold text-white truncate" x-text="record.album"></h3>
                <p class="text-sm text-gray-400 truncate" x-text="record.artist"></p>
              </div>
            </div>
          </template>
        </div>
        <div x-show="collection.length === 0 && !loading" class="text-center py-20 bg-card rounded-lg">
          <i data-lucide="folder-x" class="mx-auto h-16 w-16 text-gray-500 mb-4"></i>
          <h3 class="text-xl font-semibold">Sua coleção está vazia</h3>
          <p class="text-gray-400 mt-2">Comece adicionando seu primeiro disco!</p>
          <button @click="appView = 'add-record'" class="mt-6 px-6 py-2 rounded-full btn-primary">Adicionar Disco</button>
        </div>
      </div>

      <!-- Formulário -->
      <div x-show="appView === 'add-record'">
        <h2 class="text-3xl font-bold mb-6">Adicionar Novo Disco</h2>
        <form @submit.prevent="addRecord" class="max-w-xl mx-auto bg-card p-8 rounded-lg space-y-4">
          <div><label class="block text-sm font-medium">Álbum</label><input x-model="newRecord.album" required class="w-full mt-1 p-3 bg-input border border-custom rounded-md placeholder-custom"></div>
          <div><label class="block text-sm font-medium">Artista</label><input x-model="newRecord.artist" required class="w-full mt-1 p-3 bg-input border border-custom rounded-md placeholder-custom"></div>
          <div><label class="block text-sm font-medium">Ano</label><input x-model="newRecord.year" type="number" class="w-full mt-1 p-3 bg-input border border-custom rounded-md placeholder-custom"></div>
          <div><label class="block text-sm font-medium">URL da Capa</label><input x-model="newRecord.cover_url" class="w-full mt-1 p-3 bg-input border border-custom rounded-md placeholder-custom"></div>
          <button type="submit" :disabled="loading" class="w-full py-3 font-semibold rounded-md btn-primary flex items-center justify-center">
            <span x-show="!loading">Salvar Disco</span>
            <span x-show="loading" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
          </button>
        </form>
      </div>
    </main>
  </div>

  <!-- Alpine + Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, onSnapshot, query, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    document.addEventListener('alpine:init', () => {
      Alpine.data('app', () => ({
        isInitializing: true,
        loading: false,
        appView: 'collection',
        collection: [],
        newRecord: { album: '', artist: '', year: '', cover_url: '' },
        currentUser: { id: null },
        notification: { show: false, message: '', type: 'success' },
        deleteModal: { show: false, recordId: null },
        appId: 'default-app-id',
        auth: null,
        db: null,
        collectionListener: null,

        async init() {
          this.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
          if (typeof __firebase_config === 'undefined') {
            this.showNotification("Configuração Firebase ausente.", "error");
            this.isInitializing = false; return;
          }
          try {
            const firebaseConfig = JSON.parse(__firebase_config);
            const firebaseApp = initializeApp(firebaseConfig);
            this.auth = getAuth(firebaseApp);
            this.db = getFirestore(firebaseApp);
            setLogLevel('debug');
            this.setupAuthListener();
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
              await signInWithCustomToken(this.auth, __initial_auth_token);
            } else {
              await signInAnonymously(this.auth);
            }
          } catch (e) {
            this.showNotification("Erro ao conectar Firebase", "error");
            this.isInitializing = false;
          }
          this.$nextTick(() => lucide.createIcons());
        },

        setupAuthListener() {
          onAuthStateChanged(this.auth, (user) => {
            if (user) {
              this.currentUser.id = user.uid;
              this.fetchCollection(user.uid);
            } else {
              this.currentUser.id = null;
              this.collection = [];
              if (this.collectionListener) this.collectionListener();
            }
            this.isInitializing = false;
          });
        },

        fetchCollection(userId) {
          if (!userId) return;
          if (this.collectionListener) this.collectionListener();
          const recordsPath = `artifacts/${this.appId}/users/${userId}/records`;
          const q = query(collection(this.db, recordsPath));
          this.collectionListener = onSnapshot(q, (qs) => {
            this.collection = qs.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          }, () => this.showNotification("Erro ao carregar coleção.", "error"));
        },

        async addRecord() {
          if (!this.newRecord.album || !this.newRecord.artist) {
            this.showNotification("Álbum e Artista são obrigatórios.", "error"); return;
          }
          this.loading = true;
          try {
            const userId = this.currentUser.id;
            if (!userId) throw new Error("Não autenticado");
            const recordsPath = `artifacts/${this.appId}/users/${userId}/records`;
            await addDoc(collection(this.db, recordsPath), {
              album: this.newRecord.album,
              artist: this.newRecord.artist,
              year: Number(this.newRecord.year) || null,
              cover_url: this.newRecord.cover_url,
              createdAt: serverTimestamp()
            });
            this.showNotification("Disco adicionado!", "success");
            this.newRecord = { album: '', artist: '', year: '', cover_url: '' };
            this.appView = 'collection';
          } catch {
            this.showNotification("Erro ao salvar disco.", "error");
          } finally {
            this.loading = false;
          }
        },

        async confirmDelete() {
          const id = this.deleteModal.recordId;
          if (!id) return;
          this.loading = true;
          this.deleteModal.show = false;
          try {
            const userId = this.currentUser.id;
            if (!userId) throw new Error("Não autenticado");
            const docPath = `artifacts/${this.appId}/users/${userId}/records/${id}`;
            await deleteDoc(doc(this.db, docPath));
            this.showNotification("Disco excluído!", "success");
          } catch {
            this.showNotification("Erro ao excluir.", "error");
          } finally {
            this.loading = false;
            this.deleteModal.recordId = null;
          }
        },

        async logout() { await signOut(this.auth); this.showNotification("Você saiu.", "success"); },
        openDeleteModal(id) { this.deleteModal.recordId = id; this.deleteModal.show = true; },
        cancelDelete() { this.deleteModal.show = false; this.deleteModal.recordId = null; },
        showNotification(msg, type = 'success') {
          this.notification = { message: msg, type, show: true };
          setTimeout(() => this.notification.show = false, 3000);
        }
      }))
    })
  </script>
</body>
</html>

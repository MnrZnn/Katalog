<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Katalog</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  
  <!-- Firebase SDKs - Vers√£o Compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <!-- SheetJS para Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #121212; color: #E0E0E0; }
    .bg-card { background-color: #1E1E1E; }
    .bg-input { background-color: #2A2A2A; }
    .border-custom { border-color: #383838; }
    .btn-primary { background-color: #1DB954; color: #FFFFFF; }
    .btn-primary:hover { background-color: #1ED760; }
    .btn-danger { background-color: #dc2626; color: #FFFFFF; }
    .btn-danger:hover { background-color: #b91c1c; }
    .btn-secondary { background-color: #4A4A4A; color: #FFFFFF; }
    .btn-secondary:hover { background-color: #5A5A5A; }
    .btn-primary:disabled, button:disabled { background-color: #555; color: #aaa; cursor: not-allowed; }
    .placeholder-custom::placeholder { color: #888888; }
    [x-cloak] { display: none !important; }
    .format-badge {
      @apply px-2 py-1 text-xs font-semibold rounded-full;
    }
    .format-cd { @apply bg-blue-500 text-white; }
    .format-vinil { @apply bg-purple-500 text-white; }
    .format-cassete { @apply bg-orange-500 text-white; }
    .format-digital { @apply bg-green-500 text-white; }
    .footer-info { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      z-index: 40;
      background: rgba(30, 30, 30, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid #383838;
    }
  </style>
</head>
<body x-data="app" x-init="init()" x-cloak>

  <!-- Loading -->
  <div x-show="isLoading" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="flex flex-col items-center text-center p-4">
      <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
      <p class="text-white mt-4 text-lg" x-text="loadingMessage"></p>
    </div>
  </div>

  <!-- Notifica√ß√£o -->
  <div x-show="notification.show"
       class="fixed top-5 right-5 z-50 p-4 rounded-md shadow-lg text-white max-w-sm"
       :class="{'bg-green-600': notification.type === 'success', 'bg-red-600': notification.type === 'error', 'bg-blue-600': notification.type === 'info'}"
       x-transition>
    <p x-text="notification.message"></p>
  </div>

  <!-- Modal Compartilhar -->
  <div x-show="shareModal.show" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="shareModal.show = false">
    <div class="bg-card p-8 rounded-lg max-w-md w-full mx-4">
      <h3 class="text-xl font-bold mb-4">üéµ Compartilhar Minha Cole√ß√£o</h3>
      <p class="text-gray-400 mb-4">Copie este link para compartilhar sua cole√ß√£o:</p>
      <div class="flex space-x-2">
        <input :value="shareModal.url" readonly 
               class="flex-1 p-3 bg-input border border-custom rounded-md text-sm">
        <button @click="copyShareLink()" class="px-4 py-3 btn-primary rounded-md">
          <i data-lucide="copy" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="flex justify-end mt-4">
        <button @click="shareModal.show = false" class="px-4 py-2 btn-secondary rounded-md">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal Editar -->
  <div x-show="editModal.show" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="editModal.show = false">
    <div class="bg-card p-8 rounded-lg max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
      <h3 class="text-xl font-bold mb-4">‚úèÔ∏è Editar Item</h3>
      <form @submit.prevent="updateRecord()" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">√Ålbum/T√≠tulo *</label>
            <input x-model="editModal.record.album" required 
                   class="w-full p-3 bg-input border border-custom rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Artista *</label>
            <input x-model="editModal.record.artist" required 
                   class="w-full p-3 bg-input border border-custom rounded-md">
          </div>
        </div>
        
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Formato *</label>
            <select x-model="editModal.record.format" required
                    class="w-full p-3 bg-input border border-custom rounded-md">
              <option value="CD">üìÄ CD</option>
              <option value="Vinil">üéµ Vinil</option>
              <option value="Cassete">üìº Cassete</option>
              <option value="Digital">üíª Digital</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Ano</label>
            <input x-model="editModal.record.year" type="number" min="1900" max="2030"
                   class="w-full p-3 bg-input border border-custom rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">N√∫mero de Cat√°logo</label>
            <input x-model="editModal.record.catalog_number" 
                   class="w-full p-3 bg-input border border-custom rounded-md">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Descri√ß√£o da Edi√ß√£o</label>
          <textarea x-model="editModal.record.edition_notes" 
                    class="w-full p-3 bg-input border border-custom rounded-md resize-none"
                    rows="3"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">URL da Capa</label>
          <input x-model="editModal.record.cover_url" 
                 class="w-full p-3 bg-input border border-custom rounded-md">
          <div x-show="editModal.record.cover_url" class="mt-2">
            <img :src="editModal.record.cover_url" class="w-20 h-20 object-cover rounded-md" 
                 @error="editModal.record.cover_url = ''" alt="Preview">
          </div>
        </div>
        
        <div class="flex space-x-4">
          <button type="submit" :disabled="editModal.loading" 
                  class="flex-1 py-3 btn-primary rounded-md">
            <span x-show="!editModal.loading">üíæ Salvar Altera√ß√µes</span>
            <span x-show="editModal.loading">Salvando...</span>
          </button>
          <button type="button" @click="editModal.show = false" 
                  class="px-6 py-3 btn-secondary rounded-md">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Import Excel -->
  <div x-show="importModal.show" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="importModal.show = false">
    <div class="bg-card p-8 rounded-lg max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
      <h3 class="text-xl font-bold mb-4">üìä Importar do Excel</h3>
      
      <div class="space-y-4">
        <!-- Instru√ß√µes -->
        <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
          <h4 class="font-semibold text-blue-300 mb-2">üìã Como preparar seu arquivo Excel:</h4>
          <ul class="text-sm text-blue-200 space-y-1">
            <li>‚Ä¢ <strong>album</strong> - Nome do √°lbum (obrigat√≥rio)</li>
            <li>‚Ä¢ <strong>artist</strong> - Nome do artista (obrigat√≥rio)</li>
            <li>‚Ä¢ <strong>format</strong> - CD, Vinil, Cassete ou Digital (obrigat√≥rio)</li>
            <li>‚Ä¢ <strong>year</strong> - Ano de lan√ßamento (opcional)</li>
            <li>‚Ä¢ <strong>catalog_number</strong> - N√∫mero de cat√°logo (opcional)</li>
            <li>‚Ä¢ <strong>edition_notes</strong> - Observa√ß√µes da edi√ß√£o (opcional)</li>
            <li>‚Ä¢ <strong>cover_url</strong> - URL da capa (opcional)</li>
          </ul>
        </div>
        
        <!-- Upload -->
        <div>
          <label class="block text-sm font-medium mb-2">Escolha o arquivo Excel:</label>
          <input type="file" @change="handleFileUpload($event)" 
                 accept=".xlsx,.xls,.csv" 
                 class="w-full p-3 bg-input border border-custom rounded-md">
        </div>
        
        <!-- Preview -->
        <div x-show="importModal.preview.length > 0">
          <h4 class="font-semibold mb-2">Preview (primeiros 3 itens):</h4>
          <div class="bg-input rounded-lg p-4 max-h-40 overflow-y-auto">
            <template x-for="item in importModal.preview.slice(0, 3)" :key="item.album">
              <div class="text-sm py-1 border-b border-gray-600 last:border-b-0">
                <strong x-text="item.album"></strong> - <span x-text="item.artist"></span>
                (<span x-text="item.format"></span>)
              </div>
            </template>
          </div>
          <p class="text-sm text-gray-400 mt-2" x-text="`Total: ${importModal.data.length} itens encontrados`"></p>
        </div>
        
        <div class="flex space-x-4">
          <button @click="importRecords()" :disabled="importModal.data.length === 0 || importModal.loading" 
                  class="flex-1 py-3 btn-primary rounded-md">
            <span x-show="!importModal.loading">üì• Importar Cole√ß√£o</span>
            <span x-show="importModal.loading">Importando...</span>
          </button>
          <button @click="closeImportModal()" class="px-6 py-3 btn-secondary rounded-md">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Confirmar Exclus√£o de Conta -->
  <div x-show="deleteAccountModal.show" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50" @click.self="deleteAccountModal.show = false">
    <div class="bg-red-900 border border-red-600 p-8 rounded-lg max-w-md w-full mx-4">
      <h3 class="text-xl font-bold mb-4 text-red-100">‚ö†Ô∏è Excluir Conta</h3>
      <div class="space-y-4 text-red-200">
        <p><strong>ATEN√á√ÉO:</strong> Esta a√ß√£o n√£o pode ser desfeita!</p>
        <p>Todos os seus dados ser√£o permanentemente exclu√≠dos:</p>
        <ul class="list-disc list-inside text-sm space-y-1 text-red-300">
          <li>Toda sua cole√ß√£o musical</li>
          <li>Sua conta de usu√°rio</li>
          <li>Configura√ß√µes e prefer√™ncias</li>
        </ul>
        <p>Digite seu email para confirmar:</p>
        <input x-model="deleteAccountModal.confirmEmail" type="email" 
               placeholder="Confirme seu email"
               class="w-full p-3 bg-red-800 border border-red-600 rounded-md text-white placeholder-red-300">
        <p class="text-sm">Digite "EXCLUIR" para confirmar:</p>
        <input x-model="deleteAccountModal.confirmText" 
               placeholder="Digite EXCLUIR"
               class="w-full p-3 bg-red-800 border border-red-600 rounded-md text-white placeholder-red-300">
      </div>
      <div class="flex space-x-4 mt-6">
        <button @click="deleteAccount()" 
                :disabled="deleteAccountModal.loading || deleteAccountModal.confirmEmail !== user?.email || deleteAccountModal.confirmText !== 'EXCLUIR'"
                class="flex-1 py-3 bg-red-600 hover:bg-red-700 disabled:bg-red-800 disabled:cursor-not-allowed text-white rounded-md font-semibold">
          <span x-show="!deleteAccountModal.loading">üóëÔ∏è Excluir Permanentemente</span>
          <span x-show="deleteAccountModal.loading">Excluindo...</span>
        </button>
        <button @click="closeDeleteModal()" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-md">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal Alterar Nome -->
  <div x-show="nameModal.show" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="nameModal.show = false">
    <div class="bg-card p-8 rounded-lg max-w-md w-full mx-4">
      <h3 class="text-xl font-bold mb-4">‚úèÔ∏è Alterar Nome de Exibi√ß√£o</h3>
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-1">Novo nome:</label>
          <input x-model="nameModal.newName" 
                 placeholder="Digite seu nome"
                 class="w-full p-3 bg-input border border-custom rounded-md">
        </div>
      </div>
      <div class="flex space-x-4 mt-6">
        <button @click="updateDisplayName()" 
                :disabled="nameModal.loading || !nameModal.newName.trim()"
                class="flex-1 py-3 btn-primary rounded-md">
          <span x-show="!nameModal.loading">üíæ Salvar Nome</span>
          <span x-show="nameModal.loading">Salvando...</span>
        </button>
        <button @click="nameModal.show = false" class="px-6 py-3 btn-secondary rounded-md">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal Info -->
  <div x-show="infoModal.show" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="infoModal.show = false">
    <div class="bg-card p-8 rounded-lg max-w-lg w-full mx-4">
      <h3 class="text-xl font-bold mb-4">‚ÑπÔ∏è Sobre o Katalog</h3>
      <div class="space-y-4 text-gray-300">
        <p>Este √© um <strong>mockup inicial</strong> de um aplicativo desenvolvido por alunos da <strong>UMC</strong> do curso de <strong>Sistemas de Informa√ß√£o</strong>.</p>
        <p>O objetivo √© ajudar colecionadores a catalogar suas cole√ß√µes musicais de forma objetiva e organizada.</p>
        <p>Recursos inclusos:</p>
        <ul class="list-disc list-inside space-y-1 text-sm">
          <li>Cat√°logo completo com busca e filtros</li>
          <li>M√∫ltiplos formatos (CD, Vinil, Cassete, Digital)</li>
          <li>Busca autom√°tica de capas</li>
          <li>Importa√ß√£o via Excel</li>
          <li>Compartilhamento de cole√ß√µes</li>
        </ul>
        <p class="text-sm text-gray-400">Desenvolvido com ‚ù§Ô∏è usando Firebase, Alpine.js e Tailwind CSS.</p>
      </div>
      <div class="flex justify-end mt-6">
        <button @click="infoModal.show = false" class="px-6 py-2 btn-primary rounded-md">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Tela de Login -->
  <div x-show="!user && !isLoading" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-900 to-black">
    <div class="bg-card p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="text-center mb-8">
        <i data-lucide="disc-3" class="mx-auto h-16 w-16 text-green-400 mb-4"></i>
        <h1 class="text-3xl font-bold text-white">Katalog</h1>
        <p class="text-gray-400 mt-2">Organize sua cole√ß√£o musical</p>
      </div>
      
      <div class="space-y-4">
        <!-- Modo Login -->
        <div x-show="!showRegisterForm && !showForgotPassword" class="space-y-4">
          <div>
            <input x-model="loginEmail" type="email" placeholder="seu@email.com" 
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          </div>
          <div>
            <input x-model="loginPassword" type="password" placeholder="Sua senha" 
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          </div>
          <button @click="loginWithEmail()" 
                  :disabled="authLoading"
                  class="w-full py-3 px-4 btn-primary rounded-md font-medium">
            <span x-show="!authLoading">üéµ Entrar</span>
            <span x-show="authLoading" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mx-auto"></span>
          </button>
          
          <div class="text-center space-y-2">
            <button @click="showForgotPassword = true" 
                    class="text-sm text-gray-400 hover:text-white">
              Esqueci minha senha
            </button>
            <div>
              <span class="text-gray-400 text-sm">N√£o tem uma conta?</span>
              <button @click="showRegisterForm = true" 
                      class="text-green-400 hover:text-green-300 text-sm ml-1">
                Cadastre-se
              </button>
            </div>
          </div>
        </div>

        <!-- Modo Cadastro -->
        <div x-show="showRegisterForm" class="space-y-4">
          <h3 class="text-lg font-semibold text-center">Criar Nova Conta</h3>
          <div>
            <input x-model="registerData.displayName" type="text" placeholder="Seu nome completo" 
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom mb-3">
          </div>
          <div>
            <input x-model="loginEmail" type="email" placeholder="seu@email.com" 
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          </div>
          <div>
            <input x-model="loginPassword" type="password" placeholder="Senha (min. 6 caracteres)" 
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          </div>
          <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-3">
            <p class="text-xs text-blue-200">
              üìß Ser√° enviado um email de verifica√ß√£o. Voc√™ precisa confirmar para ativar sua conta.
            </p>
          </div>
          <button @click="registerWithEmail()" 
                  :disabled="authLoading"
                  class="w-full py-3 px-4 btn-primary rounded-md font-medium">
            <span x-show="!authLoading">üìù Criar Conta</span>
            <span x-show="authLoading" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mx-auto"></span>
          </button>
          
          <div class="text-center">
            <span class="text-gray-400 text-sm">J√° tem uma conta?</span>
            <button @click="showRegisterForm = false" 
                    class="text-green-400 hover:text-green-300 text-sm ml-1">
              Fazer login
            </button>
          </div>
        </div>

        <!-- Modo Esqueci Senha -->
        <div x-show="showForgotPassword" class="space-y-4">
          <h3 class="text-lg font-semibold text-center">Recuperar Senha</h3>
          <p class="text-sm text-gray-400 text-center">Digite seu email para receber o link de recupera√ß√£o:</p>
          <div>
            <input x-model="resetEmail" type="email" placeholder="seu@email.com" 
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          </div>
          <button @click="resetPassword()" 
                  :disabled="authLoading"
                  class="w-full py-3 px-4 btn-primary rounded-md font-medium">
            <span x-show="!authLoading">üìß Enviar Link</span>
            <span x-show="authLoading" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mx-auto"></span>
          </button>
          
          <div class="text-center">
            <button @click="showForgotPassword = false" 
                    class="text-gray-400 hover:text-white text-sm">
              ‚Üê Voltar ao login
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div x-show="user && !isLoading" class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-black flex-shrink-0 flex flex-col">
      <div class="p-4 flex items-center space-x-2 border-b border-custom">
        <i data-lucide="disc-3" class="text-green-400"></i>
        <h1 class="text-xl font-bold text-white">Katalog</h1>
      </div>
      <nav class="flex-1 p-4 space-y-2">
        <a href="#" @click.prevent="appView = 'collection'" 
           :class="{'bg-green-500 text-white': appView === 'collection'}"
           class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700">
           <i data-lucide="album"></i><span>Minha Cole√ß√£o</span>
        </a>
        <a href="#" @click.prevent="appView = 'add-record'" 
           :class="{'bg-green-500 text-white': appView === 'add-record'}"
           class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700">
           <i data-lucide="plus-circle"></i><span>Adicionar Item</span>
        </a>
        <a href="#" @click.prevent="importModal.show = true" 
           class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-blue-300">
           <i data-lucide="upload"></i><span>Importar Excel</span>
        </a>
        <a href="#" @click.prevent="appView = 'settings'" 
           :class="{'bg-green-500 text-white': appView === 'settings'}"
           class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-gray-300">
           <i data-lucide="settings"></i><span>Configura√ß√µes</span>
        </a>
      </nav>
      <div class="p-4 border-t border-custom space-y-2">
        <button @click="openShareModal()" 
                class="w-full flex items-center space-x-3 px-3 py-2 rounded-md bg-blue-600/50 hover:bg-blue-700 text-white">
          <i data-lucide="share-2"></i><span>Compartilhar</span>
        </button>
        <div class="px-3 py-2 text-xs text-gray-400 break-words">
          <span class="font-semibold text-gray-300">Usu√°rio:</span>
          <span x-text="user?.email || user?.uid.substring(0, 8) + '...'"></span>
        </div>
        <a href="#" @click.prevent="logout()" 
           class="flex items-center space-x-3 px-3 py-2 rounded-md bg-red-600/50 hover:bg-red-800 text-white">
           <i data-lucide="log-out"></i><span>Sair</span>
        </a>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-8 overflow-y-auto">
      <!-- Cole√ß√£o -->
      <div x-show="appView === 'collection'">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-3xl font-bold">Minha Cole√ß√£o (<span x-text="collection.length"></span>)</h2>
          <div class="flex space-x-2">
            <button @click="viewMode = 'grid'" 
                    :class="{'btn-primary': viewMode === 'grid', 'btn-secondary': viewMode !== 'grid'}"
                    class="px-4 py-2 rounded-md">
              <i data-lucide="grid-3x3"></i>
            </button>
            <button @click="viewMode = 'list'" 
                    :class="{'btn-primary': viewMode === 'list', 'btn-secondary': viewMode !== 'list'}"
                    class="px-4 py-2 rounded-md">
              <i data-lucide="list"></i>
            </button>
          </div>
        </div>
        
        <!-- Controles -->
        <div class="mb-6 space-y-4">
          <!-- Busca -->
          <input x-model="searchFilter" @input="filterCollection()" 
                 placeholder="üîç Buscar por √°lbum, artista, formato..." 
                 class="w-full max-w-md p-3 bg-input border border-custom rounded-md placeholder-custom">
          
          <!-- Filtros e Ordena√ß√£o -->
          <div class="flex flex-wrap gap-4">
            <select x-model="formatFilter" @change="filterCollection()" 
                    class="p-2 bg-input border border-custom rounded-md">
              <option value="">Todos os formatos</option>
              <option value="CD">üìÄ CD</option>
              <option value="Vinil">üéµ Vinil</option>
              <option value="Cassete">üìº Cassete</option>
              <option value="Digital">üíª Digital</option>
            </select>
            
            <select x-model="sortBy" @change="filterCollection()" 
                    class="p-2 bg-input border border-custom rounded-md">
              <option value="newest">Mais recentes</option>
              <option value="oldest">Mais antigos</option>
              <option value="album-asc">√Ålbum (A-Z)</option>
              <option value="album-desc">√Ålbum (Z-A)</option>
              <option value="artist-asc">Artista (A-Z)</option>
              <option value="artist-desc">Artista (Z-A)</option>
            </select>
          </div>
        </div>
        
        <!-- Grid View -->
        <div x-show="viewMode === 'grid' && filteredCollection.length > 0" 
             class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          <template x-for="record in filteredCollection" :key="record.id">
            <div class="bg-card rounded-lg overflow-hidden shadow-lg group relative transform hover:scale-105 transition-transform">
              <img :src="record.cover_url || `https://placehold.co/300x300/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`" 
                   class="w-full aspect-square object-cover"
                   :alt="`Capa do √°lbum ${record.album}`">
              <div class="absolute top-2 left-2">
                <span :class="`format-${record.format?.toLowerCase() || 'cd'}`" 
                      class="format-badge" 
                      x-text="record.format || 'CD'"></span>
              </div>
              <div class="absolute top-2 right-2 flex space-x-1">
                <button @click="openEditModal(record)" 
                        class="bg-blue-600 text-white rounded-full p-2 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-blue-700">
                  <i data-lucide="edit" class="w-4 h-4"></i>
                </button>
                <button @click="confirmDelete(record.id)" 
                        class="bg-red-600 text-white rounded-full p-2 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-700">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </div>
              <div class="p-3">
                <h3 class="font-bold text-white truncate" x-text="record.album" :title="record.album"></h3>
                <p class="text-sm text-gray-400 truncate" x-text="record.artist" :title="record.artist"></p>
                <div class="flex justify-between items-center mt-1">
                  <p x-show="record.year" class="text-xs text-gray-500" x-text="record.year"></p>
                  <p x-show="record.catalog_number" class="text-xs text-gray-500 font-mono" x-text="record.catalog_number"></p>
                </div>
                <p x-show="record.edition_notes" class="text-xs text-gray-400 mt-1 truncate" 
                   x-text="record.edition_notes" :title="record.edition_notes"></p>
              </div>
            </div>
          </template>
        </div>
        
        <!-- List View -->
        <div x-show="viewMode === 'list' && filteredCollection.length > 0" 
             class="bg-card rounded-lg overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-800">
              <tr>
                <th class="text-left p-4 font-semibold">Capa</th>
                <th class="text-left p-4 font-semibold">√Ålbum</th>
                <th class="text-left p-4 font-semibold">Artista</th>
                <th class="text-left p-4 font-semibold">Formato</th>
                <th class="text-left p-4 font-semibold">Ano</th>
                <th class="text-left p-4 font-semibold">Cat√°logo</th>
                <th class="text-left p-4 font-semibold">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="record in filteredCollection" :key="record.id">
                <tr class="border-b border-gray-700 hover:bg-gray-800">
                  <td class="p-4">
                    <img :src="record.cover_url || `https://placehold.co/60x60/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`" 
                         class="w-12 h-12 object-cover rounded">
                  </td>
                  <td class="p-4">
                    <div>
                      <p class="font-semibold" x-text="record.album"></p>
                      <p x-show="record.edition_notes" class="text-xs text-gray-400" x-text="record.edition_notes"></p>
                    </div>
                  </td>
                  <td class="p-4" x-text="record.artist"></td>
                  <td class="p-4">
                    <span :class="`format-${record.format?.toLowerCase() || 'cd'}`" 
                          class="format-badge" 
                          x-text="record.format || 'CD'"></span>
                  </td>
                  <td class="p-4" x-text="record.year || '-'"></td>
                  <td class="p-4">
                    <span x-show="record.catalog_number" class="font-mono text-sm" x-text="record.catalog_number"></span>
                    <span x-show="!record.catalog_number" class="text-gray-500">-</span>
                  </td>
                  <td class="p-4">
                    <div class="flex space-x-2">
                      <button @click="openEditModal(record)" 
                              class="text-blue-400 hover:text-blue-300" title="Editar">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                      </button>
                      <button @click="confirmDelete(record.id)" 
                              class="text-red-400 hover:text-red-300" title="Excluir">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        
        <!-- Empty State -->
        <div x-show="collection.length === 0" class="text-center py-20 bg-card rounded-lg">
          <i data-lucide="folder-x" class="mx-auto h-16 w-16 text-gray-500 mb-4"></i>
          <h3 class="text-xl font-semibold">Sua cole√ß√£o est√° vazia</h3>
          <p class="text-gray-400 mt-2">Comece adicionando seu primeiro item!</p>
          <button @click="appView = 'add-record'" class="mt-6 px-6 py-2 rounded-full btn-primary">Adicionar Item</button>
        </div>
        
        <!-- No Results -->
        <div x-show="collection.length > 0 && filteredCollection.length === 0" class="text-center py-10">
          <p class="text-gray-400">Nenhum resultado encontrado</p>
          <button @click="clearFilters()" class="mt-2 px-4 py-2 btn-secondary rounded-md">Limpar Filtros</button>
        </div>
      </div>

      <!-- Form Adicionar -->
      <div x-show="appView === 'add-record'">
        <h2 class="text-3xl font-bold mb-6">Adicionar Novo Item</h2>
        <form @submit.prevent="addRecord" class="max-w-3xl mx-auto bg-card p-8 rounded-lg space-y-6">
          
          <!-- Informa√ß√µes B√°sicas -->
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">√Ålbum/T√≠tulo *</label>
              <input x-model="newRecord.album" @input="debounceImageSearch()" required 
                     class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Artista *</label>
              <input x-model="newRecord.artist" @input="debounceImageSearch()" required 
                     class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
            </div>
          </div>
          
          <!-- Formato e Ano -->
          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Formato *</label>
              <select x-model="newRecord.format" required
                      class="w-full p-3 bg-input border border-custom rounded-md">
                <option value="">Selecione...</option>
                <option value="CD">üìÄ CD</option>
                <option value="Vinil">üéµ Vinil</option>
                <option value="Cassete">üìº Cassete</option>
                <option value="Digital">üíª Digital</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Ano</label>
              <input x-model="newRecord.year" type="number" min="1900" max="2030"
                     class="w-full p-3 bg-input border border-custom rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">N√∫mero de Cat√°logo</label>
              <input x-model="newRecord.catalog_number" placeholder="Ex: EVIL0023"
                     class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
            </div>
          </div>

          <!-- Descri√ß√£o da Edi√ß√£o -->
          <div>
            <label class="block text-sm font-medium mb-1">Descri√ß√£o da Edi√ß√£o</label>
            <textarea x-model="newRecord.edition_notes" 
                      placeholder="Ex: Edi√ß√£o limitada com capa dourada, remasterizado..."
                      class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom resize-none"
                      rows="3"></textarea>
          </div>

          <!-- Capa -->
          <div>
            <label class="block text-sm font-medium mb-3">Capa do √Ålbum</label>
            
            <!-- Busca autom√°tica -->
            <div x-show="autoImageSearch.found" class="mb-4 p-4 bg-green-900/20 border border-green-500/30 rounded-lg">
              <p class="text-sm text-green-300 mb-2">‚ú® Capa encontrada automaticamente!</p>
              <div class="flex items-center space-x-3">
                <img :src="autoImageSearch.url" class="w-16 h-16 object-cover rounded-md" alt="Capa encontrada">
                <div class="flex-1">
                  <button type="button" @click="useAutoImage()" 
                          class="px-4 py-2 btn-primary rounded-md text-sm mr-2">
                    ‚úÖ Usar esta capa
                  </button>
                  <button type="button" @click="autoImageSearch = {found: false, url: ''}" 
                          class="px-4 py-2 btn-secondary rounded-md text-sm">
                    ‚ùå Ignorar
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Bot√£o de busca manual -->
            <div class="mb-4">
              <button type="button" @click="searchCoverOnGoogle()" 
                      :disabled="!newRecord.album || !newRecord.artist || coverSearchLoading"
                      class="px-4 py-2 btn-primary rounded-md flex items-center">
                <i data-lucide="search" class="w-4 h-4 mr-2"></i>
                <span x-show="!coverSearchLoading">üîç Buscar Capa no Google</span>
                <span x-show="coverSearchLoading">Buscando...</span>
              </button>
            </div>
            
            <!-- URL Manual -->
            <input x-model="newRecord.cover_url" placeholder="üåê Cole aqui a URL da capa..."
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom mb-4">
            
            <!-- Preview -->
            <div x-show="newRecord.cover_url" class="mb-4">
              <p class="text-sm text-gray-400 mb-2">Preview:</p>
              <img :src="newRecord.cover_url" class="w-32 h-32 object-cover rounded-md" 
                   @error="newRecord.cover_url = ''" alt="Preview da capa">
            </div>
          </div>
          
          <div class="flex space-x-4">
            <button type="submit" :disabled="formLoading" 
                    class="flex-1 py-3 font-semibold rounded-md btn-primary flex items-center justify-center">
              <span x-show="!formLoading">üíæ Salvar Item</span>
              <span x-show="formLoading" class="flex items-center">
                <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
                Salvando...
              </span>
            </button>
            <button type="button" @click="resetForm()" 
                    class="px-6 py-3 btn-secondary rounded-md">Limpar</button>
          </div>
        </form>
      </div>

      <!-- Configura√ß√µes -->
      <div x-show="appView === 'settings'">
        <h2 class="text-3xl font-bold mb-6">‚öôÔ∏è Configura√ß√µes da Conta</h2>
        
        <div class="max-w-2xl space-y-6">
          <!-- Informa√ß√µes da Conta -->
          <div class="bg-card p-6 rounded-lg">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
              <i data-lucide="user" class="w-5 h-5 mr-2"></i>
              Informa√ß√µes da Conta
            </h3>
            <div class="space-y-3">
              <div>
                <label class="text-sm text-gray-400">Email:</label>
                <p class="text-white" x-text="user?.email || 'N√£o informado'"></p>
              </div>
              <div>
                <label class="text-sm text-gray-400">Nome de exibi√ß√£o:</label>
                <div class="flex items-center justify-between">
                  <p class="text-white" x-text="user?.displayName || 'N√£o informado'"></p>
                  <button @click="openNameModal()" class="text-blue-400 hover:text-blue-300 text-sm">
                    <i data-lucide="edit" class="w-4 h-4 inline mr-1"></i>Alterar
                  </button>
                </div>
              </div>
              <div>
                <label class="text-sm text-gray-400">Status da conta:</label>
                <p :class="user?.emailVerified ? 'text-green-400' : 'text-yellow-400'">
                  <i :data-lucide="user?.emailVerified ? 'check-circle' : 'alert-circle'" class="w-4 h-4 inline mr-1"></i>
                  <span x-text="user?.emailVerified ? 'Verificada' : 'Aguardando verifica√ß√£o'"></span>
                </p>
                <button x-show="!user?.emailVerified" @click="resendVerification()" 
                        class="text-blue-400 hover:text-blue-300 text-sm mt-1">
                  üìß Reenviar email de verifica√ß√£o
                </button>
              </div>
              <div>
                <label class="text-sm text-gray-400">Criada em:</label>
                <p class="text-white" x-text="formatDate(user?.metadata?.creationTime)"></p>
              </div>
            </div>
          </div>

          <!-- Seguran√ßa -->
          <div class="bg-card p-6 rounded-lg">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
              <i data-lucide="shield" class="w-5 h-5 mr-2"></i>
              Seguran√ßa
            </h3>
            <div class="space-y-4">
              <div class="flex items-center justify-between p-4 bg-gray-800 rounded-lg">
                <div>
                  <p class="font-medium">Alterar Senha</p>
                  <p class="text-sm text-gray-400">Redefina sua senha atual</p>
                </div>
                <button @click="changePassword()" class="btn-secondary px-4 py-2 rounded-md">
                  <i data-lucide="key" class="w-4 h-4 mr-1"></i>Alterar
                </button>
              </div>

              <div class="flex items-center justify-between p-4 bg-gray-800 rounded-lg">
                <div>
                  <p class="font-medium">Autentica√ß√£o de Dois Fatores (2FA)</p>
                  <p class="text-sm text-gray-400">Adicione uma camada extra de seguran√ßa</p>
                </div>
                <div class="flex items-center space-x-2">
                  <span class="text-sm text-yellow-400">Em breve</span>
                  <button disabled class="btn-secondary px-4 py-2 rounded-md opacity-50 cursor-not-allowed">
                    <i data-lucide="smartphone" class="w-4 h-4 mr-1"></i>Configurar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Estat√≠sticas -->
          <div class="bg-card p-6 rounded-lg">
            <h3 class="text-xl font-semibold mb-4 flex items-center">
              <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2"></i>
              Estat√≠sticas da Cole√ß√£o
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="text-center p-4 bg-gray-800 rounded-lg">
                <p class="text-2xl font-bold text-green-400" x-text="collection.length"></p>
                <p class="text-sm text-gray-400">Total de Itens</p>
              </div>
              <div class="text-center p-4 bg-gray-800 rounded-lg">
                <p class="text-2xl font-bold text-blue-400" x-text="collection.filter(r => r.format === 'CD').length"></p>
                <p class="text-sm text-gray-400">CDs</p>
              </div>
              <div class="text-center p-4 bg-gray-800 rounded-lg">
                <p class="text-2xl font-bold text-purple-400" x-text="collection.filter(r => r.format === 'Vinil').length"></p>
                <p class="text-sm text-gray-400">Vinis</p>
              </div>
              <div class="text-center p-4 bg-gray-800 rounded-lg">
                <p class="text-2xl font-bold text-orange-400" x-text="collection.filter(r => r.format === 'Cassete').length"></p>
                <p class="text-sm text-gray-400">Cassetes</p>
              </div>
            </div>
          </div>

          <!-- Zona de Perigo -->
          <div class="bg-red-900/20 border border-red-500/30 p-6 rounded-lg">
            <h3 class="text-xl font-semibold mb-4 flex items-center text-red-400">
              <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
              Zona de Perigo
            </h3>
            <div class="space-y-3">
              <p class="text-red-300 text-sm">As a√ß√µes abaixo s√£o irrevers√≠veis. Proceda com cautela.</p>
              <div class="flex flex-col sm:flex-row gap-3">
                <button @click="exportData()" 
                        class="flex-1 py-2 px-4 bg-blue-700 hover:bg-blue-800 text-white rounded-md flex items-center justify-center">
                  <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                  Exportar Dados
                </button>
                <button @click="openDeleteModal()" 
                        class="flex-1 py-2 px-4 bg-red-700 hover:bg-red-800 text-white rounded-md flex items-center justify-center">
                  <i data-lucide="trash-2" class="w-4 h-4 mr-2"></i>
                  Excluir Conta
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Bot√£o Info -->
  <button @click="infoModal.show = true" 
          class="footer-info p-3 rounded-full text-gray-400 hover:text-white hover:bg-gray-700 transition-colors"
          title="Sobre o Katalog">
    <i data-lucide="info" class="w-5 h-5"></i>
  </button>

  <script>
    // üî• SUAS CONFIGURA√á√ïES DO FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyAzEu2hLmvPzaFLgQtXUAUkuXvwokD2F-A",
      authDomain: "katalog-1178e.firebaseapp.com",
      projectId: "katalog-1178e",
      storageBucket: "katalog-1178e.firebasestorage.app",
      messagingSenderId: "998961219093",
      appId: "1:998961219093:web:6afddd14ad2ddd9ed3301c"
    };

    // üîç CONFIGURA√á√ïES DA API DE BUSCA DE IMAGENS
    // Para funcionar, voc√™ precisa:
    // 1. Ir ao Google Cloud Console (console.cloud.google.com)
    // 2. Criar/selecionar um projeto
    // 3. Ativar a "Custom Search API"
    // 4. Criar uma chave de API
    // 5. Criar um mecanismo de busca personalizado (cse.google.com)
    // 6. Configurar para buscar apenas imagens
    const GOOGLE_API_KEY = 'SUA_CHAVE_API_AQUI'; // Substitua pela sua chave
    const SEARCH_ENGINE_ID = 'SEU_SEARCH_ENGINE_ID_AQUI'; // Substitua pelo seu Search Engine ID

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    document.addEventListener('alpine:init', () => {
      Alpine.data('app', () => ({
        // Estados principais
        isLoading: true,
        loadingMessage: 'Inicializando...',
        user: null,
        authLoading: false,
        formLoading: false,
        coverSearchLoading: false,
        
        // UI
        appView: 'collection',
        viewMode: 'grid',
        showRegisterForm: false,
        showForgotPassword: false,
        searchFilter: '',
        formatFilter: '',
        sortBy: 'newest',
        
        // Modals
        shareModal: { show: false, url: '' },
        editModal: { show: false, record: {}, loading: false },
        importModal: { show: false, data: [], preview: [], loading: false },
        infoModal: { show: false },
        deleteAccountModal: { 
          show: false, 
          loading: false, 
          confirmEmail: '', 
          confirmText: '' 
        },
        nameModal: { show: false, newName: '', loading: false },
        
        // Dados
        collection: [],
        filteredCollection: [],
        newRecord: { 
          album: '', 
          artist: '', 
          format: '',
          year: '', 
          catalog_number: '',
          edition_notes: '',
          cover_url: '' 
        },
        
        // Auth
        loginEmail: '',
        loginPassword: '',
        resetEmail: '',
        registerData: { displayName: '' },
        
        // Busca autom√°tica de imagem
        autoImageSearch: { found: false, url: '' },
        imageSearchTimeout: null,
        
        // Notifica√ß√£o
        notification: { show: false, message: '', type: 'success' },
        collectionListener: null,

        async init() {
          try {
            this.loadingMessage = 'Conectando...';
            
            // Configurar listener de autentica√ß√£o
            auth.onAuthStateChanged((user) => {
              this.user = user;
              if (user) {
                this.setupCollection(user.uid);
              } else {
                this.collection = [];
                this.filteredCollection = [];
              }
              this.isLoading = false;
            });
            
          } catch (error) {
            console.error('Erro ao inicializar:', error);
            this.showNotification("Erro ao inicializar aplica√ß√£o", "error");
            this.isLoading = false;
          }
          
          // Inicializar √≠cones
          this.$nextTick(() => {
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
          });
        },

        // === AUTENTICA√á√ÉO ===
        async loginWithEmail() {
          if (!this.loginEmail || !this.loginPassword) {
            this.showNotification("Preencha email e senha", "error");
            return;
          }
          
          this.authLoading = true;
          try {
            await auth.signInWithEmailAndPassword(this.loginEmail, this.loginPassword);
            this.showNotification("Login realizado com sucesso!", "success");
            this.loginEmail = '';
            this.loginPassword = '';
          } catch (error) {
            console.error('Erro no login:', error);
            this.showNotification("Email ou senha incorretos", "error");
          } finally {
            this.authLoading = false;
          }
        },

        async registerWithEmail() {
          if (!this.registerData.displayName?.trim()) {
            this.showNotification("Preencha seu nome completo", "error");
            return;
          }
          
          if (!this.loginEmail || !this.loginPassword) {
            this.showNotification("Preencha email e senha", "error");
            return;
          }
          
          if (this.loginPassword.length < 6) {
            this.showNotification("Senha deve ter pelo menos 6 caracteres", "error");
            return;
          }
          
          this.authLoading = true;
          try {
            // Criar conta
            const userCredential = await auth.createUserWithEmailAndPassword(this.loginEmail, this.loginPassword);
            
            // Atualizar nome de exibi√ß√£o
            await userCredential.user.updateProfile({
              displayName: this.registerData.displayName.trim()
            });
            
            // Enviar email de verifica√ß√£o
            await userCredential.user.sendEmailVerification({
              url: window.location.origin,
              handleCodeInApp: true
            });
            
            this.showNotification("Conta criada! Verifique seu email para ativ√°-la üìß", "success");
            this.loginEmail = '';
            this.loginPassword = '';
            this.registerData.displayName = '';
            this.showRegisterForm = false;
            
          } catch (error) {
            console.error('Erro ao registrar:', error);
            if (error.code === 'auth/email-already-in-use') {
              this.showNotification("Este email j√° est√° em uso", "error");
            } else if (error.code === 'auth/weak-password') {
              this.showNotification("Senha muito fraca", "error");
            } else if (error.code === 'auth/invalid-email') {
              this.showNotification("Email inv√°lido", "error");
            } else {
              this.showNotification("Erro ao criar conta: " + error.message, "error");
            }
          } finally {
            this.authLoading = false;
          }
        },

        async resetPassword() {
          if (!this.resetEmail) {
            this.showNotification("Digite seu email", "error");
            return;
          }
          
          this.authLoading = true;
          try {
            await auth.sendPasswordResetEmail(this.resetEmail, {
              url: window.location.origin,
              handleCodeInApp: true
            });
            this.showNotification("Link de recupera√ß√£o enviado! Verifique seu email üìß", "success");
            this.resetEmail = '';
            this.showForgotPassword = false;
          } catch (error) {
            console.error('Erro ao enviar email:', error);
            if (error.code === 'auth/user-not-found') {
              this.showNotification("Email n√£o encontrado", "error");
            } else if (error.code === 'auth/invalid-email') {
              this.showNotification("Email inv√°lido", "error");
            } else {
              this.showNotification("Erro ao enviar email: " + error.message, "error");
            }
          } finally {
            this.authLoading = false;
          }
        },

        async resendVerification() {
          if (!this.user) return;
          
          try {
            await this.user.sendEmailVerification({
              url: window.location.origin,
              handleCodeInApp: true
            });
            this.showNotification("Email de verifica√ß√£o reenviado! üìß", "success");
          } catch (error) {
            console.error('Erro ao reenviar email:', error);
            this.showNotification("Erro ao reenviar email: " + error.message, "error");
          }
        },

        // === GERENCIAMENTO DE CONTA ===
        openNameModal() {
          this.nameModal = {
            show: true,
            newName: this.user?.displayName || '',
            loading: false
          };
        },

        async updateDisplayName() {
          if (!this.nameModal.newName.trim()) {
            this.showNotification("Digite um nome v√°lido", "error");
            return;
          }
          
          this.nameModal.loading = true;
          try {
            await this.user.updateProfile({
              displayName: this.nameModal.newName.trim()
            });
            
            this.showNotification("Nome atualizado com sucesso! ‚úÖ", "success");
            this.nameModal.show = false;
            
          } catch (error) {
            console.error('Erro ao atualizar nome:', error);
            this.showNotification("Erro ao atualizar nome: " + error.message, "error");
          } finally {
            this.nameModal.loading = false;
          }
        },

        async changePassword() {
          if (!this.user?.email) {
            this.showNotification("Email n√£o dispon√≠vel", "error");
            return;
          }
          
          try {
            await auth.sendPasswordResetEmail(this.user.email, {
              url: window.location.origin,
              handleCodeInApp: true
            });
            this.showNotification("Link para alterar senha enviado para seu email! üìß", "success");
          } catch (error) {
            console.error('Erro ao enviar email:', error);
            this.showNotification("Erro ao enviar email: " + error.message, "error");
          }
        },

        openDeleteModal() {
          this.deleteAccountModal = {
            show: true,
            loading: false,
            confirmEmail: '',
            confirmText: ''
          };
        },

        closeDeleteModal() {
          this.deleteAccountModal = {
            show: false,
            loading: false,
            confirmEmail: '',
            confirmText: ''
          };
        },

        async deleteAccount() {
          if (!this.user) return;
          
          if (this.deleteAccountModal.confirmEmail !== this.user.email) {
            this.showNotification("Email de confirma√ß√£o n√£o confere", "error");
            return;
          }
          
          if (this.deleteAccountModal.confirmText !== 'EXCLUIR') {
            this.showNotification("Digite 'EXCLUIR' para confirmar", "error");
            return;
          }
          
          this.deleteAccountModal.loading = true;
          
          try {
            // Excluir todos os dados do usu√°rio no Firestore
            const batch = db.batch();
            const userRecords = await db.collection(`users/${this.user.uid}/records`).get();
            
            userRecords.docs.forEach((doc) => {
              batch.delete(doc.ref);
            });
            
            // Excluir documento do usu√°rio
            const userDoc = db.collection('users').doc(this.user.uid);
            batch.delete(userDoc);
            
            await batch.commit();
            
            // Excluir conta de autentica√ß√£o
            await this.user.delete();
            
            this.showNotification("Conta exclu√≠da com sucesso", "success");
            
          } catch (error) {
            console.error('Erro ao excluir conta:', error);
            if (error.code === 'auth/requires-recent-login') {
              this.showNotification("Por seguran√ßa, fa√ßa login novamente antes de excluir sua conta", "error");
              await this.logout();
            } else {
              this.showNotification("Erro ao excluir conta: " + error.message, "error");
            }
          } finally {
            this.deleteAccountModal.loading = false;
            this.closeDeleteModal();
          }
        },

        async exportData() {
          try {
            // Preparar dados para exporta√ß√£o
            const exportData = {
              account: {
                email: this.user?.email,
                displayName: this.user?.displayName,
                created: this.user?.metadata?.creationTime,
                exported: new Date().toISOString()
              },
              collection: this.collection.map(record => ({
                album: record.album,
                artist: record.artist,
                format: record.format,
                year: record.year,
                catalog_number: record.catalog_number,
                edition_notes: record.edition_notes,
                cover_url: record.cover_url,
                created: record.createdAt?.toDate?.()?.toISOString()
              }))
            };
            
            // Criar arquivo JSON
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Download
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `katalog-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            this.showNotification("Dados exportados com sucesso! üì•", "success");
            
          } catch (error) {
            console.error('Erro ao exportar dados:', error);
            this.showNotification("Erro ao exportar dados", "error");
          }
        },

        formatDate(timestamp) {
          if (!timestamp) return 'N√£o dispon√≠vel';
          return new Date(timestamp).toLocaleDateString('pt-BR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
        },d);
            this.showNotification("Conta criada com sucesso!", "success");
            this.loginEmail = '';
            this.loginPassword = '';
            this.showRegisterForm = false;
          } catch (error) {
            console.error('Erro ao registrar:', error);
            if (error.code === 'auth/email-already-in-use') {
              this.showNotification("Este email j√° est√° em uso", "error");
            } else {
              this.showNotification("Erro ao criar conta", "error");
            }
          } finally {
            this.authLoading = false;
          }
        },

        async resetPassword() {
          if (!this.resetEmail) {
            this.showNotification("Digite seu email", "error");
            return;
          }
          
          this.authLoading = true;
          try {
            await auth.sendPasswordResetEmail(this.resetEmail, {
              url: window.location.origin,
              handleCodeInApp: true
            });
            this.showNotification("Link de recupera√ß√£o enviado! Verifique seu email üìß", "success");
            this.resetEmail = '';
            this.showForgotPassword = false;
          } catch (error) {
            console.error('Erro ao enviar email:', error);
            if (error.code === 'auth/user-not-found') {
              this.showNotification("Email n√£o encontrado", "error");
            } else if (error.code === 'auth/invalid-email') {
              this.showNotification("Email inv√°lido", "error");
            } else {
              this.showNotification("Erro ao enviar email: " + error.message, "error");
            }
          } finally {
            this.authLoading = false;
          }
        },

        async logout() {
          try {
            await auth.signOut();
            this.showNotification("Logout realizado com sucesso", "success");
            this.appView = 'collection';
          } catch (error) {
            console.error('Erro ao sair:', error);
            this.showNotification("Erro ao sair", "error");
          }
        },

        // === FIRESTORE ===
        setupCollection(userId) {
          if (this.collectionListener) {
            this.collectionListener();
          }
          
          this.collectionListener = db.collection(`users/${userId}/records`)
            .orderBy('createdAt', 'desc')
            .onSnapshot((snapshot) => {
              this.collection = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              this.filterCollection();
            }, (error) => {
              console.error('Erro ao carregar cole√ß√£o:', error);
              this.showNotification("Erro ao carregar cole√ß√£o", "error");
            });
        },

        filterCollection() {
          let filtered = [...this.collection];
          
          // Filtro por texto
          if (this.searchFilter.trim()) {
            const filter = this.searchFilter.toLowerCase();
            filtered = filtered.filter(record => 
              record.album.toLowerCase().includes(filter) ||
              record.artist.toLowerCase().includes(filter) ||
              record.format?.toLowerCase().includes(filter) ||
              record.catalog_number?.toLowerCase().includes(filter) ||
              record.edition_notes?.toLowerCase().includes(filter)
            );
          }
          
          // Filtro por formato
          if (this.formatFilter) {
            filtered = filtered.filter(record => record.format === this.formatFilter);
          }
          
          // Ordena√ß√£o
          switch (this.sortBy) {
            case 'newest':
              filtered.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
              break;
            case 'oldest':
              filtered.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
              break;
            case 'album-asc':
              filtered.sort((a, b) => a.album.localeCompare(b.album));
              break;
            case 'album-desc':
              filtered.sort((a, b) => b.album.localeCompare(a.album));
              break;
            case 'artist-asc':
              filtered.sort((a, b) => a.artist.localeCompare(b.artist));
              break;
            case 'artist-desc':
              filtered.sort((a, b) => b.artist.localeCompare(a.artist));
              break;
          }
          
          this.filteredCollection = filtered;
        },

        clearFilters() {
          this.searchFilter = '';
          this.formatFilter = '';
          this.sortBy = 'newest';
          this.filterCollection();
        },

        async addRecord() {
          if (!this.newRecord.album.trim() || !this.newRecord.artist.trim() || !this.newRecord.format) {
            this.showNotification("√Ålbum, Artista e Formato s√£o obrigat√≥rios", "error");
            return;
          }
          
          this.formLoading = true;
          
          try {
            const recordData = {
              album: this.newRecord.album.trim(),
              artist: this.newRecord.artist.trim(),
              format: this.newRecord.format,
              year: this.newRecord.year ? Number(this.newRecord.year) : null,
              catalog_number: this.newRecord.catalog_number?.trim() || null,
              edition_notes: this.newRecord.edition_notes?.trim() || null,
              cover_url: this.newRecord.cover_url?.trim() || null,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection(`users/${this.user.uid}/records`).add(recordData);
            
            this.showNotification("Item adicionado com sucesso! üéâ", "success");
            this.resetForm();
            this.appView = 'collection';
            
          } catch (error) {
            console.error('Erro ao adicionar item:', error);
            this.showNotification("Erro ao salvar item", "error");
          } finally {
            this.formLoading = false;
          }
        },

        // === EDI√á√ÉO ===
        openEditModal(record) {
          this.editModal = {
            show: true,
            loading: false,
            record: { ...record }
          };
          this.$nextTick(() => lucide.createIcons());
        },

        async updateRecord() {
          if (!this.editModal.record.album?.trim() || !this.editModal.record.artist?.trim() || !this.editModal.record.format) {
            this.showNotification("√Ålbum, Artista e Formato s√£o obrigat√≥rios", "error");
            return;
          }
          
          this.editModal.loading = true;
          
          try {
            const recordData = {
              album: this.editModal.record.album.trim(),
              artist: this.editModal.record.artist.trim(),
              format: this.editModal.record.format,
              year: this.editModal.record.year ? Number(this.editModal.record.year) : null,
              catalog_number: this.editModal.record.catalog_number?.trim() || null,
              edition_notes: this.editModal.record.edition_notes?.trim() || null,
              cover_url: this.editModal.record.cover_url?.trim() || null,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection(`users/${this.user.uid}/records`).doc(this.editModal.record.id).update(recordData);
            
            this.showNotification("Item atualizado com sucesso! ‚úÖ", "success");
            this.editModal.show = false;
            
          } catch (error) {
            console.error('Erro ao atualizar item:', error);
            this.showNotification("Erro ao atualizar item", "error");
          } finally {
            this.editModal.loading = false;
          }
        },

        async confirmDelete(id) {
          if (!confirm('Tem certeza que deseja excluir este item da sua cole√ß√£o?')) {
            return;
          }
          
          try {
            await db.collection(`users/${this.user.uid}/records`).doc(id).delete();
            this.showNotification("Item exclu√≠do com sucesso!", "success");
          } catch (error) {
            console.error('Erro ao excluir:', error);
            this.showNotification("Erro ao excluir item", "error");
          }
        },

        // === BUSCA DE CAPA ===
        debounceImageSearch() {
          // Limpar timeout anterior
          if (this.imageSearchTimeout) {
            clearTimeout(this.imageSearchTimeout);
          }
          
          // Reset busca autom√°tica
          this.autoImageSearch = { found: false, url: '' };
          
          // Se tem √°lbum e artista, buscar ap√≥s 1 segundo
          if (this.newRecord.album.trim() && this.newRecord.artist.trim()) {
            this.imageSearchTimeout = setTimeout(() => {
              this.searchAlbumCoverAuto();
            }, 1000);
          }
        },

        async searchAlbumCoverAuto() {
          if (!GOOGLE_API_KEY || !SEARCH_ENGINE_ID || 
              GOOGLE_API_KEY === 'SUA_CHAVE_API_AQUI' || 
              SEARCH_ENGINE_ID === 'SEU_SEARCH_ENGINE_ID_AQUI') {
            console.log('API de busca n√£o configurada - usando fallback');
            // Fallback para imagem placeholder
            const query = `${this.newRecord.artist} ${this.newRecord.album}`;
            this.autoImageSearch = {
              found: true,
              url: `https://picsum.photos/300/300?random=${encodeURIComponent(query)}`
            };
            return;
          }

          try {
            const query = `${this.newRecord.artist} ${this.newRecord.album} album cover`;
            const searchUrl = `https://www.googleapis.com/customsearch/v1?key=${GOOGLE_API_KEY}&cx=${SEARCH_ENGINE_ID}&q=${encodeURIComponent(query)}&searchType=image&num=1&imgType=photo&imgSize=medium&safe=active`;
            
            console.log('Buscando capa para:', query);
            
            const response = await fetch(searchUrl);
            const data = await response.json();
            
            if (data.items && data.items.length > 0) {
              const firstImage = data.items[0];
              
              // Verificar se a imagem carrega
              const img = new Image();
              img.crossOrigin = 'anonymous';
              
              img.onload = () => {
                this.autoImageSearch = {
                  found: true,
                  url: firstImage.link,
                  title: firstImage.title || 'Capa encontrada'
                };
                console.log('Capa encontrada:', firstImage.link);
              };
              
              img.onerror = () => {
                console.log('Erro ao carregar imagem encontrada, tentando thumbnail...');
                // Tentar o thumbnail se a imagem principal falhar
                if (firstImage.image?.thumbnailLink) {
                  this.tryThumbnail(firstImage.image.thumbnailLink);
                } else {
                  this.useFallbackImage();
                }
              };
              
              img.src = firstImage.link;
              
            } else {
              console.log('Nenhuma imagem encontrada na busca');
              this.useFallbackImage();
            }
            
          } catch (error) {
            console.error('Erro na busca de imagem:', error);
            this.useFallbackImage();
          }
        },

        tryThumbnail(thumbnailUrl) {
          const img = new Image();
          img.crossOrigin = 'anonymous';
          
          img.onload = () => {
            this.autoImageSearch = {
              found: true,
              url: thumbnailUrl,
              title: 'Capa encontrada (thumbnail)'
            };
            console.log('Thumbnail carregado:', thumbnailUrl);
          };
          
          img.onerror = () => {
            console.log('Thumbnail tamb√©m falhou, usando fallback');
            this.useFallbackImage();
          };
          
          img.src = thumbnailUrl;
        },

        useFallbackImage() {
          // Usar uma API alternativa gratuita para imagens relacionadas a m√∫sica
          const query = `${this.newRecord.artist} ${this.newRecord.album}`;
          const fallbackUrl = `https://picsum.photos/300/300?random=${encodeURIComponent(query)}`;
          
          this.autoImageSearch = {
            found: true,
            url: fallbackUrl,
            title: 'Imagem sugerida (configure a API para melhores resultados)'
          };
        },

        useAutoImage() {
          this.newRecord.cover_url = this.autoImageSearch.url;
          this.autoImageSearch = { found: false, url: '' };
        },

        searchCoverOnGoogle() {
          if (!this.newRecord.album.trim() || !this.newRecord.artist.trim()) {
            this.showNotification("Preencha √°lbum e artista primeiro!", "error");
            return;
          }
          
          const query = `${this.newRecord.artist} ${this.newRecord.album} album cover`;
          const googleUrl = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`;
          
          window.open(googleUrl, '_blank');
          this.showNotification("Clique com o bot√£o direito na imagem ‚Üí 'Copiar endere√ßo da imagem'", "info");
        },

        // === IMPORT EXCEL ===
        handleFileUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              
              // Pegar a primeira planilha
              const sheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[sheetName];
              
              // Converter para JSON
              const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: '' });
              
              if (jsonData.length === 0) {
                this.showNotification("Arquivo vazio ou inv√°lido", "error");
                return;
              }

              // Processar dados
              const processedData = jsonData.map((row, index) => {
                // Normalizar chaves (min√∫sculas, sem espa√ßos)
                const normalizedRow = {};
                Object.keys(row).forEach(key => {
                  const normalizedKey = key.toLowerCase().trim().replace(/\s+/g, '_');
                  normalizedRow[normalizedKey] = row[key];
                });

                return {
                  album: normalizedRow.album || normalizedRow.√°lbum || normalizedRow.titulo || '',
                  artist: normalizedRow.artist || normalizedRow.artista || '',
                  format: this.normalizeFormat(normalizedRow.format || normalizedRow.formato || 'CD'),
                  year: normalizedRow.year || normalizedRow.ano || null,
                  catalog_number: normalizedRow.catalog_number || normalizedRow.catalogo || null,
                  edition_notes: normalizedRow.edition_notes || normalizedRow.observacoes || null,
                  cover_url: normalizedRow.cover_url || normalizedRow.capa || null
                };
              }).filter(item => item.album && item.artist); // S√≥ itens com √°lbum e artista

              if (processedData.length === 0) {
                this.showNotification("Nenhum registro v√°lido encontrado. Verifique se as colunas 'album' e 'artist' existem.", "error");
                return;
              }

              this.importModal.data = processedData;
              this.importModal.preview = processedData;
              this.showNotification(`${processedData.length} itens carregados para importa√ß√£o!`, "success");
              
            } catch (error) {
              console.error('Erro ao processar arquivo:', error);
              this.showNotification("Erro ao ler arquivo Excel", "error");
            }
          };

          reader.readAsArrayBuffer(file);
        },

        normalizeFormat(format) {
          const normalizedFormat = format.toString().toLowerCase();
          if (normalizedFormat.includes('vinil') || normalizedFormat.includes('lp')) return 'Vinil';
          if (normalizedFormat.includes('cassete') || normalizedFormat.includes('fita')) return 'Cassete';
          if (normalizedFormat.includes('digital') || normalizedFormat.includes('mp3')) return 'Digital';
          return 'CD'; // Default
        },

        async importRecords() {
          if (this.importModal.data.length === 0) return;

          this.importModal.loading = true;
          let successCount = 0;
          let errorCount = 0;

          try {
            const batch = db.batch();
            
            this.importModal.data.forEach((record) => {
              const docRef = db.collection(`users/${this.user.uid}/records`).doc();
              batch.set(docRef, {
                ...record,
                year: record.year ? Number(record.year) : null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            });

            await batch.commit();
            successCount = this.importModal.data.length;
            
            this.showNotification(`‚úÖ ${successCount} itens importados com sucesso!`, "success");
            this.closeImportModal();
            this.appView = 'collection';
            
          } catch (error) {
            console.error('Erro na importa√ß√£o:', error);
            this.showNotification("Erro durante a importa√ß√£o", "error");
          } finally {
            this.importModal.loading = false;
          }
        },

        closeImportModal() {
          this.importModal = { show: false, data: [], preview: [], loading: false };
        },

        // === COMPARTILHAMENTO ===
        openShareModal() {
          const baseUrl = window.location.origin + window.location.pathname;
          const shareUrl = `${baseUrl}?user=${this.user.uid}&view=public`;
          
          this.shareModal = {
            show: true,
            url: shareUrl
          };
        },

        async copyShareLink() {
          try {
            await navigator.clipboard.writeText(this.shareModal.url);
            this.showNotification("Link copiado! üìã", "success");
          } catch (error) {
            // Fallback para navegadores mais antigos
            const textArea = document.createElement('textarea');
            textArea.value = this.shareModal.url;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            this.showNotification("Link copiado! üìã", "success");
          }
        },

        // === UTILIT√ÅRIOS ===
        resetForm() {
          this.newRecord = { 
            album: '', 
            artist: '', 
            format: '',
            year: '', 
            catalog_number: '',
            edition_notes: '',
            cover_url: '' 
          };
          this.autoImageSearch = { found: false, url: '' };
          if (this.imageSearchTimeout) {
            clearTimeout(this.imageSearchTimeout);
          }
        },

        showNotification(message, type = 'success') {
          this.notification = { message, type, show: true };
          setTimeout(() => { this.notification.show = false; }, 4000);
        }
      }))
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Katalog</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- APIs Javascript -->
  
  <!-- SheetJS (Planilhas)-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- QRCode.js (QR Codes)-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
    body { font-family: 'Inter', sans-serif; }
    
    /* Tema Escuro (padrão) */
    .theme-dark {
      background-color: #121212;
      color: #E0E0E0;
    }
    .theme-dark .bg-card { background-color: #1E1E1E; }
    .theme-dark .bg-input { background-color: #2A2A2A; }
    .theme-dark .border-custom { border-color: #383838; }
    .theme-dark .text-muted { color: #888888; }
    
    /* Tema Claro */
    .theme-light {
      background-color: #f8fafc;
      color: #1f2937;
    }
    .theme-light .bg-card { background-color: #ffffff; }
    .theme-light .bg-input { background-color: #f1f5f9; }
    .theme-light .border-custom { border-color: #e2e8f0; }
    .theme-light .text-muted { color: #374151 !important; }
    .theme-light .bg-black { background-color: #1f2937 !important; color: #ffffff !important; }
    .theme-light .hover\:bg-gray-700:hover { background-color: #e5e7eb !important; }
    .theme-light .text-white { color: #1f2937 !important; }
    .theme-light aside.bg-black { background-color: #f8fafc !important; border-right: 1px solid #e2e8f0; }
    .theme-light aside .text-white { color: #1f2937 !important; }
    .theme-light aside .text-gray-400 { color: #64748b !important; }
    .theme-light aside .border-custom { border-color: #e2e8f0 !important; }
    .theme-light aside .hover\:bg-gray-700:hover { background-color: #e5e7eb !important; }
    
    .theme-light h1, .theme-light h2, .theme-light h3, .theme-light h4 { color: #1f2937 !important; }
    .theme-light table th { color: #1f2937 !important; }
    .theme-light table td { color: #1f2937 !important; }
    .theme-light .font-bold { color: #1f2937 !important; }
    .theme-light .font-semibold { color: #1f2937 !important; }
    .theme-light p, .theme-light span, .theme-light div { color: #1f2937 !important; }
    .theme-light .bg-black.bg-opacity-80 { 
      background-color: rgba(0, 0, 0, 0.8) !important; 
    }
    .theme-light .fixed.inset-0.bg-black.bg-opacity-80 {
      background-color: rgba(0, 0, 0, 0.8) !important;
    }
    .theme-light button[class*="bg-black"] {
    background-color: #000000 !important;
    color: #ffffff !important;
    }

    .theme-light button[class*="bg-gray-800"] {
      background-color: #1f2937 !important;
      color: #ffffff !important;
    }

    .theme-light button[class*="bg-blue-600"] {
      color: #ffffff !important;
    }

    .theme-light button[class*="bg-green-600"] {
      color: #ffffff !important;
    }

    .theme-light button[class*="bg-orange-600"] {
      color: #ffffff !important;
    }

    .theme-light button[class*="bg-red-600"] {
      color: #ffffff !important;
    }

    /* Ícones específicos no tema claro */
    .theme-light [data-lucide="heart"],
    .theme-light [data-lucide="plus"],
    .theme-light [data-lucide="album"],
    .theme-light [data-lucide="plus-circle"] {
      color: #000000 !important;
      stroke: #000000 !important;
    }

    /* Garantir que ícones dentro de badges permaneçam brancos */
    .theme-light .bg-pink-500 [data-lucide] {
      color: #ffffff !important;
      stroke: #ffffff !important;
    }

    /* Estilos para ordenação */
    .sort-button { @apply px-2 py-1 text-xs rounded border; }
    .sort-active { @apply bg-green-500 text-white; }
    .sort-inactive { @apply bg-gray-200 text-gray-700 hover:bg-gray-300; }
    .theme-dark .sort-inactive { @apply bg-gray-600 text-gray-300 hover:bg-gray-500; }
    
    .btn-primary { background-color: #1DB954; color: #FFFFFF; }
    .btn-primary:hover { background-color: #1ED760; }
    .btn-secondary { background-color: #4A4A4A; color: #FFFFFF; }
    .btn-secondary:hover { background-color: #5A5A5A; }
    .btn-primary:disabled, button:disabled { background-color: #555; color: #aaa; cursor: not-allowed; }
    .placeholder-custom::placeholder { color: #888888; }
    [x-cloak] { display: none !important; }
    
    .format-badge { @apply px-2 py-1 text-xs font-semibold rounded-full; }
    .format-cd { @apply bg-blue-500 text-white; }
    .format-vinil { @apply bg-purple-500 text-white; }
    .format-cassete { @apply bg-orange-500 text-white; }
    .format-digital { @apply bg-green-500 text-white; }

    /* Estilos para visualização compartilhada */
    .shared-header {
      background: linear-gradient(135deg, #1DB954, #1ed760);
      color: white;
      padding: 2rem;
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .shared-collection-info {
      background: rgba(29, 185, 84, 0.1);
      border: 1px solid rgba(29, 185, 84, 0.3);
      border-radius: 0.5rem;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    /* Modal de exclusão de conta e outros modais */
    .delete-account-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }
    
    .delete-account-form {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 0.5rem;
      max-width: 28rem;
      width: 100%;
      margin: 1rem;
    }
    
    .theme-dark .delete-account-form { background-color: #1E1E1E; }
    .theme-light .delete-account-form { background-color: #ffffff; }

    /* Modal de aviso para imports grandes */
    .large-import-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 70;
    }

    .large-import-content {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 0.5rem;
      max-width: 28rem;
      width: 100%;
      margin: 1rem;
    }

    .theme-dark .large-import-content { background-color: #1E1E1E; }
    .theme-light .large-import-content { background-color: #ffffff; }

    /* Loading overlay para import modal */
    .import-loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border-radius: 0.5rem;
      padding: 2rem;
    }

    .progress-container {
      width: 100%;
      max-width: 300px;
      margin-bottom: 1rem;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: #374151;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #1DB954, #1ed760);
      border-radius: 4px;
      transition: width 0.3s ease;
      box-shadow: 0 2px 4px rgba(29, 185, 84, 0.3);
    }

    .progress-text {
      text-align: center;
      color: #ffffff;
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .progress-subtitle {
      text-align: center;
      color: #d1d5db;
      font-size: 0.875rem;
    }

/* Lazy Loading de Imagens */
    img[data-src] {
      background: linear-gradient(90deg, #2a2a2a 25%, #333 50%, #2a2a2a 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }

    .theme-light img[data-src] {
      background: linear-gradient(90deg, #e5e7eb 25%, #f3f4f6 50%, #e5e7eb 75%);
      background-size: 200% 100%;
    }

    /* Modal de import mais compacto */
    .import-modal-compact {
      max-width: 90vw;
      max-height: 85vh;
      overflow-y: auto;
    }

    @media (min-width: 769px) {
      .import-modal-compact {
        max-width: 600px;
        max-height: 80vh;
      }
    }

    /* Instruções mais compactas */
    .import-instructions {
      max-height: 150px;
      overflow-y: auto;
    }

    .import-instructions ul {
      columns: 2;
      column-gap: 1rem;
      break-inside: avoid;
    }

    @media (max-width: 768px) {
      .import-instructions ul {
        columns: 1;
      }
    }

    /* Mobile responsivo */
    .mobile-bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--nav-bg);
      border-top: 1px solid var(--border-color);
      z-index: 40;
    }
    
    .theme-dark .mobile-bottom-nav {
      background-color: #1E1E1E;
      border-color: #383838;
    }
    
    .theme-light .mobile-bottom-nav {
      background-color: #ffffff;
      border-color: #e2e8f0;
    }

    .mobile-sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 45;
    }

    .mobile-sidebar {
      position: fixed;
      top: 0;
      left: -100%;
      width: 80%;
      max-width: 300px;
      height: 100%;
      transition: left 0.3s ease;
      z-index: 50;
    }

    .mobile-sidebar.open { left: 0; }

    @media (max-width: 768px) {
      .desktop-sidebar { display: none; }
      .main-content { padding-bottom: 80px; }
      .mobile-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
      }
      .theme-dark .mobile-header { border-color: #383838; }
      .theme-light .mobile-header { border-color: #e2e8f0; }
    }

    @media (min-width: 769px) {
      .mobile-only { display: none !important; }
      .mobile-bottom-nav { display: none; }
    }

    .fab {
      position: fixed;
      bottom: 100px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 30;
    }

    @media (min-width: 769px) { .fab { display: none; } }
    @media (max-width: 768px) {
      .modal-content {
        margin: 1rem;
        max-height: calc(100vh - 2rem);
        overflow-y: auto;
      }

      /* Banner de verificação de email */
        .verification-banner {
        background: linear-gradient(135deg, #10B981, #059669);
        color: white;
        padding: 1.5rem;
        text-align: center;
        }

        /* Tema escuro – mantém como está */
        .theme-dark .btn-secondary {
        background-color: #4A4A4A;
        color: #FFFFFF;
        }
        .theme-dark .btn-secondary:hover {
        background-color: #5A5A5A;
        }

        /* Tema claro – novo estilo */
        .theme-light .btn-secondary {
        background-color: #f1f5f9; /* cor clara */
        color: #1f2937;            /* texto escuro */
        border: 1px solid #e2e8f0; /* opcional */
        transition: background-color 0.2s ease, color 0.2s ease;
        }
        .theme-light .btn-secondary:hover {
        background-color: #e5e7eb; /* hover */
        }
        .theme-light .btn-secondary:disabled {
        background-color: #e5e7eb; /* desabilitado */
        color: #9ca3af; 
        }

        /* Grid responsivo - controle de tamanho das capas */
        @media (min-width: 640px) and (max-width: 768px) {
          /* Mobile landscape / Tablet portrait */
          .grid img.aspect-square {
            max-height: 180px;
            width: 100%;
            object-fit: cover;
          }
        }

        @media (min-width: 1024px) and (max-width: 1280px) {
          /* Desktop médio */
          .grid img.aspect-square {
            max-height: 220px;
            width: 100%;
            object-fit: cover;
          }
        }

        @media (min-width: 1280px) and (max-width: 1536px) {
          /* Desktop grande */
          .grid img.aspect-square {
            max-height: 200px;
            width: 100%;
            object-fit: cover;
          }
        }

        @media (min-width: 1536px) {
          /* Telas muito grandes (2K, 4K) */
          .grid img.aspect-square {
            max-height: 180px;
            width: 100%;
            object-fit: cover;
          }
        }

        /* Mobile landscape específico */
        @media (max-height: 500px) and (orientation: landscape) {
          .grid {
            grid-template-columns: repeat(4, minmax(0, 1fr)) !important;
          }
          
          .grid img.aspect-square {
            max-height: 120px;
          }
          
          .grid .p-2 {
            padding: 0.5rem;
          }
          
          .grid .text-sm {
            font-size: 0.75rem;
          }
        }

    }
  </style>
</head>
<body x-data="app" x-init="init()" x-cloak :class="`theme-${darkMode ? 'dark' : 'light'}`">

  <!-- Loading -->
  <div x-show="loading" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="flex flex-col items-center text-center p-4">
      <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
      <p class="text-white mt-4 text-lg">Carregando...</p>
    </div>
  </div>

  <!-- Notificação -->
  <div x-show="notification.show"
     class="fixed top-5 right-5 z-[9999] p-4 rounded-md shadow-lg text-white max-w-sm"
       :class="{'bg-green-600': notification.type === 'success', 'bg-red-600': notification.type === 'error', 'bg-blue-600': notification.type === 'info'}"
       x-transition>
    <p x-text="notification.message"></p>
  </div>

  <!-- Banner de Verificação de Email -->
    <div x-show="showEmailVerification && !loading && !isSharedView" class="verification-banner">
    <div class="max-w-2xl mx-auto">
        <div class="flex items-center justify-center space-x-3 mb-4">
        <i data-lucide="mail" class="w-8 h-8"></i>
        <h2 class="text-2xl font-bold">Verifique seu Email</h2>
        </div>
        <p class="mb-4">
        Enviamos um email de verificação para <strong x-text="user?.email"></strong>
        </p>
        <p class="text-sm mb-6">
        Por favor, verifique sua caixa de entrada (e spam) e clique no link de verificação.
        </p>
        <div class="flex flex-col md:flex-row gap-4 justify-center">
        <button @click="checkEmailVerification()" 
                class="px-6 py-3 bg-white text-green-600 rounded-lg font-medium hover:bg-gray-100">
            Já Verifiquei - Verificar Agora
        </button>
        <button @click="sendEmailVerification()" 
                :disabled="verificationSent"
                class="px-6 py-3 bg-green-800 hover:bg-green-900 text-white rounded-lg font-medium disabled:opacity-50">
            <span x-show="!verificationSent">Reenviar Email</span>
            <span x-show="verificationSent">Email Enviado ✓</span>
        </button>
        </div>
        <button @click="auth.signOut()" 
                class="mt-4 text-sm underline hover:no-underline">
        Sair e usar outra conta
        </button>
    </div>
    </div>

  <!-- Visualização de Coleção Compartilhada -->
  <div x-show="isSharedView && !loading">
    <div class="shared-header">
      <div class="flex items-center justify-center space-x-3 mb-4">
        <i data-lucide="disc-3" class="text-4xl"></i>
        <h1 class="text-3xl font-bold">Katalog</h1>
      </div>
      <div x-show="sharedCollection.owner">
        <h2 class="text-xl mb-2">Coleção de <span x-text="sharedCollection.owner?.displayName || sharedCollection.owner?.email || 'Usuário'"></span></h2>
        <p class="opacity-90">
          <span x-text="sharedCollection.records?.length || 0"></span> itens na coleção
        </p>
      </div>
    </div>

    <div class="container mx-auto px-4 pb-8">
      <!-- Informações sobre a visualização -->
      <div class="shared-collection-info mb-6">
        <div class="flex items-center space-x-2 text-green-700">
          <i data-lucide="eye" class="w-4 h-4"></i>
          <span class="text-sm font-medium">Você está visualizando uma coleção compartilhada</span>
        </div>
      </div>

      <!-- Botão para criar sua própria conta -->
      <div class="text-center mb-8">
        <p class="text-muted mb-4">Gostou desta coleção? Crie sua própria conta no Katalog!</p>
        <button @click="goToLogin()" 
              class="px-6 py-3 btn-primary rounded-lg font-medium"
              :class="{'!bg-black !text-white hover:!bg-gray-800': !darkMode}">
        Criar Minha Conta
      </button>
      </div>

      <!-- Busca (somente leitura) -->
      <div class="mb-6">
        <input x-model="sharedSearchFilter" @input="filterSharedCollection()" 
               placeholder="Buscar nesta coleção..." 
               class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
      </div>

     <!-- Controles de visualização -->
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold">
            Itens (<span x-text="filteredSharedCollection.length"></span>)
          </h3>
          <div class="flex space-x-2">
            <button @click="sharedViewMode = 'grid'" 
                    :class="sharedViewMode === 'grid' ? 'btn-primary' : 'btn-secondary'"
                    class="px-4 py-2 rounded-md">
              <i data-lucide="grid-3x3" class="w-4 h-4"></i>
            </button>
            <button @click="sharedViewMode = 'list'" 
                    :class="sharedViewMode === 'list' ? 'btn-primary' : 'btn-secondary'"
                    class="px-4 py-2 rounded-md">
              <i data-lucide="list" class="w-4 h-4"></i>
            </button>
          </div>
        </div>

      <!-- Grid View Compartilhada -->
      <div x-show="sharedViewMode === 'grid' && displayedSharedCollection.length > 0" 
     class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-7 gap-3 md:gap-4 lg:gap-5">
        <template x-for="record in displayedSharedCollection" :key="record.id">
          <div class="bg-card rounded-lg overflow-hidden shadow-lg relative">
            <img :src="record.cover_url || `https://placehold.co/300x300/1E1E1E/E0E0E0?text=${record.album ? record.album.charAt(0) : 'A'}`"
              :alt="record.album || 'Álbum'"
              class="w-full aspect-square object-cover cursor-pointer hover:opacity-90 transition-opacity"
              @click="showAlbumDetails(record)">
            <div class="absolute top-2 left-2">
              <span :class="'format-' + ((record.format || 'CD').toLowerCase())" 
                    class="format-badge text-xs" x-text="record.format || 'CD'"></span>
            </div>
            <div class="p-2 md:p-3">
              <h3 class="font-bold text-sm md:text-base truncate" x-text="record.album || 'Sem título'"></h3>
              <p class="text-xs md:text-sm text-muted truncate" x-text="record.artist || 'Artista desconhecido'"></p>
              <p x-show="record.year" class="text-xs text-muted" x-text="record.year"></p>
            </div>
          </div>
        </template>
      </div>


<!-- List View Compartilhada -->
<div x-show="sharedViewMode === 'list' && displayedSharedCollection.length > 0" 
     class="bg-card rounded-lg overflow-hidden shadow-lg">
  
  <!-- Mobile List View -->
  <div class="md:hidden">
    <template x-for="record in displayedSharedCollection" :key="record.id">
      <div class="border-b border-custom p-4 flex items-center space-x-3">
        <img :data-src="record.cover_url || `https://placehold.co/60x60/1E1E1E/E0E0E0?text=${record.album ? record.album.charAt(0) : 'A'}`"
            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 60'%3E%3C/svg%3E"
            :alt="record.album || 'Álbum'"
            class="w-12 h-12 object-cover rounded cursor-pointer hover:opacity-90 transition-opacity"
            @click="showAlbumDetails(record)">
        <div class="flex-1 min-w-0">
          <h3 class="font-semibold text-sm truncate" x-text="record.album || 'Sem título'"></h3>
          <p class="text-xs text-muted truncate" x-text="record.artist || 'Artista desconhecido'"></p>
          <div class="flex items-center space-x-2 mt-1">
            <span :class="'format-' + ((record.format || 'CD').toLowerCase())" 
                  class="format-badge text-xs" x-text="record.format || 'CD'"></span>
            <span x-show="record.year" class="text-xs text-muted" x-text="record.year"></span>
          </div>
        </div>
      </div>
    </template>
  </div>

      <!-- Desktop Table View Compartilhada -->
      <table class="w-full hidden md:table">
        <thead class="bg-input">
          <tr>
            <th class="text-left p-4 font-semibold">Capa</th>
            <th class="text-left p-4 font-semibold">Álbum</th>
            <th class="text-left p-4 font-semibold">Artista</th>
            <th class="text-left p-4 font-semibold">Formato</th>
            <th class="text-left p-4 font-semibold">Ano</th>
          </tr>
        </thead>
        <tbody>
          <template x-for="record in displayedSharedCollection" :key="record.id">
            <tr class="border-b border-custom hover:bg-input">
              <td class="p-4">
                <img :src="record.cover_url || `https://placehold.co/60x60/1E1E1E/E0E0E0?text=${record.album ? record.album.charAt(0) : 'A'}`"
                  :alt="record.album || 'Álbum'"
                  class="w-12 h-12 object-cover rounded cursor-pointer hover:opacity-90 transition-opacity"
                  @click="showAlbumDetails(record)">
              </td>
              <td class="p-4 font-semibold" x-text="record.album || 'Sem título'"></td>
              <td class="p-4" x-text="record.artist || 'Artista desconhecido'"></td>
              <td class="p-4">
                <span :class="'format-' + ((record.format || 'CD').toLowerCase())" 
                      class="format-badge" x-text="record.format || 'CD'"></span>
              </td>
              <td class="p-4" x-text="record.year || '-'"></td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
    
    <!-- Controles de Paginação Compartilhada -->
    <div x-show="filteredSharedCollection.length > 0 && sharedPagination.totalPages > 1" 
         class="flex justify-center items-center space-x-4 mt-8">
      
      <button @click="sharedPagination.currentPage = Math.max(1, sharedPagination.currentPage - 1)" 
              :disabled="sharedPagination.currentPage === 1"
              class="px-4 py-2 btn-secondary rounded-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2">
        <i data-lucide="chevron-left" class="w-4 h-4"></i>
        <span>Anterior</span>
      </button>
      
      <div class="flex items-center space-x-2">
        <span class="text-sm text-muted">Página</span>
        <span class="font-bold" x-text="sharedPagination.currentPage"></span>
        <span class="text-sm text-muted">de</span>
        <span class="font-bold" x-text="sharedPagination.totalPages"></span>
      </div>
      
      <button @click="sharedPagination.currentPage = Math.min(sharedPagination.totalPages, sharedPagination.currentPage + 1)" 
              :disabled="sharedPagination.currentPage === sharedPagination.totalPages"
              class="px-4 py-2 btn-secondary rounded-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2">
        <span>Próxima</span>
        <i data-lucide="chevron-right" class="w-4 h-4"></i>
      </button>
    </div>
    
    <!-- Info de paginação -->
    <div x-show="filteredSharedCollection.length > 0" class="text-center mt-4">
      <p class="text-sm text-muted">
        Mostrando <span x-text="displayedSharedCollection.length"></span> de 
        <span x-text="filteredSharedCollection.length"></span> itens 
        (Página <span x-text="sharedPagination.currentPage"></span> de <span x-text="sharedPagination.totalPages"></span>)
      </p>
    </div>

      <!-- Empty State -->
      <div x-show="filteredSharedCollection.length === 0" class="text-center py-20 bg-card rounded-lg">
        <i data-lucide="folder-x" class="mx-auto h-16 w-16 text-muted mb-4"></i>
        <h3 class="text-xl font-semibold" x-text="sharedSearchFilter ? 'Nenhum item encontrado' : 'Coleção vazia'"></h3>
        <p class="text-muted mt-2" x-text="sharedSearchFilter ? 'Tente uma busca diferente' : 'Esta coleção ainda não possui itens'"></p>
      </div>
    </div>
  </div>

  <!-- Mobile Sidebar Overlay (apenas para usuários logados) -->
  <div x-show="showMobileSidebar && isMobile && !isSharedView" class="mobile-sidebar-overlay mobile-only" @click="showMobileSidebar = false"></div>

  <!-- Mobile Sidebar (apenas para usuários logados) -->
  <aside x-show="showMobileSidebar && isMobile && !isSharedView" class="mobile-sidebar bg-black mobile-only" :class="{'open': showMobileSidebar}">
    <div class="p-4 flex items-center justify-between border-b border-custom">
      <div class="flex items-center space-x-2">
        <i data-lucide="disc-3" class="text-green-400"></i>
        <h1 class="text-xl font-bold text-white">Katalog</h1>
      </div>
      <button @click="showMobileSidebar = false" class="text-white">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
    </div>
    <nav class="flex-1 p-4 space-y-2">
      <a href="#" @click.prevent="currentView = 'collection'; showMobileSidebar = false" 
         :class="{'bg-green-500 text-white': currentView === 'collection'}"
         class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-white">
         <i data-lucide="album"></i><span>Minha Coleção</span>
      </a>
      <a href="#" @click.prevent="currentView = 'add-record'; showMobileSidebar = false" 
         :class="{'bg-green-500 text-white': currentView === 'add-record'}"
         class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-white">
         <i data-lucide="plus-circle"></i><span>Adicionar Item</span>
      </a>
      <a href="#" @click.prevent="currentView = 'wishlist'; showMobileSidebar = false" 
        :class="{'bg-green-500 text-white': currentView === 'wishlist'}"
        class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-white">
        <i data-lucide="heart"></i><span>Lista de Desejos</span>
      </a>
      <button @click="configModal = true; configActiveTab = 'share'; showMobileSidebar = false" 
              class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-blue-300">
        <i data-lucide="share-2"></i><span>Compartilhar</span>
      </button>
      <button @click="importModal.show = true; showMobileSidebar = false" 
              class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-blue-300">
        <i data-lucide="upload"></i><span>Importar Excel</span>
      </button>
      <button @click="startAutoCoverSearch(); showMobileSidebar = false" 
        :disabled="collection.length === 0"
        class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-purple-300 disabled:text-gray-500 disabled:cursor-not-allowed">
      <i data-lucide="image"></i><span>Buscar Capas</span>
      </button>
      <button @click="autoCorrectArtistNames(); showMobileSidebar = false" 
              :disabled="collection.length === 0"
              class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-yellow-300 disabled:text-gray-500 disabled:cursor-not-allowed">
        <i data-lucide="user-check"></i><span>Corrigir Nomes</span>
      </button>
      <button @click="fillMissingYears(); showMobileSidebar = false" 
              :disabled="collection.length === 0"
              class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-cyan-300 disabled:text-gray-500 disabled:cursor-not-allowed">
        <i data-lucide="calendar"></i><span>Buscar Anos</span>
      </button>
    </nav>
    <div class="p-4 border-t border-custom space-y-2">
      <div class="px-3 py-2 text-xs text-gray-400 break-words">
        <span x-text="user?.email"></span>
      </div>
      <button @click="configModal = true; showMobileSidebar = false" 
              class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-white">
        <i data-lucide="settings"></i><span>Configurações</span>
      </button>
      <button @click="confirmLogout()" 
              class="w-full flex items-center space-x-3 px-3 py-2 rounded-md bg-red-600/50 hover:bg-red-800 text-white">
        <i data-lucide="log-out"></i><span>Sair</span>
      </button>
    </div>
  </aside>

<!-- Modal Detalhes do Álbum -->
<div x-show="albumDetailsModal.show" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="albumDetailsModal.show = false">
  <div class="bg-card rounded-lg max-w-3xl w-full modal-content">
    <div class="relative">
      <!-- Header com fundo da capa -->
      <div class="relative h-32 md:h-40 rounded-t-lg overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent z-10"></div>
        <img :src="albumDetailsModal.record?.cover_url || `https://placehold.co/600x400/1E1E1E/E0E0E0?text=${albumDetailsModal.record?.album?.charAt(0) || 'A'}`" 
             class="w-full h-full object-cover blur-sm scale-110">
        <button @click="albumDetailsModal.show = false" 
                class="absolute top-4 right-4 z-20 bg-black/50 hover:bg-black/70 text-white rounded-full p-2">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      
      <!-- Conteúdo -->
      <div class="p-6">
        <div class="flex flex-col md:flex-row gap-6">
          <!-- Capa -->
          <div class="flex-shrink-0 mx-auto md:mx-0">
            <img :src="albumDetailsModal.record?.cover_url || `https://placehold.co/200x200/1E1E1E/E0E0E0?text=${albumDetailsModal.record?.album?.charAt(0) || 'A'}`" 
            class="w-32 h-32 md:w-40 md:h-40 object-cover rounded-lg shadow-lg">
          </div>
          
        <!-- Informações -->
        <div class="flex-1 space-y-3">
          <div>
            <h2 class="text-xl md:text-2xl font-bold" x-text="albumDetailsModal.record?.album"></h2>
            <p class="text-base text-muted" x-text="albumDetailsModal.record?.artist"></p>
          </div>
            
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span class="font-semibold">Formato:</span>
                <span :class="'format-' + (albumDetailsModal.record?.format?.toLowerCase() || 'cd')" 
                      class="format-badge ml-2" x-text="albumDetailsModal.record?.format"></span>
              </div>
              <div x-show="albumDetailsModal.record?.year">
                <span class="font-semibold">Ano:</span>
                <span x-text="albumDetailsModal.record?.year" class="ml-2"></span>
              </div>
              <div x-show="albumDetailsModal.record?.catalog_number" class="col-span-2">
                <span class="font-semibold">Catálogo:</span>
                <span x-text="albumDetailsModal.record?.catalog_number" class="ml-2"></span>
              </div>
            </div>
            
            <div x-show="albumDetailsModal.record?.description" class="bg-input p-4 rounded-lg">
              <h4 class="font-semibold mb-2">Descrição:</h4>
              <p class="text-sm text-muted whitespace-pre-wrap" x-text="albumDetailsModal.record?.description"></p>
            </div>
            
            <!-- Links de busca -->
            <div class="border-t border-custom pt-4">
              <h4 class="font-semibold mb-3">Buscar online:</h4>
              <div class="flex flex-wrap gap-2">
                <button @click="searchOnService('youtube')" 
                        class="flex items-center space-x-2 px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md text-sm">
                  <i data-lucide="play" class="w-4 h-4"></i>
                  <span>YouTube</span>
                </button>
                <button @click="searchOnService('spotify')" 
                        class="flex items-center space-x-2 px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md text-sm">
                  <i data-lucide="headphones" class="w-4 h-4"></i>
                  <span>Spotify</span>
                </button>
                <button @click="searchOnService('apple')" 
                        class="flex items-center space-x-2 px-3 py-2 bg-gray-800 hover:bg-gray-900 text-white rounded-md text-sm">
                  <i data-lucide="music" class="w-4 h-4"></i>
                  <span>Apple Music</span>
                </button>
                <button @click="searchOnService('rateyourmusic')" 
                        class="flex items-center space-x-2 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm">
                  <i data-lucide="star-half" class="w-4 h-4"></i>
                  <span>Rate Your Music</span>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Botões de ação -->
        <div x-show="!isSharedView" class="flex justify-end space-x-3 mt-6 pt-4 border-t border-custom">
          <button x-show="albumDetailsModal.record?.isWishlist || wishlist.some(w => w.id === albumDetailsModal.record?.id)" 
                  @click="moveToCollection(albumDetailsModal.record)" 
                  class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md flex items-center space-x-2">
            <i data-lucide="check" class="w-4 h-4"></i>
            <span>Adquirido</span>
          </button>
          <button @click="editRecord(albumDetailsModal.record)" 
                  class="px-4 py-2 btn-primary rounded-md flex items-center space-x-2">
            <i data-lucide="edit" class="w-4 h-4"></i>
            <span>Editar</span>
          </button>
          <button @click="confirmDeleteRecord(albumDetailsModal.record?.id)" 
                  class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-md flex items-center space-x-2">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
            <span>Excluir</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Recuperação de Senha -->
<div x-show="showForgotPassword && !isSharedView" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="closeForgotPassword()">
  <div class="bg-card p-8 rounded-lg max-w-md w-full mx-4">
    <h3 class="text-2xl font-bold mb-6">Recuperar Senha</h3>
    
    <div x-show="!resetEmailSent">
      <p class="text-sm text-muted mb-4">
        Digite seu email e enviaremos um link para redefinir sua senha.
      </p>
      <input x-model="resetEmail" type="email" placeholder="seu@email.com" 
             class="w-full p-3 bg-input border border-custom rounded-md mb-4">
      <div class="flex space-x-4">
        <button @click="sendPasswordReset()" 
                :disabled="authLoading"
                class="flex-1 py-3 btn-primary rounded-md">
          <span x-show="!authLoading">Enviar Link</span>
          <span x-show="authLoading">Enviando...</span>
        </button>
        <button @click="closeForgotPassword()" 
                class="px-6 py-3 btn-secondary rounded-md">
          Cancelar
        </button>
      </div>
    </div>
    
    <div x-show="resetEmailSent" class="text-center">
      <i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto mb-4"></i>
      <h4 class="text-xl font-bold mb-2">Email Enviado!</h4>
      <p class="text-sm text-muted mb-6">
        Verifique sua caixa de entrada e siga as instruções para redefinir sua senha.
      </p>
      <button @click="closeForgotPassword()" 
              class="px-8 py-3 btn-primary rounded-md">
        Fechar
      </button>
    </div>
  </div>
</div>

<!-- Modal Configurações -->
<div x-show="configModal && !isSharedView" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
  <div class="bg-card rounded-lg max-w-2xl w-full modal-content">
    <div class="p-6">
      <h3 class="text-xl font-bold mb-6">Configurações da Conta</h3>
      
      <!-- Tabs Navigation -->
      <div class="flex border-b border-custom mb-6 overflow-x-auto">
        <button @click="configActiveTab = 'user'" 
                :class="configActiveTab === 'user' ? 'border-green-500 text-green-500' : 'border-transparent'"
                class="px-4 py-2 border-b-2 font-medium whitespace-nowrap">
          <i data-lucide="user" class="w-4 h-4 inline mr-2"></i>Usuário
        </button>
        <button @click="configActiveTab = 'share'" 
                :class="configActiveTab === 'share' ? 'border-green-500 text-green-500' : 'border-transparent'"
                class="px-4 py-2 border-b-2 font-medium whitespace-nowrap">
          <i data-lucide="share-2" class="w-4 h-4 inline mr-2"></i>Compartilhar
        </button>
        <button @click="configActiveTab = 'misc'" 
                :class="configActiveTab === 'misc' ? 'border-green-500 text-green-500' : 'border-transparent'"
                class="px-4 py-2 border-b-2 font-medium whitespace-nowrap">
          <i data-lucide="settings" class="w-4 h-4 inline mr-2"></i>Geral
        </button>
      </div>

      <!-- Tab Content -->
      <div class="space-y-6 max-h-96 overflow-y-auto">
        
        <!-- ABA USUÁRIO -->
        <div x-show="configActiveTab === 'user'" class="space-y-4">
          <!-- Alterar Nome -->
          <div class="bg-input p-4 rounded-lg">
            <h4 class="font-semibold mb-3">Alterar Nome</h4>
            <div class="space-y-2">
              <input x-model="newDisplayName" placeholder="Digite o novo nome"
                     class="w-full p-2 bg-card border border-custom rounded-md text-sm">
              <button @click="updateDisplayName()" :disabled="!newDisplayName?.trim()"
                      class="w-full py-2 btn-primary rounded-md text-sm">Salvar</button>
            </div>
          </div>

          <!-- Alterar Senha -->
          <div class="bg-input p-4 rounded-lg">
            <h4 class="font-semibold mb-3">Alterar Senha</h4>
            <button @click="changePasswordModal = true"
                    class="w-full py-2 btn-primary rounded-md text-sm">
              Alterar Senha
            </button>
          </div>

          <!-- Informações da Conta -->
          <div class="bg-input p-4 rounded-lg">
            <h4 class="font-semibold mb-3">Conta</h4>
            <div class="space-y-1 text-sm text-muted">
              <div><span class="font-medium">Email:</span> <span x-text="user?.email"></span></div>
              <div><span class="font-medium">Nome:</span> <span x-text="user?.displayName || 'Não definido'"></span></div>
            </div>
          </div>

          <!-- Zona de Perigo -->
          <div class="bg-red-900/20 border border-red-500/30 p-4 rounded-lg">
            <h4 class="text-red-400 font-semibold mb-2">Zona de Perigo</h4>
            <button @click="confirmDeleteAccount()" 
                    class="w-full py-2 px-4 bg-red-700 hover:bg-red-800 text-white rounded-md text-sm">
              Excluir Conta
            </button>
          </div>
        </div>

        <!-- ABA COMPARTILHAR -->
        <div x-show="configActiveTab === 'share'" class="space-y-4">
          <!-- Toggle Público/Privado -->
          <div class="bg-input p-4 rounded-lg">
            <h4 class="font-semibold mb-3">Visibilidade</h4>
            <div class="flex items-center justify-between">
              <span class="text-sm">Coleção Pública</span>
              <button @click="toggleCollectionPrivacy()" 
                      :disabled="privacyUpdateLoading"
                      class="relative inline-flex h-6 w-11 items-center rounded-full"
                      :class="collectionIsPublic ? 'bg-green-600' : 'bg-gray-400'">
                <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"
                      :class="collectionIsPublic ? 'translate-x-6' : 'translate-x-1'"></span>
              </button>
            </div>
          </div>

          <!-- URL e QR Code -->
          <div x-show="collectionIsPublic" class="bg-input p-4 rounded-lg space-y-4">
            <div>
              <label class="text-sm font-medium mb-2 block">Link da Coleção:</label>
              <div class="flex items-center space-x-2">
                <input :value="shareUrl" readonly 
                       class="flex-1 p-2 bg-card border border-custom rounded text-xs">
                <button @click="copyShareUrl()" 
                        class="px-3 py-2 btn-primary rounded text-xs">
                  <i data-lucide="copy" class="w-4 h-4"></i>
                </button>
              </div>
            </div>

            <!-- QR Code -->
            <div class="text-center">
              <label class="text-sm font-medium mb-2 block">QR Code:</label>
              <div id="qrcode" class="inline-block p-4 bg-white rounded-lg"></div>
              <button @click="generateQRCode()" 
                      class="mt-2 px-4 py-2 btn-secondary rounded text-sm">
                Gerar QR Code
              </button>
            </div>

            <!-- Botões de Compartilhamento -->
            <div>
              <label class="text-sm font-medium mb-2 block">Compartilhar em:</label>
              <div class="grid grid-cols-2 gap-2">
                <button @click="shareOnPlatform('facebook')" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm flex items-center justify-center space-x-2">
                  <i data-lucide="facebook" class="w-4 h-4"></i>
                  <span>Facebook</span>
                </button>
                <button @click="shareOnPlatform('twitter')" 
                        class="px-4 py-2 bg-black hover:bg-gray-800 text-white rounded text-sm flex items-center justify-center space-x-2">
                  <i data-lucide="twitter" class="w-4 h-4"></i>
                  <span>X (Twitter)</span>
                </button>
                <button @click="shareOnPlatform('reddit')" 
                        class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded text-sm flex items-center justify-center space-x-2">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z"/>
                  </svg>
                  <span>Reddit</span>
                </button>
                <button @click="shareOnPlatform('whatsapp')" 
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm flex items-center justify-center space-x-2">
                  <i data-lucide="message-circle" class="w-4 h-4"></i>
                  <span>WhatsApp</span>
                </button>
              </div>
            </div>

            <!-- Botão Share Nativo Mobile -->
            <button @click="shareNative()" 
                    class="w-full md:hidden px-4 py-2 btn-primary rounded text-sm flex items-center justify-center space-x-2">
              <i data-lucide="share-2" class="w-4 h-4"></i>
              <span>Compartilhar</span>
            </button>
          </div>

          <!-- Aviso quando privado -->
          <div x-show="!collectionIsPublic" class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
            <p class="text-sm text-blue-300">
              <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
              Ative a coleção pública para compartilhar com outras pessoas
            </p>
          </div>
        </div>

        <!-- ABA GERAL -->
        <div x-show="configActiveTab === 'misc'" class="space-y-4">
          <!-- Tema -->
          <div class="bg-input p-4 rounded-lg">
            <h4 class="font-semibold mb-3">Tema</h4>
            <div class="flex items-center justify-between">
              <span class="text-sm">Modo Escuro</span>
              <button @click="toggleTheme()" 
                      class="relative inline-flex h-6 w-11 items-center rounded-full"
                      :class="darkMode ? 'bg-green-600' : 'bg-gray-400'">
                <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"
                      :class="darkMode ? 'translate-x-6' : 'translate-x-1'"></span>
              </button>
            </div>
          </div>

          <!-- Backup -->
          <div class="bg-input p-4 rounded-lg">
            <h4 class="font-semibold mb-3">Backup</h4>
            <button @click="exportToExcel()" 
                    :disabled="collection.length === 0"
                    class="w-full py-2 px-4 btn-primary rounded-md text-sm disabled:bg-gray-600 disabled:cursor-not-allowed">
              <div class="flex items-center justify-center space-x-2">
                <i data-lucide="download" class="w-4 h-4"></i>
                <span>Exportar Excel</span>
              </div>
            </button>
          </div>
        </div>

      </div>
      
      <!-- Footer -->
      <div class="flex justify-end mt-6 pt-4 border-t border-custom">
        <button @click="configModal = false; configActiveTab = 'user'" 
                class="px-6 py-2 btn-secondary rounded-md">Fechar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Confirmação de Exclusão de Conta -->
  <div x-show="deleteAccountModal.show && !isSharedView" class="delete-account-modal">
    <div class="delete-account-form">
      <div class="text-center mb-6">
        <i data-lucide="alert-triangle" class="mx-auto h-16 w-16 text-red-500 mb-4"></i>
        <h3 class="text-xl font-bold text-red-400 mb-2">Excluir Conta Permanentemente</h3>
        <p class="text-sm text-muted">Esta ação não pode ser desfeita. Todos os seus dados serão perdidos.</p>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Confirme seu email:</label>
          <input x-model="deleteAccountModal.email" type="email" 
                 class="w-full p-3 bg-input border border-custom rounded-md"
                 placeholder="Digite seu email">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Confirme sua senha:</label>
          <input x-model="deleteAccountModal.password" type="password" 
                 class="w-full p-3 bg-input border border-custom rounded-md"
                 placeholder="Digite sua senha">
        </div>
        
        <div class="bg-red-900/20 border border-red-500/30 rounded-lg p-4">
          <label class="flex items-center space-x-2">
            <input x-model="deleteAccountModal.confirmed" type="checkbox" class="rounded">
            <span class="text-sm">Eu entendo que esta ação é irreversível e todos os meus dados serão perdidos</span>
          </label>
        </div>
      </div>
      
      <div class="flex space-x-4 mt-6">
        <button @click="proceedDeleteAccount()" 
                :disabled="!deleteAccountModal.email || !deleteAccountModal.password || !deleteAccountModal.confirmed || deleteAccountModal.loading"
                class="flex-1 py-3 bg-red-700 hover:bg-red-800 disabled:bg-gray-600 text-white rounded-md">
          <span x-show="!deleteAccountModal.loading">Excluir Conta</span>
          <span x-show="deleteAccountModal.loading">Excluindo...</span>
        </button>
        <button @click="cancelDeleteAccount()" 
                class="px-6 py-3 btn-secondary rounded-md">
          Cancelar
        </button>
      </div>
    </div>
  </div>
  
  <!-- Modal Alterar Senha -->
    <div x-show="changePasswordModal && !isSharedView" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="bg-card p-6 rounded-lg max-w-md w-full">
        <div class="text-center mb-6">
        <i data-lucide="lock" class="mx-auto h-16 w-16 text-primary mb-4"></i>
        <h3 class="text-xl font-bold mb-2">Alterar Senha</h3>
        <p class="text-sm text-muted">Digite sua senha atual e a nova senha abaixo.</p>
        </div>

        <div class="space-y-4">
        <input x-model="currentPassword" type="password" placeholder="Senha atual"
                class="w-full p-3 bg-input border border-custom rounded-md">
        <input x-model="newPassword" type="password" placeholder="Nova senha (mín. 8 caracteres)"
                class="w-full p-3 bg-input border border-custom rounded-md">
        <input x-model="confirmNewPassword" type="password" placeholder="Confirme a nova senha"
                class="w-full p-3 bg-input border border-custom rounded-md">
        </div>

        <div class="flex space-x-4 mt-6">
        <button @click="updatePassword()" 
                :disabled="!currentPassword || !newPassword || !confirmNewPassword || passwordUpdateLoading"
                class="flex-1 py-3 btn-primary rounded-md">
            <span x-show="!passwordUpdateLoading">Salvar</span>
            <span x-show="passwordUpdateLoading">Alterando...</span>
        </button>
        <button @click="changePasswordModal = false"
                class="px-6 py-3 btn-secondary rounded-md">
            Cancelar
        </button>
        </div>
    </div>
    </div>


  <!-- Modal Import Excel -->
<div x-show="importModal.show && !isSharedView" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4" @click.self="importModal.show = false">
  <div class="bg-card rounded-lg w-full import-modal-compact relative">
    
    <!-- Loading overlay com barra de progresso -->
    <div x-show="importModal.loading" class="import-loading-overlay">
      <div class="progress-container">
        <div class="progress-text" x-text="`${importModal.progress}%`"></div>
        <div class="progress-bar">
          <div class="progress-fill" :style="`width: ${importModal.progress}%`"></div>
        </div>
        <div class="progress-subtitle" x-text="importModal.progressText"></div>
      </div>
    </div>
    
    <!-- Header -->
    <div class="p-4 md:p-6 border-b border-custom">
      <div class="flex justify-between items-center">
        <h3 class="text-xl font-bold">Importar do Excel</h3>
        <button @click="closeImportModal()" class="text-gray-500 hover:text-gray-700 p-1">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
    </div>
    
    <!-- Content -->
    <div class="p-4 md:p-6 space-y-4">
      
      <!-- Instruções compactas -->
      <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-3">
        <h4 class="font-semibold text-blue-300 mb-2 text-sm">Colunas do Excel:</h4>
        <div class="import-instructions">
          <ul class="text-xs text-blue-200 space-y-1">
            <li>• <strong>album</strong> - Nome do álbum *</li>
            <li>• <strong>artist</strong> - Nome do artista *</li>
            <li>• <strong>format</strong> - CD/Vinil/Cassete/Digital *</li>
            <li>• <strong>year</strong> - Ano de lançamento</li>
            <li>• <strong>catalog_number</strong> - Número de catálogo</li>
            <li>• <strong>cover_url</strong> - URL da capa</li>
            <li>• <strong>description</strong> - Descrição/observações</li>
          </ul>
        </div>
        <p class="text-xs text-blue-300 mt-2">* = obrigatório</p>
      </div>
      
      <!-- Upload -->
      <div>
        <label class="block text-sm font-medium mb-2">Arquivo Excel:</label>
        <input type="file" @change="handleFileUpload($event)" 
               accept=".xlsx,.xls,.csv" 
               class="w-full p-2 bg-input border border-custom rounded-md text-sm">
      </div>
      
      <!-- Preview compacto -->
      <div x-show="importModal.preview.length > 0">
        <h4 class="font-semibold mb-2 text-sm">Preview:</h4>
        <div class="bg-input rounded-lg p-3 max-h-32 overflow-y-auto">
          <template x-for="item in importModal.preview.slice(0, 2)" :key="item.album">
            <div class="text-xs mb-2 last:mb-0">
              <div class="font-semibold">
                <span x-text="item.album"></span> - <span x-text="item.artist"></span>
              </div>
              <div class="text-muted">
                <span x-text="item.format"></span>
                <span x-show="item.year"> • <span x-text="item.year"></span></span>
              </div>
            </div>
          </template>
        </div>
        <p class="text-xs text-muted mt-1" x-text="`Total: ${importModal.data.length} itens`"></p>
      </div>
    </div>

    <!-- Modal Import Verificação (Contas não verificadas) -->
<div x-show="!user?.emailVerified && !isSharedView" 
     class="bg-orange-900/20 border border-orange-500/30 rounded-lg p-2 mb-3 mx-6">
  <div class="flex items-start space-x-3">
    <i data-lucide="alert-triangle" class="w-5 h-5 text-orange-400 flex-shrink-0 mt-0.5"></i>
    <div class="flex-1">
      <h4 class="font-semibold text-orange-300 mb-1">Conta não verificada - Limites aplicados</h4>
      
      <!-- Mostrar status atual -->
      <div x-show="!importTracking.isBlocked" class="space-y-2">
        <p class="text-sm text-orange-200">
          Você pode importar até <strong>100 registros</strong> por vez.
        </p>
        <div class="bg-orange-950/50 rounded p-2">
          <div class="flex justify-between text-xs text-orange-300 mb-1">
            <span>Importações realizadas:</span>
            <span><strong x-text="importTracking.importCount"></strong> de 2</span>
          </div>
          <div class="w-full bg-orange-950 rounded-full h-2">
            <div class="bg-orange-500 h-2 rounded-full transition-all" 
                 :style="`width: ${(importTracking.importCount / 2) * 100}%`"></div>
          </div>
          <p class="text-xs text-orange-400 mt-1">
            Total importado: <strong x-text="importTracking.totalImported"></strong> registros
          </p>
        </div>
      </div>
      
      <!-- Aviso de bloqueio -->
      <div x-show="importTracking.isBlocked" class="space-y-2">
        <p class="text-sm text-orange-200 font-semibold">
          Você atingiu o limite de 2 importações. Verifique seu email para continuar importando!
        </p>
      </div>
      
      <button @click="importModal.show = false; checkEmailVerification()" 
              class="mt-3 px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded text-sm">
        Verificar Email Agora
      </button>
    </div>
  </div>
</div>
    
    <!-- Footer com botões -->
    <div class="p-4 md:p-6 border-t border-custom">
      <div class="flex flex-col sm:flex-row gap-3">
        <button @click="importRecords()" :disabled="importModal.data.length === 0 || importModal.loading" 
                class="flex-1 py-2 px-4 btn-primary rounded-md text-sm">
          <span x-show="!importModal.loading">Importar Coleção</span>
          <span x-show="importModal.loading">Importando...</span>
        </button>
        <button @click="closeImportModal()" class="px-4 py-2 btn-secondary rounded-md text-sm">
          Cancelar
        </button>
      </div>
    </div>
    
  </div>
</div>

<!-- Modal de Aviso para Import Grande -->
  <div x-show="largeImportModal.show && !isSharedView" class="large-import-modal">
    <div class="large-import-content">
      <div class="text-center mb-6">
        <i data-lucide="alert-triangle" class="mx-auto h-16 w-16 text-orange-500 mb-4"></i>
        <h3 class="text-xl font-bold text-orange-400 mb-2">Import Grande Detectado</h3>
        <p class="text-sm text-muted">
          Você está importando <strong x-text="largeImportModal.totalItems"></strong> itens.
        </p>
      </div>
      
      <div class="bg-orange-900/20 border border-orange-500/30 rounded-lg p-4 mb-6">
        <h4 class="font-semibold text-orange-300 mb-2">⚠️ Atenção:</h4>
        <ul class="text-sm text-orange-200 space-y-1">
          <li>• Buscar capas para muitos itens pode ser lento</li>
          <li>• O processo pode demorar vários minutos</li>
          <li>• Você pode pular a busca de capas agora</li>
          <li>• Capas podem ser buscadas depois individualmente</li>
        </ul>
      </div>
      
      <div class="bg-input p-4 rounded-lg mb-6">
        <label class="flex items-center space-x-3">
          <input x-model="largeImportModal.skipCovers" type="checkbox" class="rounded">
          <div>
            <span class="font-medium">Pular busca automática de capas</span>
            <p class="text-xs text-muted">Importar apenas os dados, sem buscar capas online</p>
          </div>
        </label>
      </div>
      
      <div class="flex space-x-4">
        <button @click="proceedLargeImport()" 
                class="flex-1 py-3 btn-primary rounded-md">
          <span x-show="!largeImportModal.skipCovers">Continuar com Capas</span>
          <span x-show="largeImportModal.skipCovers">Continuar sem Capas</span>
        </button>
        <button @click="cancelLargeImport()" 
                class="px-6 py-3 btn-secondary rounded-md">
          Cancelar
        </button>
      </div>
    </div>
  </div>

<!-- Login (apenas quando não é visualização compartilhada) -->
  <div x-show="!user && !loading && !isSharedView" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-900 to-black p-4">
    <div class="bg-card p-6 md:p-8 rounded-lg shadow-xl max-w-md w-full">
      <div class="text-center mb-6 md:mb-8">
        <i data-lucide="disc-3" class="mx-auto h-12 w-12 md:h-16 md:w-16 text-green-400 mb-4"></i>
        <h1 class="text-2xl md:text-3xl font-bold text-white">Katalog</h1>
        <p class="text-gray-400 mt-2">Organize sua coleção musical</p>
      </div>
      
      <div class="space-y-4">
        <div x-show="!showRegister" class="space-y-4">
          <input x-model="email" type="email" placeholder="seu@email.com" 
                 class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          <input x-model="password" type="password" placeholder="Sua senha" 
                 class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          <button @click="login()" :disabled="authLoading"
                  class="w-full py-3 px-4 btn-primary rounded-md font-medium">
            <span x-show="!authLoading">Entrar</span>
            <span x-show="authLoading">Entrando...</span>
          </button>
          <button @click="showForgotPassword = true" 
                    class="w-full text-sm text-green-400 hover:text-green-300">
            Esqueci minha senha
            </button>
          
          <div class="text-center">
            <span class="text-gray-400 text-sm">Não tem uma conta?</span>
            <button @click="showRegister = true" class="text-green-400 hover:text-green-300 text-sm ml-1">
              Cadastre-se
            </button>
          </div>
        </div>

        <div x-show="showRegister" class="space-y-4">
          <h3 class="text-lg font-semibold text-center">Criar Nova Conta</h3>
          <input x-model="displayName" type="text" placeholder="Nome de usuário" 
                 class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          <input x-model="email" type="email" placeholder="seu@email.com" 
                 class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          <input x-model="password" type="password" placeholder="Senha (min. 6 caracteres)" 
                 class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-3 text-sm">
            <p class="text-blue-300">
                <i data-lucide="info" class="w-4 h-4 inline mr-2"></i>
                Você receberá um email de verificação após o cadastro
            </p>
            </div>          
                 <button @click="register()" :disabled="authLoading"
                  class="w-full py-3 px-4 btn-primary rounded-md font-medium">
            <span x-show="!authLoading">Cadastrar</span>
            <span x-show="authLoading">Cadastrando...</span>
          </button>
          
          <div class="text-center">
            <span class="text-gray-400 text-sm">Já tem uma conta?</span>
            <button @click="showRegister = false" class="text-green-400 hover:text-green-300 text-sm ml-1">
              Fazer login
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard (apenas para usuários logados, não para visualização compartilhada) -->
  <div x-show="user && !loading && !isSharedView" class="flex h-screen">
    <!-- Desktop Sidebar -->
<aside class="w-64 bg-black flex-shrink-0 flex-col desktop-sidebar hidden md:flex">
  <div class="p-4 flex items-center space-x-2 border-b border-custom">
    <i data-lucide="disc-3" class="text-green-400"></i>
    <h1 class="text-xl font-bold text-white">Katalog</h1>
  </div>
  <nav class="flex-1 p-4 space-y-2">
    <a href="#" @click.prevent="currentView = 'collection'" 
       :class="{'bg-green-500 text-white': currentView === 'collection'}"
       class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-white">
       <i data-lucide="album"></i><span>Minha Coleção</span>
    </a>
    <a href="#" @click.prevent="currentView = 'add-record'" 
       :class="{'bg-green-500 text-white': currentView === 'add-record'}"
       class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-white">
       <i data-lucide="plus-circle"></i><span>Adicionar Item</span>
    </a>
    <a href="#" @click.prevent="currentView = 'wishlist'" 
      :class="{'bg-green-500 text-white': currentView === 'wishlist'}"
      class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-white">
      <i data-lucide="heart"></i><span>Lista de Desejos</span>
    </a>
    <button @click="configModal = true; configActiveTab = 'share'" 
            class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-blue-300">
      <i data-lucide="share-2"></i><span>Compartilhar</span>
    </button>
    <button @click="importModal.show = true" 
            class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-blue-300">
      <i data-lucide="upload"></i><span>Importar Excel</span>
    </button>
    <button @click="startAutoCoverSearch()" 
            :disabled="collection.length === 0"
            class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-purple-300 disabled:text-gray-500 disabled:cursor-not-allowed">
      <i data-lucide="image"></i><span>Buscar Capas</span>
    </button>
    <button @click="autoCorrectArtistNames()" 
        :disabled="collection.length === 0"
        class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-yellow-300 disabled:text-gray-500 disabled:cursor-not-allowed">
  <i data-lucide="user-check"></i><span>Corrigir Nomes</span>
</button>
<button @click="fillMissingYears()" 
        :disabled="collection.length === 0"
        class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-cyan-300 disabled:text-gray-500 disabled:cursor-not-allowed">
  <i data-lucide="calendar"></i><span>Buscar Anos</span>
</button>
  </nav>
  <div class="p-4 border-t border-custom space-y-2">
    <div class="px-3 py-2 text-xs text-gray-400 break-words">
      <span x-text="user?.email"></span>
    </div>
    <button @click="confirmLogout()" 
            class="w-full flex items-center space-x-3 px-3 py-2 rounded-md bg-red-600/50 hover:bg-red-800 text-white">
      <i data-lucide="log-out"></i><span>Sair</span>
    </button>
  </div>
</aside>

    <!-- Main -->
    <main class="flex-1 overflow-y-auto main-content">
      <!-- Mobile Header -->
      <div class="mobile-header mobile-only md:hidden bg-card">
        <div class="flex justify-between items-center">
          <button @click="showMobileSidebar = true" class="p-2 rounded-md hover:bg-input">
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
          <div class="flex items-center space-x-2">
            <i data-lucide="disc-3" class="text-green-400"></i>
            <h1 class="text-xl font-bold">Katalog</h1>
          </div>
          <button @click="configModal = true" class="p-2 rounded-md hover:bg-input">
            <i data-lucide="settings" class="w-6 h-6"></i>
          </button>
        </div>
      </div>

      <!-- Content -->
      <div class="p-4 md:p-8">
        <!-- Desktop Header -->
        <div class="hidden md:flex justify-between items-center mb-8">
          <div>
            <h1 class="text-2xl font-bold">
              Olá, <span x-text="user?.displayName || 'Usuário'"></span>!
            </h1>
            <p class="text-sm text-muted">Bem-vindo à sua coleção musical</p>
          </div>
          <button @click="configModal = true" 
                  class="flex items-center space-x-2 px-4 py-2 bg-input hover:bg-card rounded-lg border border-custom">
            <i data-lucide="settings" class="w-4 h-4"></i>
            <span>Configurações</span>
          </button>
        </div>

        <!-- Mobile Welcome -->
        <div class="md:hidden mb-6">
          <h2 class="text-xl font-bold">
            Olá, <span x-text="user?.displayName || 'Usuário'"></span>!
          </h2>
          <p class="text-sm text-muted">Bem-vindo à sua coleção</p>
        </div>

        <!-- Coleção -->
        <div x-show="currentView === 'collection'">
          <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 space-y-4 md:space-y-0">
            <h2 class="text-2xl md:text-3xl font-bold">Minha Coleção (<span x-text="collection.length"></span>)</h2>
            <div class="flex space-x-2">
              <button @click="viewMode = 'grid'" 
                      :class="viewMode === 'grid' ? 'btn-primary' : 'btn-secondary'"
                      class="px-3 py-2 md:px-4 md:py-2 rounded-md">
                <i data-lucide="grid-3x3" class="w-4 h-4"></i>
              </button>
              <button @click="viewMode = 'list'" 
                      :class="viewMode === 'list' ? 'btn-primary' : 'btn-secondary'"
                      class="px-3 py-2 md:px-4 md:py-2 rounded-md">
                <i data-lucide="list" class="w-4 h-4"></i>
              </button>
            </div>
          </div>
          
          <!-- Busca e Ordenação -->
          <div class="mb-6 space-y-4">
            <input x-model="searchFilter" @input="filterCollection()" 
                   placeholder="Buscar por álbum, artista, formato..." 
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
            
            <div class="flex flex-wrap items-center gap-2">
              <span class="text-sm font-medium">Ordenar por:</span>
              <button @click="setSortBy('album')" 
                      :class="sortBy === 'album' ? 'sort-active' : 'sort-inactive'"
                      class="sort-button">Álbum</button>
              <button @click="setSortBy('artist')" 
                      :class="sortBy === 'artist' ? 'sort-active' : 'sort-inactive'"
                      class="sort-button">Artista</button>
              <button @click="setSortBy('year')" 
                      :class="sortBy === 'year' ? 'sort-active' : 'sort-inactive'"
                      class="sort-button">Ano</button>
              <button @click="toggleSortOrder()" 
                      class="sort-button sort-inactive">
                <i :data-lucide="sortOrder === 'asc' ? 'arrow-up' : 'arrow-down'" class="w-3 h-3"></i>
              </button>
            </div>
          </div>
          
          <!-- Grid View -->
          <div x-show="viewMode === 'grid' && filteredCollection.length > 0" 
           class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-7 gap-3 md:gap-4 lg:gap-5">
            <template x-for="record in displayedCollection" :key="record.id">
              <div class="bg-card rounded-lg overflow-hidden shadow-lg group relative">
                <img :data-src="record.cover_url || `https://placehold.co/300x300/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`"
                  src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3C/svg%3E"
                  :alt="record.album || 'Álbum'"
                  class="w-full aspect-square object-cover cursor-pointer hover:opacity-90 transition-opacity"
                @click="showAlbumDetails(record)">
                <div class="absolute top-2 left-2">
                  <span :class="'format-' + (record.format?.toLowerCase() || 'cd')" 
                        class="format-badge text-xs" x-text="record.format || 'CD'"></span>
                </div>
                
                <!-- Botões desktop (hover) -->
                <div class="absolute top-2 right-2 hidden md:flex space-x-1 opacity-0 group-hover:opacity-100">
                  <button @click="editRecord(record)" 
                          class="bg-blue-600 text-white rounded-full p-2 hover:bg-blue-700">
                    <i data-lucide="edit" class="w-4 h-4"></i>
                  </button>
                  <button @click="confirmDeleteRecord(record.id)" 
                          class="bg-red-600 text-white rounded-full p-2 hover:bg-red-700">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                  </button>
                </div>
                
                <!-- Botões mobile (sempre visíveis) -->
                <div class="absolute bottom-2 right-2 flex md:hidden space-x-1">
                  <button @click="editRecord(record)" 
                          class="bg-blue-600 text-white rounded-full p-1.5 hover:bg-blue-700">
                    <i data-lucide="edit" class="w-3 h-3"></i>
                  </button>
                  <button @click="confirmDeleteRecord(record.id)" 
                          class="bg-red-600 text-white rounded-full p-1.5 hover:bg-red-700">
                    <i data-lucide="trash-2" class="w-3 h-3"></i>
                  </button>
                </div>
                
                <div class="p-2 md:p-3">
                  <h3 class="font-bold text-sm md:text-base truncate" x-text="record.album"></h3>
                  <p class="text-xs md:text-sm text-muted truncate" x-text="record.artist"></p>
                  <p x-show="record.year" class="text-xs text-muted" x-text="record.year"></p>
                </div>
              </div>
            </template>
          </div>

          <!-- List View -->
          <div x-show="viewMode === 'list' && filteredCollection.length > 0" 
               class="bg-card rounded-lg overflow-hidden shadow-lg">
            <!-- Mobile List View -->
            <div class="md:hidden">
              <template x-for="record in displayedCollection" :key="record.id">
                <div class="border-b border-custom p-4 flex items-center space-x-3">
                  <img :data-src="record.cover_url || `https://placehold.co/60x60/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`"
                    src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 60'%3E%3C/svg%3E"
                    :alt="record.album || 'Álbum'"
                    class="w-12 h-12 object-cover rounded cursor-pointer hover:opacity-90 transition-opacity"
                    @click="showAlbumDetails(record)">
                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-sm truncate" x-text="record.album"></h3>
                    <p class="text-xs text-muted truncate" x-text="record.artist"></p>
                    <div class="flex items-center space-x-2 mt-1">
                      <span :class="'format-' + (record.format?.toLowerCase() || 'cd')" 
                            class="format-badge text-xs" x-text="record.format || 'CD'"></span>
                      <span x-show="record.year" class="text-xs text-muted" x-text="record.year"></span>
                    </div>
                  </div>
                  <div class="flex space-x-2">
                    <button @click="editRecord(record)" 
                            class="text-blue-500 hover:text-blue-700 p-1">
                      <i data-lucide="edit" class="w-4 h-4"></i>
                    </button>
                    <button @click="confirmDeleteRecord(record.id)" 
                            class="text-red-500 hover:text-red-700 p-1">
                      <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                  </div>
                </div>
              </template>
            </div>
            
           <!-- Desktop List View -->
              <table class="w-full hidden md:table">
                <thead class="bg-input">
                  <tr>
                    <th class="text-left p-4 font-semibold">Capa</th>
                    <th class="text-left p-4 font-semibold">Álbum</th>
                    <th class="text-left p-4 font-semibold">Artista</th>
                    <th class="text-left p-4 font-semibold">Formato</th>
                    <th class="text-left p-4 font-semibold">Ano</th>
                    <th class="text-left p-4 font-semibold">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="record in displayedCollection" :key="record.id">
                    <tr class="border-b border-custom hover:bg-input">
                      <td class="p-4">
                        <img :data-src="record.cover_url || `https://placehold.co/60x60/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`"
                        src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 60'%3E%3C/svg%3E"
                        :alt="record.album || 'Álbum'"
                        class="w-12 h-12 object-cover rounded cursor-pointer hover:opacity-90 transition-opacity"
                        @click="showAlbumDetails(record)">
                      </td>
                      <td class="p-4 font-semibold" x-text="record.album"></td>
                      <td class="p-4" x-text="record.artist"></td>
                      <td class="p-4">
                        <span :class="'format-' + (record.format?.toLowerCase() || 'cd')" 
                              class="format-badge" x-text="record.format || 'CD'"></span>
                      </td>
                      <td class="p-4" x-text="record.year || '-'"></td>
                      <td class="p-4">
                        <div class="flex space-x-2">
                          <button @click="editRecord(record)" 
                                  class="text-blue-500 hover:text-blue-700 p-1">
                            <i data-lucide="edit" class="w-4 h-4"></i>
                          </button>
                          <button @click="confirmDeleteRecord(record.id)" 
                                  class="text-red-500 hover:text-red-700 p-1">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
             </div>

        <!-- Controles de Paginação (MOVIDO PARA CÁ) -->
        <div x-show="performanceMode && filteredCollection.length > 0 && pagination.totalPages > 1" 
            class="flex justify-center items-center space-x-4 mt-8">
          
          <button @click="pagination.currentPage = Math.max(1, pagination.currentPage - 1)" 
                  :disabled="pagination.currentPage === 1"
                  class="px-4 py-2 btn-secondary rounded-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2">
            <i data-lucide="chevron-left" class="w-4 h-4"></i>
            <span>Anterior</span>
          </button>
          
          <div class="flex items-center space-x-2">
            <span class="text-sm text-muted">Página</span>
            <span class="font-bold" x-text="pagination.currentPage"></span>
            <span class="text-sm text-muted">de</span>
            <span class="font-bold" x-text="pagination.totalPages"></span>
          </div>
          
          <button @click="pagination.currentPage = Math.min(pagination.totalPages, pagination.currentPage + 1)" 
                  :disabled="pagination.currentPage === pagination.totalPages"
                  class="px-4 py-2 btn-secondary rounded-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2">
            <span>Próxima</span>
            <i data-lucide="chevron-right" class="w-4 h-4"></i>
          </button>
        </div>

        <!-- Info de performance -->
        <div x-show="performanceMode && filteredCollection.length > 0" class="text-center mt-4">
          <p class="text-sm text-muted">
            Mostrando <span x-text="displayedCollection.length"></span> de 
            <span x-text="filteredCollection.length"></span> itens 
            (Página <span x-text="pagination.currentPage"></span> de <span x-text="pagination.totalPages"></span>)
          </p>
          <p class="text-xs text-muted mt-1">Modo Performance ativo para coleções grandes</p>
        </div>

        <!-- Política de Privacidade -->
        <div class="text-center mt-4">
          <a href="politica-de-privacidade.html" 
            target="_blank"
            class="text-xs text-gray-400 hover:text-green-400 transition-colors underline">
            Política de Privacidade
          </a>
        </div>

        <!-- Empty State -->
          <div x-show="collection.length === 0" class="text-center py-12 md:py-20 bg-card rounded-lg">
            <i data-lucide="folder-x" class="mx-auto h-12 w-12 md:h-16 md:w-16 text-muted mb-4"></i>
            <h3 class="text-lg md:text-xl font-semibold">Sua coleção está vazia</h3>
            <p class="text-muted mt-2">Comece adicionando seu primeiro item!</p>
            <button @click="currentView = 'add-record'" 
                    class="mt-4 md:mt-6 px-4 py-2 md:px-6 md:py-2 rounded-full btn-primary"
                    :class="{'!bg-black !text-white hover:!bg-gray-800': !darkMode}">
              Adicionar Item
            </button>
          </div>
        </div>

        <!-- Lista de Desejos -->
<div x-show="currentView === 'wishlist'">
  <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 space-y-4 md:space-y-0">
    <h2 class="text-2xl md:text-3xl font-bold">Lista de Desejos (<span x-text="wishlist.length"></span>)</h2>
    <div class="flex space-x-2">
      <button @click="viewMode = 'grid'" 
              :class="viewMode === 'grid' ? 'btn-primary' : 'btn-secondary'"
              class="px-3 py-2 md:px-4 md:py-2 rounded-md">
        <i data-lucide="grid-3x3" class="w-4 h-4"></i>
      </button>
      <button @click="viewMode = 'list'" 
              :class="viewMode === 'list' ? 'btn-primary' : 'btn-secondary'"
              class="px-3 py-2 md:px-4 md:py-2 rounded-md">
        <i data-lucide="list" class="w-4 h-4"></i>
      </button>
    </div>
  </div>
  
  <!-- Busca e Ordenação -->
  <div class="mb-6 space-y-4">
    <input x-model="searchFilter" @input="filterWishlist()" 
           placeholder="Buscar por álbum, artista, formato..." 
           class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
    
    <div class="flex flex-wrap items-center gap-2">
      <span class="text-sm font-medium">Ordenar por:</span>
      <button @click="setSortBy('album'); filterWishlist()" 
              :class="sortBy === 'album' ? 'sort-active' : 'sort-inactive'"
              class="sort-button">Álbum</button>
      <button @click="setSortBy('artist'); filterWishlist()" 
              :class="sortBy === 'artist' ? 'sort-active' : 'sort-inactive'"
              class="sort-button">Artista</button>
      <button @click="toggleSortOrder(); filterWishlist()" 
              class="sort-button sort-inactive">
        <i :data-lucide="sortOrder === 'asc' ? 'arrow-up' : 'arrow-down'" class="w-3 h-3"></i>
      </button>
    </div>
  </div>
  
  <!-- Grid View Wishlist -->
  <div x-show="viewMode === 'grid' && filteredWishlist.length > 0" 
       class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 2xl:grid-cols-7 gap-3 md:gap-4 lg:gap-5">
    <template x-for="record in displayedWishlist" :key="record.id">
      <div class="bg-card rounded-lg overflow-hidden shadow-lg group relative">
        <!-- Badge de wishlist -->
        <div class="absolute top-2 left-2 z-10">
          <span class="bg-pink-500 text-white px-2 py-1 text-xs font-semibold rounded-full flex items-center space-x-1">
            <i data-lucide="heart" class="w-3 h-3"></i>
            <span>Desejo</span>
          </span>
        </div>
        
        <img :data-src="record.cover_url || `https://placehold.co/300x300/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`"
          src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 300 300'%3E%3C/svg%3E"
          :alt="record.album || 'Álbum'"
          class="w-full aspect-square object-cover cursor-pointer hover:opacity-90 transition-opacity"
          @click="showAlbumDetails(record)">
        
        <!-- Botões desktop -->
        <div class="absolute top-2 right-2 hidden md:flex flex-col space-y-1 opacity-0 group-hover:opacity-100">
          <button @click="moveToCollection(record)" 
                  class="bg-green-600 text-white rounded-full p-2 hover:bg-green-700"
                  title="Adicionar à coleção">
            <i data-lucide="check" class="w-4 h-4"></i>
          </button>
          <button @click="editRecord(record)" 
                  class="bg-blue-600 text-white rounded-full p-2 hover:bg-blue-700">
            <i data-lucide="edit" class="w-4 h-4"></i>
          </button>
          <button @click="confirmDeleteRecord(record.id, true)" 
                  class="bg-red-600 text-white rounded-full p-2 hover:bg-red-700">
            <i data-lucide="trash-2" class="w-4 h-4"></i>
          </button>
        </div>
        
        <!-- Botões mobile -->
        <div class="absolute bottom-2 right-2 flex md:hidden space-x-1">
          <button @click="moveToCollection(record)" 
                  class="bg-green-600 text-white rounded-full p-1.5 hover:bg-green-700">
            <i data-lucide="check" class="w-3 h-3"></i>
          </button>
          <button @click="editRecord(record)" 
                  class="bg-blue-600 text-white rounded-full p-1.5 hover:bg-blue-700">
            <i data-lucide="edit" class="w-3 h-3"></i>
          </button>
          <button @click="confirmDeleteRecord(record.id, true)" 
                  class="bg-red-600 text-white rounded-full p-1.5 hover:bg-red-700">
            <i data-lucide="trash-2" class="w-3 h-3"></i>
          </button>
        </div>
        
        <div class="p-2 md:p-3">
          <h3 class="font-bold text-sm md:text-base truncate" x-text="record.album"></h3>
          <p class="text-xs md:text-sm text-muted truncate" x-text="record.artist"></p>
          <span :class="'format-' + (record.format?.toLowerCase() || 'cd')" 
                class="format-badge text-xs inline-block mt-1" x-text="record.format || 'CD'"></span>
        </div>
      </div>
    </template>
  </div>

  <!-- List View Wishlist -->
  <div x-show="viewMode === 'list' && filteredWishlist.length > 0" 
       class="bg-card rounded-lg overflow-hidden shadow-lg">
    <!-- Mobile List -->
    <div class="md:hidden">
      <template x-for="record in displayedWishlist" :key="record.id">
        <div class="border-b border-custom p-4 flex items-center space-x-3">
          <img :data-src="record.cover_url || `https://placehold.co/60x60/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`"
            src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 60'%3E%3C/svg%3E"
            :alt="record.album || 'Álbum'"
            class="w-12 h-12 object-cover rounded cursor-pointer hover:opacity-90 transition-opacity"
            @click="showAlbumDetails(record)">
          <div class="flex-1 min-w-0">
            <h3 class="font-semibold text-sm truncate flex items-center space-x-2">
              <i data-lucide="heart" class="w-3 h-3 text-pink-500"></i>
              <span x-text="record.album"></span>
            </h3>
            <p class="text-xs text-muted truncate" x-text="record.artist"></p>
            <span :class="'format-' + (record.format?.toLowerCase() || 'cd')" 
                  class="format-badge text-xs inline-block mt-1" x-text="record.format || 'CD'"></span>
          </div>
          <div class="flex flex-col space-y-1">
            <button @click="moveToCollection(record)" 
                    class="text-green-500 hover:text-green-700 p-1">
              <i data-lucide="check" class="w-4 h-4"></i>
            </button>
            <button @click="editRecord(record)" 
                    class="text-blue-500 hover:text-blue-700 p-1">
              <i data-lucide="edit" class="w-4 h-4"></i>
            </button>
            <button @click="confirmDeleteRecord(record.id, true)" 
                    class="text-red-500 hover:text-red-700 p-1">
              <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
          </div>
        </div>
      </template>
    </div>
    
    <!-- Desktop Table Wishlist-->
    <table class="w-full hidden md:table">
      <thead class="bg-input">
        <tr>
          <th class="text-left p-4 font-semibold">Capa</th>
          <th class="text-left p-4 font-semibold">Álbum</th>
          <th class="text-left p-4 font-semibold">Artista</th>
          <th class="text-left p-4 font-semibold">Formato</th>
          <th class="text-left p-4 font-semibold">Ações</th>
        </tr>
      </thead>
      <tbody>
        <template x-for="record in displayedWishlist" :key="record.id">
          <tr class="border-b border-custom hover:bg-input">
            <td class="p-4">
              <img :data-src="record.cover_url || `https://placehold.co/60x60/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`"
              src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 60 60'%3E%3C/svg%3E"
              :alt="record.album || 'Álbum'"
              class="w-12 h-12 object-cover rounded cursor-pointer hover:opacity-90 transition-opacity"
              @click="showAlbumDetails(record)">
            </td>
            <td class="p-4">
              <div class="flex items-center space-x-2">
                <i data-lucide="heart" class="w-4 h-4 text-pink-500"></i>
                <span class="font-semibold" x-text="record.album"></span>
              </div>
            </td>
            <td class="p-4" x-text="record.artist"></td>
            <td class="p-4">
              <span :class="'format-' + (record.format?.toLowerCase() || 'cd')" 
                    class="format-badge" x-text="record.format || 'CD'"></span>
            </td>
            <td class="p-4">
              <div class="flex space-x-2">
                <button @click="moveToCollection(record)" 
                        class="text-green-500 hover:text-green-700 p-1"
                        title="Adicionar à coleção">
                  <i data-lucide="check" class="w-4 h-4"></i>
                </button>
                <button @click="editRecord(record)" 
                        class="text-blue-500 hover:text-blue-700 p-1">
                  <i data-lucide="edit" class="w-4 h-4"></i>
                </button>
                <button @click="confirmDeleteRecord(record.id, true)" 
                        class="text-red-500 hover:text-red-700 p-1">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </div>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>

    <!-- Paginação -->
    <div x-show="filteredWishlist.length > 0 && wishlistPagination.totalPages > 1" 
        class="flex justify-center items-center space-x-4 mt-8">
      <button @click="wishlistPagination.currentPage = Math.max(1, wishlistPagination.currentPage - 1)" 
              :disabled="wishlistPagination.currentPage === 1"
              class="px-4 py-2 btn-secondary rounded-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2">
        <i data-lucide="chevron-left" class="w-4 h-4"></i>
        <span>Anterior</span>
      </button>
      
      <div class="flex items-center space-x-2">
        <span class="text-sm text-muted">Página</span>
        <span class="font-bold" x-text="wishlistPagination.currentPage"></span>
        <span class="text-sm text-muted">de</span>
        <span class="font-bold" x-text="wishlistPagination.totalPages"></span>
      </div>
      
      <button @click="wishlistPagination.currentPage = Math.min(wishlistPagination.totalPages, wishlistPagination.currentPage + 1)" 
              :disabled="wishlistPagination.currentPage === wishlistPagination.totalPages"
              class="px-4 py-2 btn-secondary rounded-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2">
        <span>Próxima</span>
        <i data-lucide="chevron-right" class="w-4 h-4"></i>
      </button>
    </div>

    <!-- Empty State -->
    <div x-show="wishlist.length === 0" class="text-center py-12 md:py-20 bg-card rounded-lg">
      <i data-lucide="heart" class="mx-auto h-12 w-12 md:h-16 md:w-16 text-muted mb-4"></i>
      <h3 class="text-lg md:text-xl font-semibold">Sua lista de desejos está vazia</h3>
      <p class="text-muted mt-2">Adicione álbuns que você deseja ter!</p>
      <button @click="currentView = 'add-record'; newRecord.isWishlist = true" 
              class="mt-4 md:mt-6 px-4 py-2 md:px-6 md:py-2 rounded-full btn-primary"
              :class="{'!bg-black !text-white hover:!bg-gray-800': !darkMode}">
        Adicionar à Lista
      </button>
    </div>
  </div>


        <!-- Form Adicionar -->
        <div x-show="currentView === 'add-record'">
          <h2 class="text-2xl md:text-3xl font-bold mb-6">Adicionar Novo Item</h2>
          <form @submit.prevent="confirmAddRecord()" class="max-w-3xl mx-auto bg-card p-4 md:p-8 rounded-lg space-y-4 md:space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium mb-1">Álbum/Título *</label>
                <input x-model="newRecord.album" required 
                       class="w-full p-3 bg-input border border-custom rounded-md">
              </div>
              <div>
                <label class="block text-sm font-medium mb-1">Artista *</label>
                <input x-model="newRecord.artist" required 
                       class="w-full p-3 bg-input border border-custom rounded-md">
              </div>
            </div>
            
              <div x-show="!newRecord.isWishlist" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-1">Formato *</label>
                  <select x-model="newRecord.format" required
                          class="w-full p-3 bg-input border border-custom rounded-md">
                    <option value="">Selecione...</option>
                    <option value="CD">CD</option>
                    <option value="Vinil">Vinil</option>
                    <option value="Cassete">Cassete</option>
                    <option value="Digital">Digital</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Ano</label>
                  <input x-model="newRecord.year" type="number" min="1900" max="2030"
                        class="w-full p-3 bg-input border border-custom rounded-md">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Número de Catálogo</label>
                  <input x-model="newRecord.catalog_number"
                        class="w-full p-3 bg-input border border-custom rounded-md">
                </div>
              </div>

              <!-- Formato simplificado para wishlist -->
              <div x-show="newRecord.isWishlist">
                <label class="block text-sm font-medium mb-1">Formato *</label>
                <select x-model="newRecord.format" required
                        class="w-full p-3 bg-input border border-custom rounded-md">
                  <option value="">Selecione...</option>
                  <option value="CD">CD</option>
                  <option value="Vinil">Vinil</option>
                  <option value="Cassete">Cassete</option>
                  <option value="Digital">Digital</option>
                </select>
              </div>

            <div>
              <label class="block text-sm font-medium mb-3">Capa do Álbum</label>
              
              <div class="mb-4">
                <button type="button" @click="searchCoverOnGoogle()" 
                        :disabled="!newRecord.album || !newRecord.artist"
                        class="w-full md:w-auto px-4 py-2 btn-primary rounded-md flex items-center justify-center">
                  <i data-lucide="search" class="w-4 h-4 mr-2"></i>
                  Buscar Capa no Google Imagens
                </button>
                <p class="text-xs text-muted mt-1">
                  Clique com o botão direito na imagem → "Copiar endereço da imagem"
                </p>
              </div>
              
              <input x-model="newRecord.cover_url" placeholder="Cole aqui a URL da capa..."
                    class="w-full p-3 bg-input border border-custom rounded-md mb-4">
              
              <div x-show="newRecord.cover_url" class="mb-4">
                <p class="text-sm text-muted mb-2">Preview:</p>
                <img :src="newRecord.cover_url" class="w-24 h-24 md:w-32 md:h-32 object-cover rounded-md" 
                    @error="newRecord.cover_url = ''">
              </div>
            </div>
            
            <div x-show="!newRecord.isWishlist">
              <label class="block text-sm font-medium mb-1">Descrição/Observações</label>
              <textarea x-model="newRecord.description" 
                        placeholder="Adicione informações extras sobre este álbum..."
                        rows="3"
                        class="w-full p-3 bg-input border border-custom rounded-md resize-none"></textarea>
            </div>
            <div x-show="!newRecord.id" class="border-t border-custom pt-4 mt-4">
            <div class="bg-pink-900/20 border border-pink-500/30 rounded-lg p-4">
              <label class="flex items-center space-x-3 cursor-pointer">
                <input x-model="newRecord.isWishlist" type="checkbox" class="rounded w-5 h-5">
                <div class="flex-1">
                  <div class="flex items-center space-x-2">
                    <i data-lucide="heart" class="w-4 h-4 text-pink-400"></i>
                    <span class="font-semibold text-pink-300">Adicionar à Lista de Desejos</span>
                  </div>
                  <p class="text-xs text-pink-200 mt-1">
                    Marque para salvar como álbum desejado ao invés de adicionar à coleção
                  </p>
                </div>
              </label>
            </div>
          </div>
            
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4">
              <button type="submit" :disabled="formLoading" 
                      class="flex-1 py-3 btn-primary rounded-md">
                <span x-show="!formLoading">Salvar Item</span>
                <span x-show="formLoading">Salvando...</span>
              </button>
              <button type="button" @click="resetForm()" 
                      class="px-6 py-3 btn-secondary rounded-md">Limpar</button>
            </div>
          </form>
        </div>
      </div>
    </main>
  </div>

    <!-- Mobile Bottom Navigation -->
    <nav x-show="user && !isSharedView" class="mobile-bottom-nav mobile-only md:hidden">
      <div class="flex justify-around items-center py-3">
        <button @click="currentView = 'collection'" 
                :class="{'text-green-400': currentView === 'collection'}"
                class="flex flex-col items-center space-y-1 px-2 py-2">
          <i data-lucide="album" class="w-4 h-4"></i>
          <span class="text-xs">Coleção</span>
        </button>
        <button @click="currentView = 'wishlist'" 
                :class="{'text-green-400': currentView === 'wishlist'}"
                class="flex flex-col items-center space-y-1 px-2 py-2">
          <i data-lucide="heart" class="w-4 h-4"></i>
          <span class="text-xs">Desejos</span>
        </button>
        <button @click="currentView = 'add-record'" 
                :class="{'text-green-400': currentView === 'add-record'}"
                class="flex flex-col items-center space-y-1 px-2 py-2">
          <i data-lucide="plus-circle" class="w-4 h-4"></i>
          <span class="text-xs">Adicionar</span>
        </button>
        <button @click="configModal = true; configActiveTab = 'share'" 
                class="flex flex-col items-center space-y-1 px-2 py-2 text-blue-300">
          <i data-lucide="share-2" class="w-4 h-4"></i>
          <span class="text-xs">Compartilhar</span>
        </button>
      </div>
    </nav>

  <!-- Floating Action Button (Mobile, apenas para usuários logados) -->
      <button x-show="currentView === 'collection' && collection.length === 0 && !isSharedView" 
          @click="currentView = 'add-record'"
          class="fab btn-primary mobile-only"
          :class="{'!bg-black !text-white': !darkMode}">
      <i data-lucide="plus" class="w-6 h-6"></i>
      </button>

<!-- JAVASCRIPT -->
  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAzEu2hLmvPzaFLgQtXUAUkuXvwokD2F-A",
      authDomain: "katalog-1178e.firebaseapp.com",
      projectId: "katalog-1178e",
      storageBucket: "katalog-1178e.firebasestorage.app",
      messagingSenderId: "998961219093",
      appId: "1:998961219093:web:6afddd14ad2ddd9ed3301c"
    };

    try {
      firebase.initializeApp(firebaseConfig);
      console.log('✅ Firebase inicializado com sucesso');
    } catch (error) {
      console.error('❌ Erro ao inicializar Firebase:', error);
    }

    const auth = firebase.auth();
    const db = firebase.firestore();

    // Verificar conectividade
    db.enableNetwork().catch(err => {
      console.error('Erro de rede do Firestore:', err);
    });

    // =============================================================================
    // SISTEMA DE SEGURANÇA E PROTEÇÃO
    // =============================================================================
    // Utilitários para sanitização de texto e controle de rate limiting
    // Previne ataques XSS e limita requisições por usuário/ação
    const SecurityUtils = {
        // Sanitiza texto removendo HTML, scripts e limitando tamanho
        sanitizeText(text) {
            if (!text) return '';
            return text.toString()
            .replace(/[<>]/g, '')           // Remove tags HTML
            .replace(/javascript:/gi, '')    // Remove JS inline
            .replace(/on\w+\s*=/gi, '')     // Remove event handlers
            .trim()
            .slice(0, 500);                 // Limita a 500 caracteres
        },

        // Sistema de rate limiting por usuário e ação
        rateLimiter: {
          requests: new Map(),
          
          // Verifica se usuário pode fazer determinada ação
          // @param {string} userId - ID do usuário
          // @param {string} action - Tipo de ação (login, register, etc)
          // @returns {boolean} - true se permitido
          isAllowed(userId, action = 'general') {
            const key = `${userId}_${action}`;
            const now = Date.now();
            const windowMs = 60000; // Janela de 1 minuto
            
            // Limites específicos por tipo de ação
            const limits = {
              'login': 5,          // 5 tentativas de login por minuto
              'register': 3,       // 3 cadastros por minuto
              'reset': 3,          // 3 reset de senha por minuto
              'file_upload': 3,    // 3 uploads de arquivo por minuto
              'add_record': 30,    // 30 adições de registro por minuto
              'general': 30        // 30 ações gerais por minuto
            };
        
        const maxRequests = limits[action] || limits['general'];
        
        if (!this.requests.has(key)) {
          this.requests.set(key, []);
        }
        
        const userRequests = this.requests.get(key);
        
        while (userRequests.length > 0 && userRequests[0] < now - windowMs) {
          userRequests.shift();
        }
        
        if (userRequests.length >= maxRequests) {
          return false;
        }
        
        userRequests.push(now);
        return true;
      }
    }
    };

document.addEventListener('alpine:init', () => {
  Alpine.data('app', () => ({
    loading: true,
    user: null,
    authLoading: false,
    formLoading: false,

  uploadControl: {
    attempts: [],
    blockedUntil: null
  },

   importTracking: {
    totalImported: 0,
    importCount: 0,
    isBlocked: false
  },

  
  wishlist: [],
  filteredWishlist: [],
  wishlistPagination: { 
    currentPage: 1, 
    itemsPerPage: 50, 
    totalPages: 1 },

  // Função de proteção
    canUpload() {
      const now = Date.now();
      const oneMinute = 60000;
      const fiveMinutes = 300000;
      
      // Se está bloqueado temporariamente
      if (this.uploadControl.blockedUntil && now < this.uploadControl.blockedUntil) {
        const waitSeconds = Math.ceil((this.uploadControl.blockedUntil - now) / 1000);
        return {
          allowed: false,
          message: `Aguarde ${waitSeconds} segundos antes de tentar novamente`
        };
      }
      
      // Limpar tentativas antigas (mais de 5 minutos)
      this.uploadControl.attempts = this.uploadControl.attempts.filter(
        time => now - time < fiveMinutes
      );
      
      // Máximo 3 uploads em 5 minutos
      if (this.uploadControl.attempts.length >= 3) {
        this.uploadControl.blockedUntil = now + oneMinute;
        return {
          allowed: false,
          message: 'Limite de uploads atingido. Aguarde 1 minuto.'
        };
      }
      
      // Permitir upload e registrar tentativa
      this.uploadControl.attempts.push(now);
      return { allowed: true };
    },
    unsubscribe: null,
    observeTimeout: null,
    
    // Variáveis para compartilhamento
    isSharedView: false,
    sharedUserId: null,
    sharedCollection: { records: [], owner: null },
    filteredSharedCollection: [],
    sharedSearchFilter: '',
    sharedViewMode: 'grid',
    collectionIsPublic: false,
    privacyUpdateLoading: false,
    shareUrl: '',
    sharedPagination: { currentPage: 1, itemsPerPage: 50, totalPages: 1 },
    
    // Getter para itens compartilhados exibidos
    get displayedSharedCollection() {
      const start = (this.sharedPagination.currentPage - 1) * this.sharedPagination.itemsPerPage;
      const end = start + this.sharedPagination.itemsPerPage;
      return this.filteredSharedCollection.slice(start, end);
    },
    
    // Device Detection
    isMobile: window.innerWidth < 769,
    showMobileSidebar: false,
    
    // Tema
    darkMode: localStorage.getItem('katalog-theme') !== 'light',
    
    // UI
    currentView: 'collection',
    viewMode: 'grid',
    showRegister: false,
    configModal: false,
    configActiveTab: 'user',
    searchFilter: '',
    
    // Modals
    importModal: { 
      show: false, 
      data: [], 
      preview: [], 
      loading: false, 
      progress: 0, 
      progressText: 'Iniciando...'
    },
    
    // Data
    collection: [],
    filteredCollection: [],
    sortBy: 'artist',
    sortOrder: 'asc',
    pagination: { currentPage: 1, itemsPerPage: 50, totalPages: 1 },
    searchTimeout: null,
    performanceMode: false,
    imageObserver: null,
    searchIndex: new Map(),
    newRecord: { 
      album: '', 
      artist: '', 
      format: '', 
      year: '', 
      catalog_number: '', 
      cover_url: '',
      description: '',
      isWishlist: false  // ADICIONAR ESTA LINHA
    },

    // Modal de detalhes do álbum
    albumDetailsModal: { show: false, record: null },

    // Autenticação
    email: '',
    password: '',
    displayName: '',
    newDisplayName: '',
    currentPassword: '',
    newPassword: '',
    confirmNewPassword: '',
    passwordUpdateLoading: false,
    
    // Notification
    notification: { show: false, message: '', type: 'success' },

    // Modal de exclusão de conta
    deleteAccountModal: { 
      show: false, 
      email: '', 
      password: '', 
      confirmed: false, 
      loading: false 
    },

    //Modal Alterar Senha
    changePasswordModal: false,

    // Sistema de verificação de E-mail
    emailVerified: false,
    showEmailVerification: false,
    verificationSent: false,

    // Variáveis de Redefinição de senhas
    showForgotPassword: false,
    resetEmail: '',
    resetEmailSent: false,

    // Controles de tráfego
      activeApiTasks: new Set(),
      maxConcurrentRequests: 3,
      requestDelay: 500, // ms entre requests

          
    // =============================================================================
    // INICIALIZAÇÃO DA APLICAÇÃO
    // =============================================================================
    // Função principal que inicializa toda a aplicação
    // Detecta modo compartilhado, configura Firebase e carrega dados do usuário
    async init() {
      try {
        console.log('🚀 Iniciando aplicação...');
        
        // -------------------------------------------------------------------------
        // 1. DETECÇÃO DE DISPOSITIVO
        // -------------------------------------------------------------------------
        // Verifica se é mobile ou desktop para adaptar interface
        this.checkDevice();
        window.addEventListener('resize', () => {
          this.checkDevice();
        });

        // -------------------------------------------------------------------------
        // 2. LAZY LOADING DE IMAGENS
        // -------------------------------------------------------------------------
        // Inicializa sistema universal de lazy loading (funciona em todos os modos)
        this.initUniversalLazyLoading();

        // -------------------------------------------------------------------------
        // 3. VERIFICAÇÃO DE MODO COMPARTILHADO
        // -------------------------------------------------------------------------
        // Verifica se URL contém ?shared=userId para exibir coleção pública
        await this.checkForSharedCollection();
        
        // Se for visualização compartilhada, finalizar init aqui
        if (this.isSharedView) {
          console.log('🎯 Modo compartilhado confirmado - finalizando init');
          this.loading = false;
          
          // Aguardar renderização e inicializar ícones
          setTimeout(() => {
            lucide.createIcons();
            this.observeImages();
          }, 500);
          
          return; // Sair da função init
        }

        // -------------------------------------------------------------------------
        // 4. INICIALIZAÇÃO FIREBASE (apenas para usuários logados)
        // -------------------------------------------------------------------------
        console.log('🔐 Modo normal - inicializando autenticação...');
        
        // Aguardar Firebase estar completamente pronto
        await new Promise((resolve) => {
          if (firebase.apps.length > 0) {
            resolve();
          } else {
            setTimeout(resolve, 1000);
          }
        });
        
        // -------------------------------------------------------------------------
        // 5. LISTENER DE AUTENTICAÇÃO
        // -------------------------------------------------------------------------
        // Monitora mudanças no estado de autenticação do usuário
        auth.onAuthStateChanged(async (user) => {
          this.user = user;
          
          if (user) {
            console.log('✅ Usuário logado:', user.email);
            console.log('Email verificado:', user.emailVerified);
            
            try {
              // Carregar dados do usuário (coleção, wishlist, configurações)
              await this.setupCollection(user.uid);
              await this.loadUserSettings(user.uid);
              
              // ---------------------------------------------------------------
              // VERIFICAÇÃO DE EMAIL
              // ---------------------------------------------------------------
              // Se email não verificado, exibir banner de verificação
              if (!user.emailVerified) {
                console.log('⚠️ Email não verificado');
                this.showEmailVerification = true;
                this.emailVerified = false;
              } else {
                this.emailVerified = true;
                this.showEmailVerification = false;
              }
            } catch (error) {
              console.error('Erro ao carregar dados do usuário:', error);
              this.showNotification('Erro ao carregar seus dados', 'error');
            }
          } else {
            // Usuário não logado - limpar dados locais
            this.collection = [];
            this.filteredCollection = [];
            this.wishlist = [];
            this.filteredWishlist = [];
            this.showEmailVerification = false;
          }
          
          this.loading = false;
          setTimeout(() => lucide.createIcons(), 100);
        });

        // Inicializar ícones Lucide
        lucide.createIcons();
        
        // -------------------------------------------------------------------------
        // 6. OBSERVERS DE IMAGENS
        // -------------------------------------------------------------------------
        // Aguardar renderização inicial antes de observar imagens
        setTimeout(() => {
          if (this.performanceMode) {
            this.observeImages();
          }
        }, 200);

        setTimeout(() => {
          this.observeImages();
        }, 200);

        // -------------------------------------------------------------------------
        // 7. WATCHERS REATIVOS
        // -------------------------------------------------------------------------
        // Monitora mudanças e atualiza interface automaticamente
        
        // Watcher de paginação - atualiza ícones ao mudar página
        this.$watch('pagination.currentPage', () => {
          if (!this.isSharedView) {
            setTimeout(() => {
              lucide.createIcons();
              this.observeImages();
            }, 50);
          }
        });

        // Watcher de modo de visualização (grid/list)
        this.$watch('viewMode', () => {
          if (!this.isSharedView) {
            setTimeout(() => {
              lucide.createIcons();
              this.observeImages();
            }, 50);
          }
        });

        // Watcher de coleção compartilhada filtrada
        this.$watch('filteredSharedCollection', () => {
          if (this.isSharedView) {
            this.$nextTick(() => {
              setTimeout(() => {
                lucide.createIcons();
                this.observeImages();
              }, 50);
            });
          }
        });

        // Watcher de paginação compartilhada
        this.$watch('sharedPagination.currentPage', () => {
          if (this.isSharedView) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Múltiplas tentativas de carregamento para garantir exibição
            this.$nextTick(() => {
              this.forceLoadSharedImages();
              
              setTimeout(() => {
                this.forceLoadSharedImages();
                lucide.createIcons();
              }, 100);
              
              setTimeout(() => {
                this.forceLoadSharedImages();
              }, 300);
              
              setTimeout(() => {
                this.forceLoadSharedImages();
              }, 600);
            });
          }
        });

        // Watcher de paginação da wishlist
        this.$watch('wishlistPagination.currentPage', () => {
          if (!this.isSharedView) {
            setTimeout(() => {
              lucide.createIcons();
            }, 50);
          }
        });

        // Watcher de loading - força atualização após carregar
        this.$watch('loading', (newValue, oldValue) => {
            if (oldValue === true && newValue === false && this.user) {
                this.$nextTick(() => {
                    console.log('Forçando atualização da UI após o loading...');
                    this.filterAndSortCollection(); // Re-executa filtro da coleção
                    this.filterWishlist();          // Re-executa filtro da wishlist
                    lucide.createIcons();           // Renderiza ícones
                });
            }
        });

        // Watcher final de loading para imagens
        this.$watch('loading', (newValue, oldValue) => {
          if (oldValue === true && newValue === false) {
            setTimeout(() => {
              lucide.createIcons();
              this.observeImages();
            }, 100);
          }
        });

      } catch (error) {
        console.error('💥 Erro crítico na inicialização:', error);
        this.loading = false;
        this.showNotification('Erro crítico. Recarregue a página.', 'error');
      }
    },

    // =============================================================================
    // SISTEMA DE VERIFICAÇÃO DE EMAIL
    // =============================================================================

    // Envia email de verificação para o usuário atual
    async sendEmailVerification() {
      if (!this.user) return;
      
      try {
        await this.user.sendEmailVerification();
        this.verificationSent = true;
        this.showNotification('Email de verificação enviado!', 'success');
      } catch (error) {
        console.error('Erro ao enviar verificação:', error);
        this.showNotification('Erro ao enviar email de verificação', 'error');
      }
    },

    // Verifica se o email do usuário foi confirmado
    // Recarrega dados do Firebase e atualiza interface se verificado
    async checkEmailVerification() {
        if (!this.user) return;
        
        try {
            // Recarregar dados do usuário do Firebase
            await this.user.reload();
            
            if (this.user.emailVerified) {
              // Email verificado - atualizar interface
              this.emailVerified = true;
              this.showEmailVerification = false;
              this.showNotification('Email verificado com sucesso!', 'success');
              
              // Recarregar coleção e configurações
              this.setupCollection(this.user.uid);
              this.loadUserSettings(this.user.uid);
            } else {
              this.showNotification('Email ainda não foi verificado', 'info');
            }
        } catch (error) {
            console.error('Erro ao verificar email:', error);
            this.showNotification('Erro ao verificar email', 'error');
        }
    },

    // Função recuperar senha
    async sendPasswordReset() {
    if (!this.resetEmail) {
        this.showNotification('Digite seu email', 'error');
        return;
    }
    
    if (!SecurityUtils.rateLimiter.isAllowed(this.resetEmail, 'reset')) {
        this.showNotification('Muitas tentativas. Tente novamente em 1 minuto', 'error');
        return;
    }
    
    this.authLoading = true;
    try {
        await auth.sendPasswordResetEmail(this.resetEmail);
        this.resetEmailSent = true;
        this.showNotification('Email de recuperação enviado!', 'success');
    } catch (error) {
        console.error('Erro ao enviar recuperação:', error);
        let message = 'Erro ao enviar email de recuperação';
        if (error.code === 'auth/user-not-found') {
        message = 'Email não encontrado';
        }
        this.showNotification(message, 'error');
    }
    this.authLoading = false;
    },

    closeForgotPassword() {
    this.showForgotPassword = false;
    this.resetEmail = '';
    this.resetEmailSent = false;
    },

  // =============================================================================
  // SISTEMA DE COMPARTILHAMENTO DE COLEÇÃO
  // =============================================================================

  // Verifica se URL contém parâmetro ?shared=userId
  // Define o modo de visualização (compartilhado ou normal)
  async checkForSharedCollection() {
    console.log('🔍 Verificando URL para compartilhamento...');
    console.log('🔍 URL atual:', window.location.href);
    console.log('🔍 Search params:', window.location.search);
    
    const urlParams = new URLSearchParams(window.location.search);
    const sharedId = urlParams.get('shared');
    
    console.log('🆔 Shared ID encontrado:', sharedId);
    
    if (sharedId) {
      console.log('✅ Modo compartilhamento ativado para ID:', sharedId);
      this.isSharedView = true;
      this.sharedUserId = sharedId;
      
      try {
        await this.loadSharedCollection(sharedId);
        console.log('✅ Coleção compartilhada carregada com sucesso');
      } catch (error) {
        console.error('❌ Erro ao carregar coleção compartilhada:', error);
        this.goToLogin();
      }
    } else {
      console.log('❌ Nenhum ID compartilhado encontrado');
      this.isSharedView = false;
    }
  },

  // Carrega dados de uma coleção pública compartilhada
  // @param {string} userId - ID do dono da coleção
  async loadSharedCollection(userId) {
    try {
      console.log('📄 Iniciando carregamento da coleção compartilhada para:', userId);
      this.loading = true;
      
      if (!db) {
        throw new Error('Firebase não inicializado');
      }
      
      // -----------------------------------------------------------------------
      // 1. BUSCAR DADOS DO USUÁRIO DONO DA COLEÇÃO
      // -----------------------------------------------------------------------
      console.log('🔍 Buscando dados do usuário...');
      const userDoc = await db.collection('users').doc(userId).get();
      
      if (!userDoc.exists) {
        console.error('❌ Usuário não existe:', userId);
        throw new Error('Usuário não encontrado');
      }

      const userData = userDoc.data();
      console.log('📋 Dados do usuário carregados:', userData);
      
      // Verificar se a coleção é pública
      if (!userData || !userData.isPublic) {
        console.error('🔒 Coleção é privada ou dados inválidos');
        throw new Error('Coleção privada ou dados inválidos');
      }

      // Armazenar informações do dono
      this.sharedCollection.owner = {
        displayName: userData.displayName || 'Usuário',
        email: userData.email || 'Email não disponível'
      };

      // -----------------------------------------------------------------------
      // 2. BUSCAR REGISTROS DA COLEÇÃO
      // -----------------------------------------------------------------------
      console.log('🔍 Buscando registros da coleção...');
      const recordsSnapshot = await db.collection('users').doc(userId).collection('records').get();
      console.log('📦 Query executada, docs encontrados:', recordsSnapshot.size);
      
      // Mapear documentos para array de objetos
      this.sharedCollection.records = recordsSnapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          ...data
        };
      });

      // Aplicar filtro inicial
      this.filterSharedCollection();
      
      console.log('✅ Coleção compartilhada carregada:', {
        owner: this.sharedCollection.owner,
        totalRecords: this.sharedCollection.records.length,
        filteredRecords: this.filteredSharedCollection.length,
        totalPages: this.sharedPagination.totalPages
      });
      
      this.loading = false;
      
      // -----------------------------------------------------------------------
      // 3. FORÇAR CARREGAMENTO DE IMAGENS
      // -----------------------------------------------------------------------
      // Múltiplas tentativas para garantir que imagens sejam carregadas
      setTimeout(() => {
        lucide.createIcons();
        this.observeImages();
      }, 100);
      
      setTimeout(() => {
        lucide.createIcons();
        this.observeImages();
      }, 500);
      
      setTimeout(() => {
        this.observeImages();
      }, 1000);
      
    } catch (error) {
      console.error('💥 Erro detalhado ao carregar coleção compartilhada:', error);
      this.loading = false;
      this.showNotification(`Erro: ${error.message}`, 'error');
      
      setTimeout(() => {
        this.goToLogin();
      }, 2000);
    }
  },

    // Filtrar coleção compartilhada
        filterSharedCollection() {
      console.log('Filtrando coleção compartilhada...', this.sharedCollection.records?.length);
      
      if (!this.isSharedView || !this.sharedCollection.records) {
        this.filteredSharedCollection = [];
        return;
      }
      
      let filtered = [...this.sharedCollection.records];
      
      if (this.sharedSearchFilter && this.sharedSearchFilter.trim()) {
        const filter = this.sharedSearchFilter.toLowerCase().trim();
        console.log('Aplicando filtro:', filter);
        
        filtered = filtered.filter(record => {
          const album = (record.album || '').toLowerCase();
          const artist = (record.artist || '').toLowerCase();
          const format = (record.format || '').toLowerCase();
          const year = (record.year || '').toString().toLowerCase();
          const catalog = (record.catalog_number || '').toLowerCase();
          
          return album.includes(filter) || 
                artist.includes(filter) || 
                format.includes(filter) || 
                year.includes(filter) ||
                catalog.includes(filter);
        });
      }
      
      // ORDENAÇÃO 
      filtered.sort((a, b) => {
        // Ordenar por artista
        const artistA = (a.artist || '').toLowerCase();
        const artistB = (b.artist || '').toLowerCase();
        
        if (artistA !== artistB) {
          return artistA > artistB ? 1 : -1;
        }
        
        // Se artistas iguais, ordenar por ano
        const yearA = parseInt(a.year) || 0;
        const yearB = parseInt(b.year) || 0;
        return yearA - yearB;
      });
      
          
          this.filteredSharedCollection = filtered;
          // Atualizar paginação
          this.updateSharedPagination();
          
          console.log('Itens filtrados:', filtered.length);
          
          // Garantir que os ícones sejam atualizados
          setTimeout(() => lucide.createIcons(), 50);
        },
        
        // Adicionar nova função para atualizar paginação compartilhada:
        updateSharedPagination() {
          this.sharedPagination.totalPages = Math.ceil(this.filteredSharedCollection.length / this.sharedPagination.itemsPerPage);
          if (this.sharedPagination.currentPage > this.sharedPagination.totalPages && this.sharedPagination.totalPages > 0) {
            this.sharedPagination.currentPage = 1;
          }
        },

    // Ir para tela de login (limpar compartilhamento)
        goToLogin() {
          console.log('🔄 Redirecionando para login...');
          
          // Limpar estado de compartilhamento
          this.isSharedView = false;
          this.sharedUserId = null;
          this.sharedCollection = { records: [], owner: null };
          this.filteredSharedCollection = [];
          this.sharedSearchFilter = '';
          this.loading = false;
          
          // Limpar URL e recarregar
          const newUrl = window.location.origin + window.location.pathname;
          window.location.href = newUrl;
        },

    // Alternar privacidade da coleção
    async toggleCollectionPrivacy() {
      if (this.privacyUpdateLoading) return;
      
      this.privacyUpdateLoading = true;
      try {
        const newStatus = !this.collectionIsPublic;
        const userId = this.user.uid;
        
        await db.collection('users').doc(userId).set({
          isPublic: newStatus,
          displayName: this.user.displayName,
          email: this.user.email,
          updatedAt: new Date()
        }, { merge: true });

        this.collectionIsPublic = newStatus;
        this.updateShareUrl();
        
        this.showNotification(
          `Coleção agora é ${newStatus ? 'pública' : 'privada'}!`, 
          'success'
        );
        
      } catch (error) {
        console.error('Erro ao atualizar privacidade:', error);
        this.showNotification('Erro ao atualizar privacidade', 'error');
      }
      
      this.privacyUpdateLoading = false;
    },

    // Atualizar URL de compartilhamento
    updateShareUrl() {
      if (this.collectionIsPublic && this.user) {
        const baseUrl = window.location.origin + window.location.pathname;
        this.shareUrl = `${baseUrl}?shared=${this.user.uid}`;
      } else {
        this.shareUrl = '';
      }
    },

    // Copiar URL de compartilhamento
    async copyShareUrl() {
      try {
        await navigator.clipboard.writeText(this.shareUrl);
        this.showNotification('Link copiado para a área de transferência!', 'success');
      } catch (error) {
        console.error('Erro ao copiar URL:', error);
        this.showNotification('Erro ao copiar link', 'error');
      }
    },
    
    checkDevice() {
      this.isMobile = window.innerWidth < 769;
      if (!this.isMobile) {
        this.showMobileSidebar = false;
      }
    },

    // Gerar QR Code
    generateQRCode() {
      if (!this.collectionIsPublic || !this.shareUrl) return;
      
      const qrContainer = document.getElementById('qrcode');
      qrContainer.innerHTML = ''; // Limpar QR anterior
      
      try {
        new QRCode(qrContainer, {
          text: this.shareUrl,
          width: 200,
          height: 200,
          colorDark: '#000000',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });
        this.showNotification('QR Code gerado!', 'success');
      } catch (error) {
        console.error('Erro ao gerar QR Code:', error);
        this.showNotification('Erro ao gerar QR Code', 'error');
      }
    },

    // Compartilhar em plataformas
    shareOnPlatform(platform) {
      if (!this.shareUrl) return;
      
      const message = encodeURIComponent('Confira minha coleção de música no Katalog!');
      const url = encodeURIComponent(this.shareUrl);
      
      let shareLink = '';
      
      switch(platform) {
        case 'facebook':
          shareLink = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
          break;
        case 'twitter':
          shareLink = `https://twitter.com/intent/tweet?text=${message}&url=${url}`;
          break;
        case 'reddit':
          shareLink = `https://reddit.com/submit?url=${url}&title=${message}`;
          break;
        case 'whatsapp':
          shareLink = `https://wa.me/?text=${message}%20${url}`;
          break;
      }
      
      if (shareLink) {
        window.open(shareLink, '_blank', 'width=600,height=400');
      }
    },

    // Share nativo mobile
    async shareNative() {
      if (!navigator.share) {
        this.showNotification('Compartilhamento não suportado neste navegador', 'error');
        return;
      }
      
      try {
        await navigator.share({
          title: 'Minha Coleção - Katalog',
          text: 'Confira minha coleção de música no Katalog!',
          url: this.shareUrl
        });
        this.showNotification('Compartilhado com sucesso!', 'success');
      } catch (error) {
        if (error.name !== 'AbortError') {
          console.error('Erro ao compartilhar:', error);
        }
      }
    },

    // Mostrar detalhes do álbum
    showAlbumDetails(record) {
      if (this.performanceMode) {
        // Em modo performance, usar timeout para evitar travamento
        this.showNotification('Carregando detalhes...', 'info');
        setTimeout(() => {
          this.albumDetailsModal = { show: true, record };
          setTimeout(() => {
            lucide.createIcons();
            this.observeImages();
          }, 50);
        }, 50);
      } else {
        this.albumDetailsModal = { show: true, record };
        setTimeout(() => {
          lucide.createIcons();
          this.observeImages();
        }, 10);
      }
    },

    // Buscar em serviços online
    searchOnService(service) {
      const record = this.albumDetailsModal.record;
      if (!record) return;
      
      const query = `${record.artist} ${record.album}`.trim();
      const encodedQuery = encodeURIComponent(query);
      
      let url = '';
      
      switch(service) {
        case 'youtube':
          url = `https://www.youtube.com/results?search_query=${encodedQuery}`;
          break;
        case 'spotify':
          url = `https://open.spotify.com/search/${encodedQuery}`;
          break;
        case 'apple':
          url = `https://music.apple.com/search?term=${encodedQuery}`;
          break;
        case 'rateyourmusic':
          url = `https://www.rateyourmusic.com/search?searchterm=${encodedQuery}&searchtype=`;
          break;
      }
      
      if (url) {
        window.open(url, '_blank');
      }
    },
    
    async setupCollection(userId) {
  try {
    console.log('📄 Carregando dados do usuário:', userId);
    
    if (!db) {
      throw new Error('Firebase não inicializado');
    }
    
    const collectionRef = db.collection('users').doc(userId).collection('records');
    
    const timeoutPromise = new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Timeout ao carregar coleção')), 15000)
    );
    
    const dataPromise = collectionRef.get();
    const snapshot = await Promise.race([dataPromise, timeoutPromise]);
    
    this.collection = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    console.log('✅ Coleção carregada:', this.collection.length, 'itens');
    
    const wishlistRef = db.collection('users').doc(userId).collection('wishlist');
    const wishlistPromise = wishlistRef.get();
    const wishlistSnapshot = await Promise.race([wishlistPromise, timeoutPromise]);
    
    this.wishlist = wishlistSnapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    console.log('✅ Wishlist carregada:', this.wishlist.length, 'itens');
    
    if (!this.user.emailVerified) {
      const savedTracking = localStorage.getItem(`import_tracking_${userId}`);
      if (savedTracking) {
        try {
          const tracking = JSON.parse(savedTracking);
          this.importTracking = {
            totalImported: tracking.totalImported || 0,
            importCount: tracking.importCount || 0,
            isBlocked: tracking.importCount >= 2
          };
        } catch (e) {
          console.error('Erro ao ler tracking:', e);
        }
      }
    } else {
      localStorage.removeItem(`import_tracking_${userId}`);
      this.importTracking = {
        totalImported: 0,
        importCount: 0,
        isBlocked: false
      };
    }
    
    this.checkPerformanceMode();
    this.filterAndSortCollection();
    this.filterWishlist();
    this.setupCollectionListener(userId);
    this.setupWishlistListener(userId);
    
    // FORÇAR LAZY LOADING DAS IMAGENS
    this.$nextTick(() => {
      setTimeout(() => {
        lucide.createIcons();
        this.observeImages();
      }, 300);
    });
    
    console.log('✅ Setup completo!');
    
  } catch (error) {
    console.error('💥 ERRO CRÍTICO ao configurar coleção:', error);
    console.error('Tipo do erro:', error.name);
    console.error('Mensagem:', error.message);
    
    if (error.message.includes('Timeout')) {
      this.showNotification('Tempo esgotado ao carregar dados. Verifique sua conexão.', 'error');
    } else if (error.message.includes('permission-denied')) {
      this.showNotification('Sem permissão para acessar dados. Faça logout e login novamente.', 'error');
    } else if (error.message.includes('Firebase não inicializado')) {
      this.showNotification('Erro de inicialização. Recarregue a página.', 'error');
    } else {
      this.showNotification('Erro ao carregar dados. Tente novamente.', 'error');
    }
    
    this.collection = [];
    this.filteredCollection = [];
    this.wishlist = [];
    this.filteredWishlist = [];
  }
},

    // Função para listener 
    setupCollectionListener(userId) {
      const collectionRef = db.collection('users').doc(userId).collection('records');
      
      // Listener que só escuta mudanças
      this.unsubscribe = collectionRef.onSnapshot((snapshot) => {
        let hasChanges = false;
        
        snapshot.docChanges().forEach((change) => {
          hasChanges = true;
          const record = { id: change.doc.id, ...change.doc.data() };
          
          if (change.type === 'added') {
            const exists = this.collection.find(r => r.id === record.id);
            if (!exists) {
              this.collection.push(record);
            }
          } else if (change.type === 'modified') {
            const index = this.collection.findIndex(r => r.id === record.id);
            if (index !== -1) {
              this.collection[index] = record;
            }
          } else if (change.type === 'removed') {
            this.collection = this.collection.filter(r => r.id !== record.id);
          }
        });
            if (hasChanges) {
          this.checkPerformanceMode();
          this.buildSearchIndex(); // Se estiver em modo performance
          this.filterAndSortCollection();
          this.updatePagination(); // Forçar atualização da paginação
          
          // Forçar atualização dos ícones
          setTimeout(() => lucide.createIcons(), 100);
        }
      });
    },


    // Configurações da Lista de Desejos (Wishlist)
    setupWishlistListener(userId) {
      const wishlistRef = db.collection('users').doc(userId).collection('wishlist');
      
      wishlistRef.onSnapshot((snapshot) => {
        let hasChanges = false;
        
        snapshot.docChanges().forEach((change) => {
          hasChanges = true;
          const record = { id: change.doc.id, ...change.doc.data() };
          
          if (change.type === 'added') {
            const exists = this.wishlist.find(r => r.id === record.id);
            if (!exists) {
              this.wishlist.push(record);
            }
          } else if (change.type === 'modified') {
            const index = this.wishlist.findIndex(r => r.id === record.id);
            if (index !== -1) {
              this.wishlist[index] = record;
            }
          } else if (change.type === 'removed') {
            this.wishlist = this.wishlist.filter(r => r.id !== record.id);
          }
        });
        
        if (hasChanges) {
          this.filterWishlist();
        }
      });
    },

    // Adicionar função de filtro da wishlist:
    filterWishlist() {
      let filtered = this.wishlist;
      
      if (this.searchFilter.trim()) {
        const filter = this.searchFilter.toLowerCase();
        filtered = filtered.filter(record => 
          record.album?.toLowerCase().includes(filter) ||
          record.artist?.toLowerCase().includes(filter) ||
          record.format?.toLowerCase().includes(filter)
        );
      }
      
      // Aplicar ordenação
      filtered.sort((a, b) => {
        let valueA, valueB;
        
        switch(this.sortBy) {
          case 'album':
            valueA = (a.album || '').toLowerCase();
            valueB = (b.album || '').toLowerCase();
            break;
          case 'artist':
            valueA = (a.artist || '').toLowerCase();
            valueB = (b.artist || '').toLowerCase();
            break;
          default:
            return 0;
        }
        
        if (this.sortOrder === 'asc') {
          return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
        } else {
          return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
        }
      });
      
      this.filteredWishlist = filtered;
      this.updateWishlistPagination();
      
      setTimeout(() => {
        lucide.createIcons();
        this.observeImages();
      }, 10);
    },

    updateWishlistPagination() {
      this.wishlistPagination.totalPages = Math.ceil(this.filteredWishlist.length / this.wishlistPagination.itemsPerPage);
      if (this.wishlistPagination.currentPage > this.wishlistPagination.totalPages && this.wishlistPagination.totalPages > 0) {
        this.wishlistPagination.currentPage = 1;
      }
    },

    get displayedWishlist() {
      const start = (this.wishlistPagination.currentPage - 1) * this.wishlistPagination.itemsPerPage;
      const end = start + this.wishlistPagination.itemsPerPage;
      return this.filteredWishlist.slice(start, end);
    },

    // Carregar configurações do usuário
      async loadUserSettings(userId) {
        try {
          const userDoc = await db.collection('users').doc(userId).get();
          if (userDoc.exists) {
            const userData = userDoc.data();
            this.collectionIsPublic = userData.isPublic || false;
            this.updateShareUrl();
          }
        } catch (error) {
          console.error('Erro ao carregar configurações:', error);
        }
      },

// Função Login
    async login() {
    console.log('🚀 FUNÇÃO LOGIN CHAMADA!');
    console.log('📧 Email:', this.email);
    console.log('🔑 Senha:', this.password ? '***' : 'VAZIO');
    
    if (!this.email || !this.password) {
        this.showNotification('Preencha email e senha', 'error');
        return;
    }

    if (!SecurityUtils.rateLimiter.isAllowed(this.email, 'login')) {
        this.showNotification('Muitas tentativas de login. Tente novamente em 1 minuto', 'error');
        return;
    }

    console.log('✅ Validações passaram, tentando login...');
    
    this.authLoading = true;
    try {
        await auth.signInWithEmailAndPassword(this.email, this.password);
        console.log('✅ Login bem sucedido!');
        this.showNotification('Login realizado com sucesso!', 'success');
    } catch (error) {
        console.error('❌ Erro no login:', error);
        let message = 'Erro no login: ';
        
        switch(error.code) {
        case 'auth/user-not-found':
        case 'auth/wrong-password':
            message += 'Email ou senha incorretos';
            break;
        case 'auth/too-many-requests':
            message += 'Muitas tentativas. Tente novamente mais tarde';
            break;
        case 'auth/user-disabled':
            message += 'Conta desabilitada';
            break;
        default:
            message += error.message;
        }
        
        this.showNotification(message, 'error');
    }
    this.authLoading = false;
    },

    // Registro de Usuario
  async register() {
    if (!this.email || !this.password || !this.displayName) {
      this.showNotification('Preencha todos os campos', 'error');
      return;
    }

    if (this.password.length < 8) {
      this.showNotification('Senha deve ter pelo menos 8 caracteres', 'error');
      return;
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(this.email)) {
      this.showNotification('Email inválido', 'error');
      return;
    }

    // Delay artificial
    this.authLoading = true;
    this.showNotification('Validando dados...', 'info');
    await new Promise(resolve => setTimeout(resolve, 1500)); // 1.5 segundos

    const sanitizedName = SecurityUtils.sanitizeText(this.displayName);
    if (sanitizedName.length < 2) {
      this.showNotification('Nome deve ter pelo menos 2 caracteres', 'error');
      this.authLoading = false;
      return;
    }

    try {
      const userCredential = await auth.createUserWithEmailAndPassword(this.email, this.password);
      await userCredential.user.updateProfile({ displayName: sanitizedName });
      await userCredential.user.sendEmailVerification();
      
      await db.collection('users').doc(userCredential.user.uid).set({
        displayName: sanitizedName,
        email: this.email,
        isPublic: false,
        createdAt: new Date(),
        emailVerified: false
      });
      
      this.showNotification('Conta criada! Verifique seu email', 'success');
      this.showEmailVerification = true;
      this.verificationSent = true;
      
    } catch (error) {
      console.error('Erro no registro:', error);
      let message = 'Erro no registro: ';
      
      switch(error.code) {
        case 'auth/email-already-in-use':
          message += 'Email já está em uso';
          break;
        case 'auth/weak-password':
          message += 'Senha muito fraca';
          break;
        case 'auth/invalid-email':
          message += 'Email inválido';
          break;
        default:
          message += error.message;
      }
      
      this.showNotification(message, 'error');
    }
    
    this.authLoading = false;
  },

      // Nova função para cancelar operações
      cancelAllApiOperations() {
        this.activeApiTasks.clear();
        this.importModal.loading = false;
        this.importModal.show = false;
        this.importModal.progress = 0;
      },

    async confirmAddRecord() {
      const album = SecurityUtils.sanitizeText(this.newRecord.album);
      const artist = SecurityUtils.sanitizeText(this.newRecord.artist);
      const format = SecurityUtils.sanitizeText(this.newRecord.format);
      
      if (!album || !artist || !format) {
        this.showNotification('Preencha os campos obrigatórios', 'error');
        return;
      }
      
      if (album.length < 2 || artist.length < 2) {
        this.showNotification('Álbum e artista devem ter pelo menos 2 caracteres', 'error');
        return;
      }
      
      if (!SecurityUtils.rateLimiter.isAllowed(this.user.uid, 'add_record')) {
        this.showNotification('Muitas adições rápidas. Aguarde alguns segundos', 'error');
        return;
      }
      
      this.newRecord.album = album;
      this.newRecord.artist = artist;
      this.newRecord.format = format;
      this.newRecord.catalog_number = SecurityUtils.sanitizeText(this.newRecord.catalog_number);
      this.newRecord.description = SecurityUtils.sanitizeText(this.newRecord.description);
      
      // BUSCAR CAPA AUTOMATICAMENTE (SEMPRE, WISHLIST OU COLEÇÃO)
      if (!this.newRecord.cover_url) {
        await this.fetchAlbumCover();
      }

      const action = this.newRecord.isWishlist ? 'lista de desejos' : 'coleção';
      if (confirm(`Adicionar este item à ${action}?`)) {
        await this.addRecord();
      }
    },

        async addRecord() {
          this.formLoading = true;
          try {
            const userId = this.user.uid;
            const recordData = {
              album: this.newRecord.album,
              artist: this.newRecord.artist,
              format: this.newRecord.format,
              year: this.newRecord.year,
              catalog_number: this.newRecord.catalog_number,
              cover_url: this.newRecord.cover_url,
              description: this.newRecord.description,
              created_at: new Date(),
              user_id: userId,
              acquired: false // Para controlar se foi adquirido
            };

            const collection = this.newRecord.isWishlist ? 'wishlist' : 'records';

            if (this.newRecord.id) {
              await db.collection('users').doc(userId).collection(collection).doc(this.newRecord.id).update(recordData);
              this.showNotification('Item atualizado com sucesso!', 'success');
            } else {
              await db.collection('users').doc(userId).collection(collection).add(recordData);
              const target = this.newRecord.isWishlist ? 'lista de desejos' : 'coleção';
              this.showNotification(`Item adicionado à ${target}!`, 'success');
            }
            
            this.resetForm();
            this.currentView = this.newRecord.isWishlist ? 'wishlist' : 'collection';
          } catch (error) {
            console.error('Erro ao salvar:', error);
            this.showNotification('Erro ao salvar item', 'error');
          }
          this.formLoading = false;
        },

    editRecord(record) {
      // Fechar modal imediatamente
      this.albumDetailsModal.show = false;
      
      // Detectar se é da wishlist
      const isFromWishlist = this.wishlist.some(w => w.id === record.id);
      
      if (this.performanceMode) {
        this.showNotification('Carregando editor...', 'info');
        
        setTimeout(() => {
          this.newRecord = {
            id: record.id || '',
            album: record.album || '', 
            artist: record.artist || '', 
            format: record.format || '', 
            year: record.year || '', 
            catalog_number: record.catalog_number || '', 
            cover_url: record.cover_url || '',
            description: record.description || '',
            isWishlist: isFromWishlist
          };
          
          this.$nextTick(() => {
            this.currentView = 'add-record';
            this.showMobileSidebar = false;
            this.showNotification('Editando item...', 'info');
            setTimeout(() => lucide.createIcons(), 100);
          });
        }, 100);
      } else {
        this.newRecord = {
          id: record.id || '',
          album: record.album || '', 
          artist: record.artist || '', 
          format: record.format || '', 
          year: record.year || '', 
          catalog_number: record.catalog_number || '', 
          cover_url: record.cover_url || '',
          description: record.description || '',
          isWishlist: isFromWishlist
        };
        this.currentView = 'add-record';
        this.showMobileSidebar = false;
        this.showNotification('Editando item...', 'info');
      }
    },

    confirmDeleteRecord(recordId, isWishlist = false) {
      const target = isWishlist ? 'da lista de desejos' : '';
      if (confirm(`Deseja realmente excluir este item ${target}?`)) {
        this.deleteRecord(recordId, isWishlist);
      }
    },

    async moveToCollection(wishlistItem) {
      if (!confirm('Adicionar este álbum à sua coleção?')) return;
      
      try {
        const userId = this.user.uid;
        
        // Preparar para adicionar na coleção
        this.newRecord = {
          id: '',
          album: wishlistItem.album,
          artist: wishlistItem.artist,
          format: wishlistItem.format,
          year: wishlistItem.year || '',
          catalog_number: wishlistItem.catalog_number || '',
          cover_url: wishlistItem.cover_url || '',
          description: wishlistItem.description || '',
          isWishlist: false
        };
        
        // Remover da wishlist
        await db.collection('users').doc(userId).collection('wishlist').doc(wishlistItem.id).delete();
        
        // Mudar para tela de adicionar item
        this.albumDetailsModal.show = false;
        this.currentView = 'add-record';
        this.showNotification('Complete os dados e salve o item!', 'info');
        
      } catch (error) {
        console.error('Erro ao mover item:', error);
        this.showNotification('Erro ao mover item', 'error');
      }
    },

    async deleteRecord(recordId, isWishlist = false) {
      try {
        const userId = this.user.uid;
        const collection = isWishlist ? 'wishlist' : 'records';
        
        await db.collection('users').doc(userId).collection(collection).doc(recordId).delete();
        
        const message = isWishlist ? 'Item removido da lista de desejos!' : 'Item excluído com sucesso!';
        this.showNotification(message, 'success');
        
        // Fechar modal se estiver aberto
        this.albumDetailsModal.show = false;
        
      } catch (error) {
        console.error('Erro ao excluir:', error);
        this.showNotification('Erro ao excluir item', 'error');
      }
    },

    filterAndSortCollection() {
      let filtered = this.collection;
      
      if (this.searchFilter.trim()) {
        const filter = this.searchFilter.toLowerCase();
        if (this.performanceMode && this.searchIndex.size > 0) {
          filtered = filtered.filter(record => 
            this.searchIndex.get(record.id)?.includes(filter)
          );
        } else {
          filtered = filtered.filter(record => 
            record.album?.toLowerCase().includes(filter) ||
            record.artist?.toLowerCase().includes(filter) ||
            record.format?.toLowerCase().includes(filter) ||
            record.year?.toString().includes(filter)
          );
        }
      }
      
      this.filteredCollection = filtered;
      this.sortCollection();
      this.updatePagination();
      
      setTimeout(() => {
      lucide.createIcons();
      this.observeImages();
    }, 10);
    },

    // Getter para itens exibidos
    get displayedCollection() {
      if (!this.performanceMode) {
        return this.filteredCollection;
      }
      
      const start = (this.pagination.currentPage - 1) * this.pagination.itemsPerPage;
      const end = start + this.pagination.itemsPerPage;
      return this.filteredCollection.slice(start, end);
    },


    // Atualizar paginação
    updatePagination() {
        if (this.performanceMode) {
        this.pagination.totalPages = Math.ceil(this.filteredCollection.length / this.pagination.itemsPerPage);
        
        //Se a pagina atual ficou invalida voltar para a primeira
        if (this.pagination.currentPage > this.pagination.totalPages && this.pagination.totalPages > 0) {
          this.pagination.currentPage = 1;
        }
        
        //Se não ha paginas garantir que esta na página 1
        if (this.pagination.totalPages === 0) {
          this.pagination.currentPage = 1;
          this.pagination.totalPages = 1;
        }
      }
    },

    // Verificar se precisa modo performance
      checkPerformanceMode() {
      const wasPerformanceMode = this.performanceMode;
      this.performanceMode = true; // ✅ Sempre ativar paginação
      
      if (this.performanceMode && !wasPerformanceMode) {
        this.pagination = { currentPage: 1, itemsPerPage: 50, totalPages: 1 };
        this.buildSearchIndex();
      } else if (!this.performanceMode && wasPerformanceMode) {
        this.pagination = { currentPage: 1, itemsPerPage: 50, totalPages: 1 };
      }
    },

    // Construir índice de busca
    buildSearchIndex() {
      this.searchIndex.clear();
      this.collection.forEach(record => {
        const searchText = [
          record.album,
          record.artist,
          record.format,
          record.year?.toString(),
          record.catalog_number
        ].join(' ').toLowerCase();
        
        this.searchIndex.set(record.id, searchText);
      });
    },

    // Correção automática de nomes de bandas
    async autoCorrectArtistNames() {
        this.showNotification('Iniciando correção de nomes...', 'info');
        const userId = this.user.uid;
        const taskId = `correct-${Date.now()}`;
        this.activeApiTasks.add(taskId);
        
        let corrected = 0;
        
        try {
          for (const record of this.collection) {
            // Verificar se foi cancelado
            if (!this.activeApiTasks.has(taskId)) {
              this.showNotification('Operação cancelada', 'info');
              return;
            }
            
            if (!record.artist || !record.album) continue;
            
            try {
              const query = `${record.artist} ${record.album}`;
              const itunesUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=album&limit=1`;
              
              const response = await fetch(itunesUrl);
              if (response.ok) {
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                  const album = data.results[0];
                  let needsUpdate = false;
                  const updates = {};
                  
                  if (album.artistName && album.artistName !== record.artist) {
                    updates.artist = album.artistName;
                    needsUpdate = true;
                  }
                  
                  if (album.collectionName && album.collectionName !== record.album) {
                    updates.album = album.collectionName;
                    needsUpdate = true;
                  }
                  
                  if (album.releaseDate && !record.year) {
                    updates.year = new Date(album.releaseDate).getFullYear();
                    needsUpdate = true;
                  }
                  
                  if (needsUpdate) {
                    await db.collection('users').doc(userId).collection('records')
                      .doc(record.id).update(updates);
                    corrected++;
                  }
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, this.requestDelay));
            } catch (error) {
              console.log(`Erro ao corrigir: ${record.artist} - ${record.album}`);
            }
          }
          
          this.showNotification(`${corrected} itens corrigidos!`, 'success');
        } finally {
          this.activeApiTasks.delete(taskId);
        }
      },
      
    // Buscar anos ausentes
    async fillMissingYears() {
      this.showNotification('Buscando anos ausentes...', 'info');
      const userId = this.user.uid;
      const taskId = `years-${Date.now()}`;
      this.activeApiTasks.add(taskId);
      
      const itemsWithoutYear = this.collection.filter(record => !record.year);
      let updated = 0;
      
      try {
        for (const record of itemsWithoutYear) {
          // Verificar se foi cancelado
          if (!this.activeApiTasks.has(taskId)) {
            this.showNotification('Operação cancelada', 'info');
            return;
          }
          
          try {
            const query = `${record.artist} ${record.album}`;
            const itunesUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=album&limit=1`;
            
            const response = await fetch(itunesUrl);
            if (response.ok) {
              const data = await response.json();
              if (data.results && data.results.length > 0) {
                const album = data.results[0];
                if (album.releaseDate) {
                  const year = new Date(album.releaseDate).getFullYear();
                  await db.collection('users').doc(userId).collection('records')
                    .doc(record.id).update({ year });
                  updated++;
                }
              }
            }
            
            await new Promise(resolve => setTimeout(resolve, this.requestDelay));
          } catch (error) {
            console.log(`Erro ao buscar ano: ${record.artist} - ${record.album}`);
          }
        }
        
        this.showNotification(`${updated} anos adicionados!`, 'success');
      } finally {
        this.activeApiTasks.delete(taskId);
      }
    },

    // Ordenação separada
    sortCollection() {
      this.filteredCollection.sort((a, b) => {
        let valueA, valueB;
        
        switch(this.sortBy) {
          case 'album':
            valueA = (a.album || '').toLowerCase();
            valueB = (b.album || '').toLowerCase();
            break;
          case 'artist':
            // Ordenar por artista
            valueA = (a.artist || '').toLowerCase();
            valueB = (b.artist || '').toLowerCase();
            
            // Se artistas forem iguais, ordenar por ano crescente
            if (valueA === valueB) {
              const yearA = parseInt(a.year) || 0;
              const yearB = parseInt(b.year) || 0;
              return yearA - yearB; // Sempre crescente (1980, 1981...)
            }
            break;
          case 'year':
            valueA = parseInt(a.year) || 0;
            valueB = parseInt(b.year) || 0;
            break;
          default:
            return 0;
        }
        
        if (this.sortOrder === 'asc') {
          return valueA > valueB ? 1 : valueA < valueB ? -1 : 0;
        } else {
          return valueA < valueB ? 1 : valueA > valueB ? -1 : 0;
        }
      });
    },

  // =============================================================================
  // SISTEMA DE LAZY LOADING DE IMAGENS
  // =============================================================================
  // Carrega imagens apenas quando estão prestes a aparecer na tela
  // Melhora performance significativamente em coleções grandes

  // Inicializa o sistema universal de lazy loading
  initUniversalLazyLoading() {
      // Desconectar observer anterior se existir
      if (this.imageObserver) {
        this.imageObserver.disconnect();
      }
      
      // -------------------------------------------------------------------------
      // CALLBACK DO INTERSECTION OBSERVER
      // -------------------------------------------------------------------------
      // Executado quando uma imagem entra na área de observação
      const observerCallback = (entries) => {
        entries.forEach(entry => {
          // Verificar se a imagem está visível (ou perto de ficar)
          if (entry.isIntersecting) {
            const img = entry.target;
            const src = img.dataset.src; // URL real da imagem
            
            if (src) {
              // Criar imagem temporária em memória para pré-carregar
              const tempImg = new Image();
              
              // Callback de sucesso no carregamento
              tempImg.onload = () => {
                img.src = src; // Atribuir URL real ao elemento
                img.removeAttribute('data-src'); // Remover data-src para não recarregar
              };
              
              // Callback de erro no carregamento
              tempImg.onerror = () => {
                console.error(`Erro ao carregar a imagem: ${src}`);
                img.removeAttribute('data-src');
                // Opcional: definir imagem de fallback
                // img.src = '/path/to/error-image.png';
              };
              
              // Iniciar download da imagem
              tempImg.src = src;
            }
            
            // Parar de observar esta imagem (já foi carregada)
            this.imageObserver.unobserve(img);
          }
        });
      };

      // -------------------------------------------------------------------------
      // OPÇÕES DO OBSERVER
      // -------------------------------------------------------------------------
      const observerOptions = {
        // rootMargin: área extra ao redor da viewport
        // 300px significa que a imagem começa a carregar quando está
        // a 300 pixels de distância da tela (antes de ficar visível)
        rootMargin: '300px',
        
        // threshold: porcentagem mínima de visibilidade para disparar
        // 0.01 = começa a carregar assim que 1% da imagem aparece
        threshold: 0.01
      };
      
      // Criar instância do IntersectionObserver
      this.imageObserver = new IntersectionObserver(observerCallback, observerOptions);
      
      console.log('Lazy loading universal inicializado');
    },

    // Observa todas as imagens com atributo data-src na página
    observeImages() {
      // Para visualização compartilhada, não usar observer (forçar carregamento)
      if (this.isSharedView) {
        return;
      }

      // Para coleção normal, usar intersection observer
      requestAnimationFrame(() => {
        const images = document.querySelectorAll('img[data-src]');
        console.log(`🔍 Encontradas ${images.length} imagens para observar`);
        
        images.forEach(img => {
          // Verificar se imagem já não está sendo observada
          if (!img.dataset.observed) {
            img.dataset.observed = 'true';
            this.imageObserver.observe(img);
          }
        });
      });
    },

    // Força carregamento imediato de todas as imagens (modo compartilhado)
    forceLoadSharedImages() {
      if (!this.isSharedView) return;
      lucide.createIcons();
      
      // Carregar todas as imagens imediatamente
      const images = document.querySelectorAll('img[data-src]');
      images.forEach(img => {
        const src = img.dataset.src;
        if (src) {
          img.src = src;
          img.removeAttribute('data-src');
        }
      });
    },

    // Limpa e desconecta o observer de imagens
    cleanupObserver() {
      if (this.imageObserver) {
        this.imageObserver.disconnect();
        this.imageObserver = null;
      }
    },

    filterCollection() {
      this.pagination.currentPage = 1;
      this.filterAndSortCollection();
    },

    setSortBy(field) {
      if (this.sortBy === field) {
        this.toggleSortOrder();
      } else {
        this.sortBy = field;
        this.sortOrder = 'asc';
      }
      this.filterAndSortCollection();
      setTimeout(() => lucide.createIcons(), 10);
    },

    toggleSortOrder() {
      this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
      this.filterAndSortCollection();
      setTimeout(() => lucide.createIcons(), 10);
    },

    resetForm() {
    this.newRecord = {
      album: '', 
      artist: '', 
      format: '', 
      year: '', 
      catalog_number: '', 
      cover_url: '',
      description: '',
      isWishlist: false
    };
  },

    searchCoverOnGoogle() {
      const query = `${this.newRecord.album} ${this.newRecord.artist} album cover`;
      window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`, '_blank');
    },

   async fetchAlbumCover() {
      try {
        const query = `${this.newRecord.album} ${this.newRecord.artist}`.trim();
        if (!query) return;
        
        this.showNotification('Buscando capa...', 'info');
        
        const taskId = Date.now();
        this.activeApiTasks.add(taskId);
        
        try {
          const itunesUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=album&limit=1`;
          
          const response = await fetch(itunesUrl);
          
          // Verificar se ainda está ativa
          if (!this.activeApiTasks.has(taskId)) return;
          
          if (!response.ok) {
            throw new Error('Erro na busca do iTunes');
          }
          
          const data = await response.json();

          if (data.results && data.results.length > 0) {
            const album = data.results[0];
            if (album.artworkUrl100) {
              const highResUrl = album.artworkUrl100.replace('100x100bb', '600x600bb');
              this.newRecord.cover_url = highResUrl;
              this.showNotification('Capa encontrada automaticamente!', 'success');
              return;
            }
          }

          this.showNotification('Nenhuma capa encontrada automaticamente', 'info');
        } finally {
          this.activeApiTasks.delete(taskId);
        }
        
      } catch (error) {
        console.error('Erro ao buscar capa:', error);
        this.showNotification('Não foi possível buscar capa automática', 'error');
      }
    },

    toggleTheme() {
      this.darkMode = !this.darkMode;
      localStorage.setItem('katalog-theme', this.darkMode ? 'dark' : 'light');
    },

    async updateDisplayName() {
        if (!this.newDisplayName?.trim()) {
            this.showNotification('Digite um novo nome', 'error');
            return;
        }

        const sanitizedName = SecurityUtils.sanitizeText(this.newDisplayName);
        
        if (sanitizedName.length < 2) {
            this.showNotification('Nome deve ter pelo menos 2 caracteres', 'error');
            return;
        }

        try {
            await this.user.updateProfile({ displayName: sanitizedName });
            
            await db.collection('users').doc(this.user.uid).set({
            displayName: sanitizedName,
            email: this.user.email,
            updatedAt: new Date()
            }, { merge: true });
            
            this.showNotification('Nome atualizado com sucesso!', 'success');
            this.newDisplayName = '';
        } catch (error) {
            console.error('Erro ao atualizar nome:', error);
            this.showNotification('Erro ao atualizar nome', 'error');
        }
    },

    async updatePassword() {
        if (!this.currentPassword || !this.newPassword || !this.confirmNewPassword) {
            this.showNotification('Preencha todos os campos', 'error');
            return;
        }

        if (this.newPassword.length < 8) {
            this.showNotification('Nova senha deve ter pelo menos 8 caracteres', 'error');
            return;
        }

        if (this.newPassword !== this.confirmNewPassword) {
            this.showNotification('As senhas não coincidem', 'error');
            return;
        }

        if (this.currentPassword === this.newPassword) {
            this.showNotification('A nova senha deve ser diferente da atual', 'error');
            return;
        }

        this.passwordUpdateLoading = true;

        try {
            const user = firebase.auth().currentUser;
            
            // Reautenticar usuário
            const credential = firebase.auth.EmailAuthProvider.credential(
            user.email,
            this.currentPassword
            );
            
            await user.reauthenticateWithCredential(credential);
            
            // Alterar senha
            await user.updatePassword(this.newPassword);
            
            this.showNotification('Senha alterada com sucesso!', 'success');
            
            // Limpar campos
            this.currentPassword = '';
            this.newPassword = '';
            this.confirmNewPassword = '';
            
        } catch (error) {
            console.error('Erro ao alterar senha:', error);
            
            let message = 'Erro ao alterar senha';
            
            switch(error.code) {
            case 'auth/wrong-password':
                message = 'Senha atual incorreta';
                break;
            case 'auth/weak-password':
                message = 'Nova senha é muito fraca';
                break;
            case 'auth/requires-recent-login':
                message = 'Por segurança, faça login novamente antes de alterar a senha';
                break;
            default:
                message = `Erro: ${error.message}`;
            }
            
            this.showNotification(message, 'error');
        }
        
        this.passwordUpdateLoading = false;
        },

    confirmLogout() {
        // Limpar listener do Firestore
        if (this.unsubscribe) {
          this.unsubscribe();
          this.unsubscribe = null;
        }
        
        this.cleanupObserver();
        
        // Limpar observer de imagens (REMOVER SE EXISTIR - está duplicado)
        // if (this.imageObserver) { ... } <- REMOVER ESTE BLOCO
        
        // Limpar timeouts
        if (this.observeTimeout) {
          clearTimeout(this.observeTimeout);
        }
        
        // Cancelar operações em andamento
        this.cancelAllApiOperations();
        
        if (confirm('Deseja realmente sair?')) {
          auth.signOut();
          this.showNotification('Logout realizado com sucesso!', 'success');
        }
      },

    confirmDeleteAccount() {
      this.deleteAccountModal = { 
        show: true, 
        email: '', 
        password: '', 
        confirmed: false, 
        loading: false 
      };
      this.configModal = false;
    },

    cancelDeleteAccount() {
      this.deleteAccountModal = { 
        show: false, 
        email: '', 
        password: '', 
        confirmed: false, 
        loading: false 
      };
    },

    async proceedDeleteAccount() {
      if (!this.deleteAccountModal.email || !this.deleteAccountModal.password || !this.deleteAccountModal.confirmed) {
        this.showNotification('Preencha todos os campos e confirme a ação', 'error');
        return;
      }

      if (this.deleteAccountModal.email !== this.user.email) {
        this.showNotification('Email não confere com o da conta', 'error');
        return;
      }

      this.deleteAccountModal.loading = true;
      
      try {
        const user = firebase.auth().currentUser;
        
        const credential = firebase.auth.EmailAuthProvider.credential(
          this.deleteAccountModal.email.trim(), 
          this.deleteAccountModal.password
        );
        
        await user.reauthenticateWithCredential(credential);

        const userId = user.uid;
        const recordsSnapshot = await db.collection('users').doc(userId).collection('records').get();
        
        if (!recordsSnapshot.empty) {
          const batch = db.batch();
          recordsSnapshot.forEach(doc => batch.delete(doc.ref));
          await batch.commit();
        }

        await db.collection('users').doc(userId).delete();
        await user.delete();

          // Limpar estado local
          this.user = null;
          this.collection = [];
          this.filteredCollection = [];
          localStorage.clear(); // Limpar todos os dados locais

          this.showNotification('Conta excluída com sucesso!', 'success');
          this.cancelDeleteAccount();

          // Aguardar notificação aparecer e então recarregar
          setTimeout(() => {
            window.location.href = window.location.origin + window.location.pathname;
          }, 2000);

        } catch (error) {
        console.error('Erro ao excluir conta:', error);
        
        let errorMessage = 'Erro ao excluir conta';
        
        switch(error.code) {
          case 'auth/wrong-password':
            errorMessage = 'Senha incorreta';
            break;
          case 'auth/too-many-requests':
            errorMessage = 'Muitas tentativas. Tente novamente mais tarde';
            break;
          case 'auth/requires-recent-login':
            errorMessage = 'É necessário fazer login novamente antes de excluir a conta';
            break;
          case 'auth/user-token-expired':
            errorMessage = 'Sessão expirada. Faça login novamente';
            break;
          default:
            errorMessage = `Erro: ${error.message}`;
        }
            
        this.showNotification(errorMessage, 'error');
      }
      
      this.deleteAccountModal.loading = false;
    },
        
  // =============================================================================
// SISTEMA DE UPLOAD E IMPORTAÇÃO DE ARQUIVOS
// =============================================================================

// Processa upload de arquivo Excel/CSV para importação
// Inclui validações de segurança, tamanho e formato
// @param {Event} event - Evento do input file
handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  // -------------------------------------------------------------------------
  // 1. VERIFICAÇÃO DE BLOQUEIO PARA USUÁRIOS NÃO VERIFICADOS
  // -------------------------------------------------------------------------
  // Usuários sem email verificado tem limite de 2 imports de 100 itens cada
  if (!this.user.emailVerified && this.importTracking.isBlocked) {
    this.showNotification(
      'Você atingiu o limite de imports. Verifique seu email para continuar!',
      'error'
    );
    event.target.value = '';
    
    // Exibir modal de verificação
    this.showEmailVerification = true;
    return;
  }

  // -------------------------------------------------------------------------
  // 2. PROTEÇÃO CONTRA SPAM/ABUSO
  // -------------------------------------------------------------------------
  // Sistema de rate limiting para uploads
  const uploadCheck = this.canUpload();
  if (!uploadCheck.allowed) {
    this.showNotification(uploadCheck.message, 'error');
    event.target.value = '';
    return;
  }

  // -------------------------------------------------------------------------
  // 3. VALIDAÇÃO DE TAMANHO
  // -------------------------------------------------------------------------
  const maxSize = 10 * 1024 * 1024; // 10MB
  if (file.size > maxSize) {
    this.showNotification('Arquivo muito grande! Máximo: 10MB', 'error');
    event.target.value = '';
    return;
  }

  // -------------------------------------------------------------------------
  // 4. VALIDAÇÃO DE TIPO/FORMATO
  // -------------------------------------------------------------------------
  const validTypes = [
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
    'application/vnd.ms-excel', // .xls
    'text/csv' // .csv
  ];
  
  if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
    this.showNotification('Formato inválido! Use .xlsx, .xls ou .csv', 'error');
    event.target.value = '';
    return;
  }

  // -------------------------------------------------------------------------
  // 5. LEITURA DO ARQUIVO
  // -------------------------------------------------------------------------
  this.importModal.loading = true;
  this.importModal.progress = 0;
  this.importModal.progressText = 'Lendo arquivo...';

  const reader = new FileReader();
  
  // Callback executado quando arquivo for lido com sucesso
  reader.onload = async (e) => {
    try {
      this.importModal.progress = 30;
      this.importModal.progressText = 'Analisando conteúdo...';
      
      // -----------------------------------------------------------------------
      // PROCESSAMENTO DO EXCEL
      // -----------------------------------------------------------------------
      // Usar biblioteca XLSX para ler o arquivo
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      
      this.importModal.progress = 60;
      this.importModal.progressText = 'Processando dados...';
      
      // Pegar primeira planilha e converter para JSON
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet);

      // -----------------------------------------------------------------------
      // LIMITES PROGRESSIVOS POR TIPO DE CONTA
      // -----------------------------------------------------------------------
      let maxRecords = 3000; // Limite para contas verificadas
      
      if (!this.user.emailVerified) {
        maxRecords = 100; // Limite para contas não verificadas
        
        if (jsonData.length > maxRecords) {
          this.showNotification(
            `Usuários não verificados podem importar no máximo ${maxRecords} registros por vez. Verifique seu email!`,
            'error'
          );
          this.importModal.loading = false;
          event.target.value = '';
          return;
        }
      } else {
        if (jsonData.length > maxRecords) {
          this.showNotification(`Máximo de ${maxRecords} registros por vez`, 'error');
          this.importModal.loading = false;
          event.target.value = '';
          return;
        }
      }

      // Verificar se arquivo não está vazio
      if (jsonData.length === 0) {
        this.showNotification('Arquivo vazio ou formato incorreto', 'error');
        this.importModal.loading = false;
        event.target.value = '';
        return;
      }

      this.importModal.progress = 90;
      this.importModal.progressText = 'Validando registros...';
      
      await new Promise(resolve => setTimeout(resolve, 300));
      
      // -----------------------------------------------------------------------
      // PROCESSAR E VALIDAR DADOS
      // -----------------------------------------------------------------------
      this.processImportData(jsonData);
      
      // Se importação for muito grande (>500 itens), mostrar aviso
      if (this.importModal.data.length > 500) {
        this.largeImportModal = {
          show: true,
          totalItems: this.importModal.data.length,
          skipCovers: false
        };
        this.importModal.loading = false;
        return;
      }
      
      this.importModal.progress = 100;
      this.importModal.progressText = 'Arquivo processado!';
      
      await new Promise(resolve => setTimeout(resolve, 300));
      this.showNotification('Arquivo processado com sucesso!', 'success');
      
    } catch (error) {
      console.error('Erro ao processar arquivo:', error);
      this.showNotification('Erro ao processar arquivo', 'error');
    } finally {
      this.importModal.loading = false;
      this.importModal.progress = 0;
    }
  };
  
  // Callback de erro ao ler arquivo
  reader.onerror = () => {
    this.showNotification('Erro ao ler arquivo', 'error');
    this.importModal.loading = false;
    event.target.value = '';
  };
  
  // Iniciar leitura do arquivo como ArrayBuffer
  reader.readAsArrayBuffer(file);
},

//Importação do Excel
    processImportData(data) {
      const validRecords = data.filter(row => 
        row.album && row.artist && row.format
      ).map(row => ({
        album: row.album?.toString().trim(),
        artist: row.artist?.toString().trim(),
        format: row.format?.toString().trim(),
        year: row.year ? parseInt(row.year) : '',
        catalog_number: row.catalog_number?.toString().trim() || '',
        cover_url: row.cover_url?.toString().trim() || '',
        description: row.description?.toString().trim() || ''
      }));

      this.importModal.data = validRecords;
      this.importModal.preview = validRecords.slice(0, 3);

      if (validRecords.length === 0) {
        this.showNotification('Nenhum registro válido encontrado no arquivo', 'error');
      }
    },
              
    // Verificar se é import grande antes de importar
    async importRecords() {
      if (this.importModal.data.length === 0) return;
      
      if (this.importModal.data.length > 200) {
        this.largeImportModal = {
          show: true,
          totalItems: this.importModal.data.length,
          skipCovers: false
        };
        return;
      }
      
      await this.executeImport(false);
    },

    // Prosseguir com import grande
    async proceedLargeImport() {
      this.largeImportModal.show = false;
      await this.executeImport(this.largeImportModal.skipCovers);
    },

    // Cancelar import grande
    cancelLargeImport() {
      this.largeImportModal = {
        show: false,
        totalItems: 0,
        skipCovers: false
      };
    },

    // Cancelar upload seguro
      cancelSecureUpload() {
          if (window.hcaptcha) {
            try {
              window.hcaptcha.reset();
            } catch (e) {
              console.log('Erro ao resetar hCaptcha:', e);
            }
          }
          
          this.uploadSecurityCheck = {
            show: false,
            captchaToken: null,
            fileSize: 0,
            recordCount: 0
          };
          this.importModal.data = [];
          this.importModal.preview = [];
          
          const fileInput = document.querySelector('input[type="file"]');
          if (fileInput) fileInput.value = '';
        },

      // Prosseguir com upload após CAPTCHA
      async proceedWithSecureUpload() {
        if (!this.uploadSecurityCheck.captchaToken) {
          this.showNotification('Complete a verificação primeiro', 'error');
          return;
        }
        
        console.log('Token válido, prosseguindo...', this.uploadSecurityCheck.captchaToken);
        
        this.uploadSecurityCheck.show = false;
        this.importModal.loading = false;
        
        // Limpar o token após uso
        const token = this.uploadSecurityCheck.captchaToken;
        this.uploadSecurityCheck.captchaToken = null;
        
        this.showNotification('Verificação concluída! Arquivo pronto para importar', 'success');
        
        // Reset do hCaptcha para próximo uso
        if (window.hcaptcha) {
          try {
            window.hcaptcha.reset();
          } catch (e) {
            console.log('Não foi possível resetar hCaptcha:', e);
          }
        }
      },

    // Executar o import
    async executeImport(skipCovers = false) {
      if (this.importModal.data.length === 0) return;

      this.importModal.loading = true;
      this.importModal.progress = 0;
      this.importModal.progressText = 'Iniciando importação...';
      
      try {
        const userId = this.user.uid;
        const totalItems = this.importModal.data.length;
        const BATCH_SIZE = 500;
        let processed = 0;

        this.showNotification(`Importando ${totalItems} itens...`, 'info');

        // Buscar capas
        if (!skipCovers) {
          this.importModal.progressText = 'Buscando capas...';
          
          for (let i = 0; i < this.importModal.data.length; i++) {
            const record = this.importModal.data[i];
            
            const coverProgress = Math.floor((i / totalItems) * 50);
            this.importModal.progress = coverProgress;
            this.importModal.progressText = `Buscando capa ${i + 1} de ${totalItems}...`;
            
            if (!record.cover_url && record.album && record.artist) {
              try {
                const query = `${record.album} ${record.artist}`.trim();
                const itunesUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=album&limit=1`;
                
                const response = await fetch(itunesUrl);
                if (response.ok) {
                  const data = await response.json();
                  if (data.results && data.results.length > 0) {
                    const album = data.results[0];
                    if (album.artworkUrl100) {
                      record.cover_url = album.artworkUrl100.replace('100x100bb', '600x600bb');
                    }
                  }
                }
              } catch (error) {
                console.log(`Erro ao buscar capa: ${record.album}`);
              }
              
              await new Promise(resolve => setTimeout(resolve, 100));
            }
          }
        }

        // Salvar em lotes
        this.importModal.progressText = 'Salvando registros...';
        
        for (let i = 0; i < this.importModal.data.length; i += BATCH_SIZE) {
          const chunk = this.importModal.data.slice(i, i + BATCH_SIZE);
          const batch = db.batch();
          
          chunk.forEach(record => {
            const docRef = db.collection('users').doc(userId).collection('records').doc();
            batch.set(docRef, {
              ...record,
              created_at: new Date(),
              user_id: userId
            });
          });
          
          await batch.commit();
          processed += chunk.length;
          
          const saveProgress = 50 + Math.floor((processed / totalItems) * 50);
          this.importModal.progress = saveProgress;
          this.importModal.progressText = `Salvando ${processed} de ${totalItems}...`;
          
          await new Promise(resolve => setTimeout(resolve, 200));
        }

        // ATUALIZAR CONTADOR PARA USUÁRIOS NÃO VERIFICADOS
        if (!this.user.emailVerified) {
          this.importTracking.totalImported += totalItems;
          this.importTracking.importCount++;
          
          // Salvar no localStorage para persistir entre sessões
          localStorage.setItem(`import_tracking_${userId}`, JSON.stringify({
            totalImported: this.importTracking.totalImported,
            importCount: this.importTracking.importCount,
            lastImport: new Date().toISOString()
          }));
          
          // Bloquear após 2 imports
          if (this.importTracking.importCount >= 2) {
            this.importTracking.isBlocked = true;
            
            this.showNotification(
              `Você atingiu o limite de ${this.importTracking.importCount} importações (${this.importTracking.totalImported} registros). Verifique seu email para continuar!`,
              'error'
            );
            
            // Mostrar tela de verificação automaticamente
            setTimeout(() => {
              this.showEmailVerification = true;
            }, 2000);
          } else {
            // Aviso de quantos imports restam
            const remaining = 2 - this.importTracking.importCount;
            this.showNotification(
              `Import concluído! Você pode fazer mais ${remaining} importação(ões) antes de precisar verificar o email.`,
              'info'
            );
          }
        }

        this.importModal.progress = 100;
        this.importModal.progressText = 'Importação concluída!';
        
        await new Promise(resolve => setTimeout(resolve, 500));
        
        if (this.user.emailVerified || this.importTracking.importCount < 2) {
          this.showNotification(`${totalItems} itens importados!`, 'success');
        }
        
        this.closeImportModal();
        
      } catch (error) {
        console.error('Erro na importação:', error);
        this.showNotification('Erro ao importar registros', 'error');
      }
      
      this.importModal.loading = false;
      this.importModal.progress = 0;
    },

    // Iniciar busca automática de capas
    async startAutoCoverSearch() {
      if (this.collection.length === 0) {
        this.showNotification('Nenhum item na coleção', 'error');
        return;
      }
      
      const itemsWithoutCovers = this.collection.filter(record => !record.cover_url);
      
      if (itemsWithoutCovers.length === 0) {
        this.showNotification('Todos os itens já possuem capas!', 'info');
        return;
      }
      
      if (confirm(`Buscar capas para ${itemsWithoutCovers.length} itens sem capa?`)) {
        await this.searchMissingCovers(itemsWithoutCovers);
      }
    },

    // Buscar capas ausentes
      async searchMissingCovers(items) {
        this.importModal.loading = true;
        this.importModal.show = true;
        this.importModal.progress = 0;
        this.importModal.progressText = 'Buscando capas ausentes...';
        
        try {
          const userId = this.user.uid;
          const totalItems = items.length;
          let updated = 0;
          
          for (let i = 0; i < items.length; i++) {
            const record = items[i];
            
            const progress = Math.floor((i / totalItems) * 100);
            this.importModal.progress = progress;
            this.importModal.progressText = `Buscando capa ${i + 1} de ${totalItems}...`;
            
            try {
              const query = `${record.album} ${record.artist}`.trim();
              const itunesUrl = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&entity=album&limit=1`;
              
              // LINHA COM ERRO - ADICIONAR A BUSCA
              const response = await fetch(itunesUrl);
              
              if (response.ok) {
                const data = await response.json();
                if (data.results && data.results.length > 0) {
                  const album = data.results[0];
                  if (album.artworkUrl100) {
                    const highResUrl = album.artworkUrl100.replace('100x100bb', '600x600bb');
                    
                    await db.collection('users').doc(userId).collection('records')
                      .doc(record.id).update({ cover_url: highResUrl });
                    
                    updated++;
                  }
                }
              }
            } catch (error) {
              console.log(`Erro ao buscar capa para: ${record.album} - ${record.artist}`);
            }
            
            await new Promise(resolve => setTimeout(resolve, 150));
          }
          
          this.importModal.progress = 100;
          this.importModal.progressText = 'Busca concluída!';
          
          await new Promise(resolve => setTimeout(resolve, 500));
          
          this.showNotification(`${updated} capas encontradas e atualizadas!`, 'success');
          
        } catch (error) {
          console.error('Erro na busca de capas:', error);
          this.showNotification('Erro ao buscar capas', 'error');
        }
        
        this.importModal.loading = false;
        this.importModal.show = false;
        this.importModal.progress = 0;
      },

    closeImportModal() {
      this.importModal = { 
        show: false, 
        data: [], 
        preview: [], 
        loading: false, 
        progress: 0, 
        progressText: 'Iniciando...' 
      };
      const fileInput = document.querySelector('input[type="file"]');
      if (fileInput) fileInput.value = '';
    },

    // Export de coleção (backup) em arquivo Excel
    exportToExcel() {
      if (this.collection.length === 0) {
        this.showNotification('Nenhum item na coleção para exportar', 'error');
        return;
      }

      try {
        const exportData = this.collection.map(record => ({
          'Álbum': record.album || '',
          'Artista': record.artist || '',
          'Formato': record.format || '',
          'Ano': record.year || '',
          'Número de Catálogo': record.catalog_number || '',
          'URL da Capa': record.cover_url || '',
          'Descrição': record.description || '',
          'Data de Adição': record.created_at ? new Date(record.created_at.seconds * 1000).toLocaleDateString('pt-BR') : ''
        }));

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        
        ws['!cols'] = [
          { wch: 30 }, // Álbum
          { wch: 25 }, // Artista  
          { wch: 10 }, // Formato
          { wch: 8 },  // Ano
          { wch: 20 }, // Número de Catálogo
          { wch: 50 }, // URL da Capa
          { wch: 40 }, // Descrição
          { wch: 15 }  // Data de Adição
        ];

        XLSX.utils.book_append_sheet(wb, ws, "Minha Coleção");

        const today = new Date().toISOString().split('T')[0];
        const fileName = `katalog-backup-${today}.xlsx`;

        XLSX.writeFile(wb, fileName);

        this.showNotification(`Backup exportado: ${fileName}`, 'success');
        
      } catch (error) {
        console.error('Erro ao exportar:', error);
        this.showNotification('Erro ao gerar backup', 'error');
      }
    },

    showNotification(message, type = 'success') {
      this.notification = { show: true, message, type };
      setTimeout(() => {
        this.notification.show = false;
      }, 4000);
      setTimeout(() => lucide.createIcons(), 10);
    }
})); // Fechamento do Alpine.data('app')
}); // Fechamento do document.addEventListener('alpine:init')

// Callbacks do hCaptcha (escopo global)
window.hcaptchaOnSuccess = function(token) {
  console.log('hCaptcha token recebido:', token);
  const app = document.querySelector('[x-data="app"]');
  if (app && app.__x) {
    app.__x.$data.uploadSecurityCheck.captchaToken = token;
    app.__x.$data.showNotification('Verificação concluída!', 'success');
  }
};

window.hcaptchaOnExpired = function() {
  console.log('hCaptcha expirado');
  const app = document.querySelector('[x-data="app"]');
  if (app && app.__x) {
    app.__x.$data.uploadSecurityCheck.captchaToken = null;
    app.__x.$data.showNotification('Verificação expirada. Tente novamente', 'error');
  }
};

window.hcaptchaOnError = function(error) {
  console.error('Erro no hCaptcha:', error);
  const app = document.querySelector('[x-data="app"]');
  if (app && app.__x) {
    app.__x.$data.showNotification('Erro na verificação. Tente novamente', 'error');
  }
};

// Inicializar ícones após carregamento
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(() => lucide.createIcons(), 100);
  setInterval(() => lucide.createIcons(), 1000);
});
  </script>
</body>
</html>

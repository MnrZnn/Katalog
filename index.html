<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Katalog</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  
  <!-- Firebase SDKs - Vers√£o Compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <!-- SheetJS para Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #121212; color: #E0E0E0; }
    .bg-card { background-color: #1E1E1E; }
    .bg-input { background-color: #2A2A2A; }
    .border-custom { border-color: #383838; }
    .btn-primary { background-color: #1DB954; color: #FFFFFF; }
    .btn-primary:hover { background-color: #1ED760; }
    .btn-danger { background-color: #dc2626; color: #FFFFFF; }
    .btn-danger:hover { background-color: #b91c1c; }
    .btn-secondary { background-color: #4A4A4A; color: #FFFFFF; }
    .btn-secondary:hover { background-color: #5A5A5A; }
    .btn-primary:disabled, button:disabled { background-color: #555; color: #aaa; cursor: not-allowed; }
    .placeholder-custom::placeholder { color: #888888; }
    [x-cloak] { display: none !important; }
    .format-badge {
      @apply px-2 py-1 text-xs font-semibold rounded-full;
    }
    .format-cd { @apply bg-blue-500 text-white; }
    .format-vinil { @apply bg-purple-500 text-white; }
    .format-cassete { @apply bg-orange-500 text-white; }
    .format-digital { @apply bg-green-500 text-white; }
    .footer-info { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      z-index: 40;
      background: rgba(30, 30, 30, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid #383838;
    }
  </style>
</head>
<body x-data="app" x-init="init()" x-cloak>

  <!-- Loading -->
  <div x-show="isLoading" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="flex flex-col items-center text-center p-4">
      <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
      <p class="text-white mt-4 text-lg" x-text="loadingMessage"></p>
    </div>
  </div>

  <!-- Notifica√ß√£o -->
  <div x-show="notification.show"
       class="fixed top-5 right-5 z-50 p-4 rounded-md shadow-lg text-white max-w-sm"
       :class="{'bg-green-600': notification.type === 'success', 'bg-red-600': notification.type === 'error', 'bg-blue-600': notification.type === 'info'}"
       x-transition>
    <p x-text="notification.message"></p>
  </div>

  <!-- Modal Compartilhar -->
  <div x-show="shareModal.show" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="shareModal.show = false">
    <div class="bg-card p-8 rounded-lg max-w-md w-full mx-4">
      <h3 class="text-xl font-bold mb-4">üéµ Compartilhar Minha Cole√ß√£o</h3>
      <p class="text-gray-400 mb-4">Copie este link para compartilhar sua cole√ß√£o:</p>
      <div class="flex space-x-2">
        <input :value="shareModal.url" readonly 
               class="flex-1 p-3 bg-input border border-custom rounded-md text-sm">
        <button @click="copyShareLink()" class="px-4 py-3 btn-primary rounded-md">
          <i data-lucide="copy" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="flex justify-end mt-4">
        <button @click="shareModal.show = false" class="px-4 py-2 btn-secondary rounded-md">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal Editar -->
  <div x-show="editModal.show" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="editModal.show = false">
    <div class="bg-card p-8 rounded-lg max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
      <h3 class="text-xl font-bold mb-4">‚úèÔ∏è Editar Item</h3>
      <form @submit.prevent="updateRecord()" class="space-y-4">
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">√Ålbum/T√≠tulo *</label>
            <input x-model="editModal.record.album" required 
                   class="w-full p-3 bg-input border border-custom rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Artista *</label>
            <input x-model="editModal.record.artist" required 
                   class="w-full p-3 bg-input border border-custom rounded-md">
          </div>
        </div>
        
        <div class="grid md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Formato *</label>
            <select x-model="editModal.record.format" required
                    class="w-full p-3 bg-input border border-custom rounded-md">
              <option value="CD">üìÄ CD</option>
              <option value="Vinil">üéµ Vinil</option>
              <option value="Cassete">üìº Cassete</option>
              <option value="Digital">üíª Digital</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Ano</label>
            <input x-model="editModal.record.year" type="number" min="1900" max="2030"
                   class="w-full p-3 bg-input border border-custom rounded-md">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">N√∫mero de Cat√°logo</label>
            <input x-model="editModal.record.catalog_number" 
                   class="w-full p-3 bg-input border border-custom rounded-md">
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">Descri√ß√£o da Edi√ß√£o</label>
          <textarea x-model="editModal.record.edition_notes" 
                    class="w-full p-3 bg-input border border-custom rounded-md resize-none"
                    rows="3"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium mb-1">URL da Capa</label>
          <input x-model="editModal.record.cover_url" 
                 class="w-full p-3 bg-input border border-custom rounded-md">
          <div x-show="editModal.record.cover_url" class="mt-2">
            <img :src="editModal.record.cover_url" class="w-20 h-20 object-cover rounded-md" 
                 @error="editModal.record.cover_url = ''" alt="Preview">
          </div>
        </div>
        
        <div class="flex space-x-4">
          <button type="submit" :disabled="editModal.loading" 
                  class="flex-1 py-3 btn-primary rounded-md">
            <span x-show="!editModal.loading">üíæ Salvar Altera√ß√µes</span>
            <span x-show="editModal.loading">Salvando...</span>
          </button>
          <button type="button" @click="editModal.show = false" 
                  class="px-6 py-3 btn-secondary rounded-md">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Import Excel -->
  <div x-show="importModal.show" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="importModal.show = false">
    <div class="bg-card p-8 rounded-lg max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
      <h3 class="text-xl font-bold mb-4">üìä Importar do Excel</h3>
      
      <div class="space-y-4">
        <!-- Instru√ß√µes -->
        <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
          <h4 class="font-semibold text-blue-300 mb-2">üìã Como preparar seu arquivo Excel:</h4>
          <ul class="text-sm text-blue-200 space-y-1">
            <li>‚Ä¢ <strong>album</strong> - Nome do √°lbum (obrigat√≥rio)</li>
            <li>‚Ä¢ <strong>artist</strong> - Nome do artista (obrigat√≥rio)</li>
            <li>‚Ä¢ <strong>format</strong> - CD, Vinil, Cassete ou Digital (obrigat√≥rio)</li>
            <li>‚Ä¢ <strong>year</strong> - Ano de lan√ßamento (opcional)</li>
            <li>‚Ä¢ <strong>catalog_number</strong> - N√∫mero de cat√°logo (opcional)</li>
            <li>‚Ä¢ <strong>edition_notes</strong> - Observa√ß√µes da edi√ß√£o (opcional)</li>
            <li>‚Ä¢ <strong>cover_url</strong> - URL da capa (opcional)</li>
          </ul>
        </div>
        
        <!-- Upload -->
        <div>
          <label class="block text-sm font-medium mb-2">Escolha o arquivo Excel:</label>
          <input type="file" @change="handleFileUpload($event)" 
                 accept=".xlsx,.xls,.csv" 
                 class="w-full p-3 bg-input border border-custom rounded-md">
        </div>
        
        <!-- Preview -->
        <div x-show="importModal.preview.length > 0">
          <h4 class="font-semibold mb-2">Preview (primeiros 3 itens):</h4>
          <div class="bg-input rounded-lg p-4 max-h-40 overflow-y-auto">
            <template x-for="item in importModal.preview.slice(0, 3)" :key="item.album">
              <div class="text-sm py-1 border-b border-gray-600 last:border-b-0">
                <strong x-text="item.album"></strong> - <span x-text="item.artist"></span>
                (<span x-text="item.format"></span>)
              </div>
            </template>
          </div>
          <p class="text-sm text-gray-400 mt-2" x-text="`Total: ${importModal.data.length} itens encontrados`"></p>
        </div>
        
        <div class="flex space-x-4">
          <button @click="importRecords()" :disabled="importModal.data.length === 0 || importModal.loading" 
                  class="flex-1 py-3 btn-primary rounded-md">
            <span x-show="!importModal.loading">üì• Importar Cole√ß√£o</span>
            <span x-show="importModal.loading">Importando...</span>
          </button>
          <button @click="closeImportModal()" class="px-6 py-3 btn-secondary rounded-md">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Info -->
  <div x-show="infoModal.show" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="infoModal.show = false">
    <div class="bg-card p-8 rounded-lg max-w-lg w-full mx-4">
      <h3 class="text-xl font-bold mb-4">‚ÑπÔ∏è Sobre o Katalog</h3>
      <div class="space-y-4 text-gray-300">
        <p>Este √© um <strong>mockup inicial</strong> de um aplicativo desenvolvido por alunos da <strong>UMC</strong> do curso de <strong>Sistemas de Informa√ß√£o</strong>.</p>
        <p>O objetivo √© ajudar colecionadores a catalogar suas cole√ß√µes musicais de forma objetiva e organizada.</p>
        <p>Recursos inclusos:</p>
        <ul class="list-disc list-inside space-y-1 text-sm">
          <li>Cat√°logo completo com busca e filtros</li>
          <li>M√∫ltiplos formatos (CD, Vinil, Cassete, Digital)</li>
          <li>Busca autom√°tica de capas</li>
          <li>Importa√ß√£o via Excel</li>
          <li>Compartilhamento de cole√ß√µes</li>
        </ul>
        <p class="text-sm text-gray-400">Desenvolvido com ‚ù§Ô∏è usando Firebase, Alpine.js e Tailwind CSS.</p>
      </div>
      <div class="flex justify-end mt-6">
        <button @click="infoModal.show = false" class="px-6 py-2 btn-primary rounded-md">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal Configura√ß√µes do Usu√°rio -->
  <div x-show="userConfigModal.show" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="userConfigModal.show = false">
    <div class="bg-card p-8 rounded-lg max-w-lg w-full mx-4 max-h-screen overflow-y-auto">
      <h3 class="text-xl font-bold mb-4">‚öôÔ∏è Configura√ß√µes da Conta</h3>
      
      <div class="space-y-6">
        <!-- Informa√ß√µes atuais -->
        <div class="bg-gray-800 p-4 rounded-lg">
          <h4 class="font-semibold mb-3">Informa√ß√µes Atuais:</h4>
          <div class="space-y-2 text-sm">
            <div><span class="text-gray-400">Email:</span> <span x-text="user?.email"></span></div>
            <div><span class="text-gray-400">Nome:</span> <span x-text="user?.displayName || 'N√£o definido'"></span></div>
          </div>
        </div>

        <!-- Editar Nome -->
        <div>
          <label class="block text-sm font-medium mb-2">Alterar Nome de Usu√°rio:</label>
          <div class="flex space-x-2">
            <input x-model="userConfigModal.newDisplayName" 
                   placeholder="Digite o novo nome"
                   class="flex-1 p-3 bg-input border border-custom rounded-md">
            <button @click="updateDisplayName()" 
                    :disabled="userConfigModal.loading || !userConfigModal.newDisplayName?.trim()"
                    class="px-4 py-3 btn-primary rounded-md">
              <span x-show="!userConfigModal.loading">Salvar</span>
              <span x-show="userConfigModal.loading">...</span>
            </button>
          </div>
        </div>

        <!-- Alterar Email -->
        <div>
          <label class="block text-sm font-medium mb-2">Alterar Email:</label>
          <div class="flex space-x-2">
            <input x-model="userConfigModal.newEmail" type="email"
                   placeholder="Digite o novo email"
                   class="flex-1 p-3 bg-input border border-custom rounded-md">
            <button @click="updateEmail()" 
                    :disabled="userConfigModal.loading || !userConfigModal.newEmail?.trim()"
                    class="px-4 py-3 btn-primary rounded-md">
              <span x-show="!userConfigModal.loading">Alterar</span>
              <span x-show="userConfigModal.loading">...</span>
            </button>
          </div>
        </div>

        <!-- Zona de Perigo -->
        <div class="bg-red-900/20 border border-red-500/30 p-4 rounded-lg">
          <h4 class="text-red-400 font-semibold mb-3">‚ö†Ô∏è Zona de Perigo</h4>
          <button @click="confirmDeleteAccount()" 
                  class="w-full py-2 px-4 bg-red-700 hover:bg-red-800 text-white rounded-md">
            üóëÔ∏è Excluir Conta Permanentemente
          </button>
        </div>
      </div>
      
      <div class="flex justify-end mt-6">
        <button @click="userConfigModal.show = false" class="px-6 py-2 btn-secondary rounded-md">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Tela de Login -->
  <div x-show="!user && !isLoading" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-900 to-black">
    <div class="bg-card p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="text-center mb-8">
        <i data-lucide="disc-3" class="mx-auto h-16 w-16 text-green-400 mb-4"></i>
        <h1 class="text-3xl font-bold text-white">Katalog</h1>
        <p class="text-gray-400 mt-2">Organize sua cole√ß√£o musical</p>
      </div>
      
      <div class="space-y-4">
        <!-- Modo Login -->
        <div x-show="!showRegisterForm && !showForgotPassword" class="space-y-4">
          <div>
            <input x-model="loginEmail" type="email" placeholder="seu@email.com" 
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          </div>
          <div>
            <input x-model="loginPassword" type="password" placeholder="Sua senha" 
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          </div>
          <button @click="loginWithEmail()" 
                  :disabled="authLoading"
                  class="w-full py-3 px-4 btn-primary rounded-md font-medium">
            <span x-show="!authLoading">üéµ Entrar</span>
            <span x-show="authLoading" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mx-auto"></span>
          </button>
          
          <div class="text-center space-y-2">
            <button @click="showForgotPassword = true" 
                    class="text-sm text-gray-400 hover:text-white">
              Esqueci minha senha
            </button>
            <div>
              <span class="text-gray-400 text-sm">N√£o tem uma conta?</span>
              <button @click="showRegisterForm = true" 
                      class="text-green-400 hover:text-green-300 text-sm ml-1">
                Cadastre-se
              </button>
            </div>
          </div>
        </div>

        <!-- Modo Cadastro -->
        <div x-show="showRegisterForm" class="space-y-4">
          <h3 class="text-lg font-semibold text-center">Criar Nova Conta</h3>
          <div>
            <input x-model="registerData.displayName" type="text" placeholder="Nome de usu√°rio" 
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          </div>
          <div>
            <input x-model="loginEmail" type="email" placeholder="seu@email.com" 
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          </div>
          <div>
            <input x-model="loginPassword" type="password" placeholder="Senha (min. 6 caracteres)" 
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          </div>
          <button @click="registerWithEmail()" 
                  :disabled="authLoading"
                  class="w-full py-3 px-4 btn-primary rounded-md font-medium">
            <span x-show="!authLoading">üìù Cadastrar</span>
            <span x-show="authLoading" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mx-auto"></span>
          </button>
          
          <div class="text-center">
            <span class="text-gray-400 text-sm">J√° tem uma conta?</span>
            <button @click="showRegisterForm = false" 
                    class="text-green-400 hover:text-green-300 text-sm ml-1">
              Fazer login
            </button>
          </div>
        </div>

        <!-- Modo Esqueci Senha -->
        <div x-show="showForgotPassword" class="space-y-4">
          <h3 class="text-lg font-semibold text-center">Recuperar Senha</h3>
          <p class="text-sm text-gray-400 text-center">Digite seu email para receber o link de recupera√ß√£o:</p>
          <div>
            <input x-model="resetEmail" type="email" placeholder="seu@email.com" 
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          </div>
          <button @click="resetPassword()" 
                  :disabled="authLoading"
                  class="w-full py-3 px-4 btn-primary rounded-md font-medium">
            <span x-show="!authLoading">üìß Enviar Link</span>
            <span x-show="authLoading" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mx-auto"></span>
          </button>
          
          <div class="text-center">
            <button @click="showForgotPassword = false" 
                    class="text-gray-400 hover:text-white text-sm">
              ‚Üê Voltar ao login
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div x-show="user && !isLoading" class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-black flex-shrink-0 flex flex-col">
      <div class="p-4 flex items-center space-x-2 border-b border-custom">
        <i data-lucide="disc-3" class="text-green-400"></i>
        <h1 class="text-xl font-bold text-white">Katalog</h1>
      </div>
      <nav class="flex-1 p-4 space-y-2">
        <a href="#" @click.prevent="appView = 'collection'" 
           :class="{'bg-green-500 text-white': appView === 'collection'}"
           class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700">
           <i data-lucide="album"></i><span>Minha Cole√ß√£o</span>
        </a>
        <a href="#" @click.prevent="appView = 'add-record'" 
           :class="{'bg-green-500 text-white': appView === 'add-record'}"
           class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700">
           <i data-lucide="plus-circle"></i><span>Adicionar Item</span>
        </a>
        <a href="#" @click.prevent="importModal.show = true" 
           class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-blue-300">
           <i data-lucide="upload"></i><span>Importar Excel</span>
        </a>
      </nav>
      <div class="p-4 border-t border-custom space-y-2">
        <button @click="openShareModal()" 
                class="w-full flex items-center space-x-3 px-3 py-2 rounded-md bg-blue-600/50 hover:bg-blue-700 text-white">
          <i data-lucide="share-2"></i><span>Compartilhar</span>
        </button>
        <div class="px-3 py-2 text-xs text-gray-400 break-words">
          <span class="font-semibold text-gray-300">Usu√°rio:</span>
          <span x-text="user?.email || user?.uid.substring(0, 8) + '...'"></span>
        </div>
        <a href="#" @click.prevent="confirmLogout()" 
           class="flex items-center space-x-3 px-3 py-2 rounded-md bg-red-600/50 hover:bg-red-800 text-white">
           <i data-lucide="log-out"></i><span>Sair</span>
        </a>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-8 overflow-y-auto">
      <!-- Header com nome do usu√°rio -->
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-2xl font-bold text-white">
            Ol√°, <span x-text="user?.displayName || 'Usu√°rio'"></span>! üëã
          </h1>
          <p class="text-gray-400 text-sm">Bem-vindo √† sua cole√ß√£o musical</p>
        </div>
        <button @click="openUserConfigModal()" 
                class="flex items-center space-x-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-white transition-colors">
          <i data-lucide="settings" class="w-4 h-4"></i>
          <span>Configura√ß√µes</span>
        </button>
      </div>

      <!-- Cole√ß√£o -->
      <div x-show="appView === 'collection'">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-3xl font-bold">Minha Cole√ß√£o (<span x-text="collection.length"></span>)</h2>
          <div class="flex space-x-2">
            <button @click="viewMode = 'grid'" 
                    :class="{'btn-primary': viewMode === 'grid', 'btn-secondary': viewMode !== 'grid'}"
                    class="px-4 py-2 rounded-md">
              <i data-lucide="grid-3x3"></i>
            </button>
            <button @click="viewMode = 'list'" 
                    :class="{'btn-primary': viewMode === 'list', 'btn-secondary': viewMode !== 'list'}"
                    class="px-4 py-2 rounded-md">
              <i data-lucide="list"></i>
            </button>
          </div>
        </div>
        
        <!-- Controles -->
        <div class="mb-6 space-y-4">
          <!-- Busca -->
          <input x-model="searchFilter" @input="filterCollection()" 
                 placeholder="üîç Buscar por √°lbum, artista, formato..." 
                 class="w-full max-w-md p-3 bg-input border border-custom rounded-md placeholder-custom">
          
          <!-- Filtros e Ordena√ß√£o -->
          <div class="flex flex-wrap gap-4">
            <select x-model="formatFilter" @change="filterCollection()" 
                    class="p-2 bg-input border border-custom rounded-md">
              <option value="">Todos os formatos</option>
              <option value="CD">üìÄ CD</option>
              <option value="Vinil">üéµ Vinil</option>
              <option value="Cassete">üìº Cassete</option>
              <option value="Digital">üíª Digital</option>
            </select>
            
            <select x-model="sortBy" @change="filterCollection()" 
                    class="p-2 bg-input border border-custom rounded-md">
              <option value="newest">Mais recentes</option>
              <option value="oldest">Mais antigos</option>
              <option value="album-asc">√Ålbum (A-Z)</option>
              <option value="album-desc">√Ålbum (Z-A)</option>

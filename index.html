<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Katalog</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    body { font-family: 'Inter', sans-serif; }
    
    /* Tema Escuro (padrão) */
    .theme-dark {
      background-color: #121212;
      color: #E0E0E0;
    }
    .theme-dark .bg-card { background-color: #1E1E1E; }
    .theme-dark .bg-input { background-color: #2A2A2A; }
    .theme-dark .border-custom { border-color: #383838; }
    .theme-dark .text-muted { color: #888888; }
    
      /* Tema Claro */
    .theme-light {
      background-color: #f8fafc;
      color: #1f2937;
    }
    .theme-light .bg-card { background-color: #ffffff; }
    .theme-light .bg-input { background-color: #f1f5f9; }
    .theme-light .border-custom { border-color: #e2e8f0; }
    .theme-light .text-muted { color: #64748b; }
    .theme-light .bg-black { background-color: #1f2937 !important; color: #ffffff !important; }
    .theme-light .hover\:bg-gray-700:hover { background-color: #e5e7eb !important; }
    .theme-light .text-white { color: #1f2937 !important; }
    .theme-light aside.bg-black { background-color: #f8fafc !important; border-right: 1px solid #e2e8f0; }
    .theme-light aside .text-white { color: #1f2937 !important; }
    .theme-light aside .text-gray-400 { color: #64748b !important; }
    .theme-light aside .border-custom { border-color: #e2e8f0 !important; }
    .theme-light aside .hover\:bg-gray-700:hover { background-color: #e5e7eb !important; }
    
    /* Correções de visibilidade para modo claro */
    .theme-light h1, .theme-light h2, .theme-light h3, .theme-light h4 { color: #1f2937 !important; }
    .theme-light table th { color: #374151 !important; }
    .theme-light table td { color: #4b5563 !important; }
    .theme-light .font-bold { color: #1f2937 !important; }
    .theme-light .font-semibold { color: #374151 !important; }
    .theme-light .text-sm { color: #6b7280 !important; }
    .theme-light .text-xs { color: #6b7280 !important; }
    
    /* Estilos para ordenação */
    .sort-button {
      @apply px-2 py-1 text-xs rounded border;
    }
    .sort-active {
      @apply bg-green-500 text-white;
    }
    .sort-inactive {
      @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
    }
    .theme-dark .sort-inactive {
      @apply bg-gray-600 text-gray-300 hover:bg-gray-500;
    }
    
    .btn-primary { background-color: #1DB954; color: #FFFFFF; }
    .btn-primary:hover { background-color: #1ED760; }
    .btn-secondary { background-color: #4A4A4A; color: #FFFFFF; }
    .btn-secondary:hover { background-color: #5A5A5A; }
    .btn-primary:disabled, button:disabled { background-color: #555; color: #aaa; cursor: not-allowed; }
    .placeholder-custom::placeholder { color: #888888; }
    [x-cloak] { display: none !important; }
    
    .format-badge { @apply px-2 py-1 text-xs font-semibold rounded-full; }
    .format-cd { @apply bg-blue-500 text-white; }
    .format-vinil { @apply bg-purple-500 text-white; }
    .format-cassete { @apply bg-orange-500 text-white; }
    .format-digital { @apply bg-green-500 text-white; }
  </style>
</head>
<body x-data="app" x-init="init()" x-cloak :class="`theme-${darkMode ? 'dark' : 'light'}`">

  <!-- Loading -->
  <div x-show="loading" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="flex flex-col items-center text-center p-4">
      <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
      <p class="text-white mt-4 text-lg">Carregando...</p>
    </div>
  </div>

  <!-- Notificação -->
  <div x-show="notification.show"
       class="fixed top-5 right-5 z-50 p-4 rounded-md shadow-lg text-white max-w-sm"
       :class="{'bg-green-600': notification.type === 'success', 'bg-red-600': notification.type === 'error', 'bg-blue-600': notification.type === 'info'}"
       x-transition>
    <p x-text="notification.message"></p>
  </div>

  <!-- Modal Configurações -->
  <div x-show="configModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="bg-card p-8 rounded-lg max-w-lg w-full mx-4">
      <h3 class="text-xl font-bold mb-4">Configurações da Conta</h3>
      
      <div class="space-y-6">
        <!-- Tema -->
        <div class="bg-input p-4 rounded-lg">
          <h4 class="font-semibold mb-3">Tema</h4>
          <div class="flex items-center justify-between">
            <span class="text-sm">Modo Escuro</span>
            <button @click="toggleTheme()" 
                    class="relative inline-flex h-6 w-11 items-center rounded-full"
                    :class="darkMode ? 'bg-green-600' : 'bg-gray-400'">
              <span class="inline-block h-4 w-4 transform rounded-full bg-white transition"
                    :class="darkMode ? 'translate-x-6' : 'translate-x-1'"></span>
            </button>
          </div>
        </div>
        
        <div class="bg-input p-4 rounded-lg">
          <h4 class="font-semibold mb-3">Informações Atuais:</h4>
          <div class="space-y-2 text-sm text-muted">
            <div><span>Email:</span> <span x-text="user?.email || 'Não definido'"></span></div>
            <div><span>Nome:</span> <span x-text="user?.displayName || 'Não definido'"></span></div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium mb-2">Alterar Nome:</label>
          <div class="flex space-x-2">
            <input x-model="newDisplayName" placeholder="Digite o novo nome"
                   class="flex-1 p-3 bg-input border border-custom rounded-md">
            <button @click="updateDisplayName()" :disabled="!newDisplayName?.trim()"
                    class="px-4 py-3 btn-primary rounded-md">Salvar</button>
          </div>
        </div>

        <div class="bg-red-900/20 border border-red-500/30 p-4 rounded-lg">
          <h4 class="text-red-400 font-semibold mb-3">Zona de Perigo</h4>
          <button @click="confirmDeleteAccount()" 
                  class="w-full py-2 px-4 bg-red-700 hover:bg-red-800 text-white rounded-md">
            Excluir Conta
          </button>
        </div>
      </div>
      
      <div class="flex justify-end mt-6">
        <button @click="configModal = false" class="px-6 py-2 btn-secondary rounded-md">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Modal Import Excel -->
  <div x-show="importModal.show" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="importModal.show = false">
    <div class="bg-card p-8 rounded-lg max-w-2xl w-full mx-4 max-h-screen overflow-y-auto">
      <h3 class="text-xl font-bold mb-4">Importar do Excel</h3>
      
      <div class="space-y-4">
        <!-- Instruções -->
        <div class="bg-blue-900/20 border border-blue-500/30 rounded-lg p-4">
          <h4 class="font-semibold text-blue-300 mb-2">Como preparar seu arquivo Excel:</h4>
          <ul class="text-sm text-blue-200 space-y-1">
            <li>• <strong>album</strong> - Nome do álbum (obrigatório)</li>
            <li>• <strong>artist</strong> - Nome do artista (obrigatório)</li>
            <li>• <strong>format</strong> - CD, Vinil, Cassete ou Digital (obrigatório)</li>
            <li>• <strong>year</strong> - Ano de lançamento (opcional)</li>
            <li>• <strong>catalog_number</strong> - Número de catálogo (opcional)</li>
            <li>• <strong>cover_url</strong> - URL da capa (opcional)</li>
          </ul>
        </div>
        
        <!-- Upload -->
        <div>
          <label class="block text-sm font-medium mb-2">Escolha o arquivo Excel:</label>
          <input type="file" @change="handleFileUpload($event)" 
                 accept=".xlsx,.xls,.csv" 
                 class="w-full p-3 bg-input border border-custom rounded-md">
        </div>
        
        <!-- Preview -->
        <div x-show="importModal.preview.length > 0">
          <h4 class="font-semibold mb-2">Preview (primeiros 3 itens):</h4>
          <div class="bg-input rounded-lg p-4 max-h-40 overflow-y-auto">
            <template x-for="item in importModal.preview.slice(0, 3)" :key="item.album">
              <div class="text-sm py-1 border-b border-custom last:border-b-0">
                <strong x-text="item.album"></strong> - <span x-text="item.artist"></span>
                (<span x-text="item.format"></span>)
              </div>
            </template>
          </div>
          <p class="text-sm text-muted mt-2" x-text="`Total: ${importModal.data.length} itens encontrados`"></p>
        </div>
        
        <div class="flex space-x-4">
          <button @click="importRecords()" :disabled="importModal.data.length === 0 || importModal.loading" 
                  class="flex-1 py-3 btn-primary rounded-md">
            <span x-show="!importModal.loading">Importar Coleção</span>
            <span x-show="importModal.loading">Importando...</span>
          </button>
          <button @click="closeImportModal()" class="px-6 py-3 btn-secondary rounded-md">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Login -->
  <div x-show="!user && !loading" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-900 to-black">
    <div class="bg-card p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="text-center mb-8">
        <i data-lucide="disc-3" class="mx-auto h-16 w-16 text-green-400 mb-4"></i>
        <h1 class="text-3xl font-bold text-white">Katalog</h1>
        <p class="text-gray-400 mt-2">Organize sua coleção musical</p>
      </div>
      
      <div class="space-y-4">
        <div x-show="!showRegister" class="space-y-4">
          <input x-model="email" type="email" placeholder="seu@email.com" 
                 class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          <input x-model="password" type="password" placeholder="Sua senha" 
                 class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          <button @click="login()" :disabled="authLoading"
                  class="w-full py-3 px-4 btn-primary rounded-md font-medium">
            <span x-show="!authLoading">Entrar</span>
            <span x-show="authLoading">Entrando...</span>
          </button>
          
          <div class="text-center">
            <span class="text-gray-400 text-sm">Não tem uma conta?</span>
            <button @click="showRegister = true" class="text-green-400 hover:text-green-300 text-sm ml-1">
              Cadastre-se
            </button>
          </div>
        </div>

        <div x-show="showRegister" class="space-y-4">
          <h3 class="text-lg font-semibold text-center">Criar Nova Conta</h3>
          <input x-model="displayName" type="text" placeholder="Nome de usuário" 
                 class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          <input x-model="email" type="email" placeholder="seu@email.com" 
                 class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          <input x-model="password" type="password" placeholder="Senha (min. 6 caracteres)" 
                 class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          <button @click="register()" :disabled="authLoading"
                  class="w-full py-3 px-4 btn-primary rounded-md font-medium">
            <span x-show="!authLoading">Cadastrar</span>
            <span x-show="authLoading">Cadastrando...</span>
          </button>
          
          <div class="text-center">
            <span class="text-gray-400 text-sm">Já tem uma conta?</span>
            <button @click="showRegister = false" class="text-green-400 hover:text-green-300 text-sm ml-1">
              Fazer login
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div x-show="user && !loading" class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-black flex-shrink-0 flex flex-col">
      <div class="p-4 flex items-center space-x-2 border-b border-custom">
        <i data-lucide="disc-3" class="text-green-400"></i>
        <h1 class="text-xl font-bold text-white">Katalog</h1>
      </div>
      <nav class="flex-1 p-4 space-y-2">
        <a href="#" @click.prevent="currentView = 'collection'" 
           :class="{'bg-green-500 text-white': currentView === 'collection'}"
           class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-white">
           <i data-lucide="album"></i><span>Minha Coleção</span>
        </a>
        <a href="#" @click.prevent="currentView = 'add-record'" 
           :class="{'bg-green-500 text-white': currentView === 'add-record'}"
           class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-white">
           <i data-lucide="plus-circle"></i><span>Adicionar Item</span>
        </a>
        <button @click="importModal.show = true" 
                class="w-full flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700 text-blue-300">
          <i data-lucide="upload"></i><span>Importar Excel</span>
        </button>
      </nav>
      <div class="p-4 border-t border-custom space-y-2">
        <div class="px-3 py-2 text-xs text-gray-400 break-words">
          <span x-text="user?.email || 'Usuário'"></span>
        </div>
        <button @click="confirmLogout()" 
                class="w-full flex items-center space-x-3 px-3 py-2 rounded-md bg-red-600/50 hover:bg-red-800 text-white">
          <i data-lucide="log-out"></i><span>Sair</span>
        </button>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-8 overflow-y-auto">
      <!-- Header -->
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-2xl font-bold">
            Olá, <span x-text="user?.displayName || 'Usuário'"></span>!
          </h1>
          <p class="text-sm text-muted">Bem-vindo à sua coleção musical</p>
        </div>
        <button @click="configModal = true" 
                class="flex items-center space-x-2 px-4 py-2 bg-input hover:bg-card rounded-lg border border-custom">
          <i data-lucide="settings" class="w-4 h-4"></i>
          <span>Configurações</span>
        </button>
      </div>

      <!-- Coleção -->
      <div x-show="currentView === 'collection'">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-3xl font-bold">Minha Coleção (<span x-text="collection.length"></span>)</h2>
          <div class="flex space-x-2">
            <button @click="viewMode = 'grid'" 
                    :class="viewMode === 'grid' ? 'btn-primary' : 'btn-secondary'"
                    class="px-4 py-2 rounded-md">
              <i data-lucide="grid-3x3"></i>
            </button>
            <button @click="viewMode = 'list'" 
                    :class="viewMode === 'list' ? 'btn-primary' : 'btn-secondary'"
                    class="px-4 py-2 rounded-md">
              <i data-lucide="list"></i>
            </button>
          </div>
        </div>
        
        <!-- Busca e Ordenação -->
        <div class="mb-6 flex flex-col sm:flex-row gap-4 items-start sm:items-center">
          <input x-model="searchFilter" @input="filterCollection()" 
                 placeholder="Buscar por álbum, artista, formato..." 
                 class="w-full sm:max-w-md p-3 bg-input border border-custom rounded-md placeholder-custom">
          
          <div class="flex items-center space-x-2">
            <span class="text-sm font-medium">Ordenar por:</span>
            <button @click="setSortBy('album')" 
                    :class="sortBy === 'album' ? 'sort-active' : 'sort-inactive'"
                    class="sort-button">Álbum</button>
            <button @click="setSortBy('artist')" 
                    :class="sortBy === 'artist' ? 'sort-active' : 'sort-inactive'"
                    class="sort-button">Artista</button>
            <button @click="setSortBy('year')" 
                    :class="sortBy === 'year' ? 'sort-active' : 'sort-inactive'"
                    class="sort-button">Ano</button>
            <button @click="toggleSortOrder()" 
                    class="sort-button sort-inactive">
              <i :data-lucide="sortOrder === 'asc' ? 'arrow-up' : 'arrow-down'" class="w-3 h-3"></i>
            </button>
          </div>
        </div>
        
        <!-- Grid View -->
        <div x-show="viewMode === 'grid' && filteredCollection.length > 0" 
             class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          <template x-for="record in filteredCollection" :key="record.id">
            <div class="bg-card rounded-lg overflow-hidden shadow-lg group relative">
              <img :src="record.cover_url || `https://placehold.co/300x300/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`" 
                   class="w-full aspect-square object-cover">
              <div class="absolute top-2 left-2">
                <span :class="'format-' + (record.format?.toLowerCase() || 'cd')" 
                      class="format-badge" x-text="record.format || 'CD'"></span>
              </div>
              <div class="absolute top-2 right-2 flex space-x-1 opacity-0 group-hover:opacity-100">
                <button @click="editRecord(record)" 
                        class="bg-blue-600 text-white rounded-full p-2 hover:bg-blue-700">
                  <i data-lucide="edit" class="w-4 h-4"></i>
                </button>
                <button @click="confirmDeleteRecord(record.id)" 
                        class="bg-red-600 text-white rounded-full p-2 hover:bg-red-700">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </div>
              <div class="p-3">
                <h3 class="font-bold truncate" x-text="record.album"></h3>
                <p class="text-sm text-muted truncate" x-text="record.artist"></p>
                <p x-show="record.year" class="text-xs text-muted" x-text="record.year"></p>
              </div>
            </div>
          </template>
        </div>

        <!-- List View -->
        <div x-show="viewMode === 'list' && filteredCollection.length > 0" 
             class="bg-card rounded-lg overflow-hidden shadow-lg">
          <table class="w-full">
            <thead class="bg-input">
              <tr>
                <th class="text-left p-4 font-semibold">Capa</th>
                <th class="text-left p-4 font-semibold">Álbum</th>
                <th class="text-left p-4 font-semibold">Artista</th>
                <th class="text-left p-4 font-semibold">Formato</th>
                <th class="text-left p-4 font-semibold">Ano</th>
                <th class="text-left p-4 font-semibold">Código</th>
                <th class="text-left p-4 font-semibold">Ações</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="record in filteredCollection" :key="record.id">
                <tr class="border-b border-custom hover:bg-input">
                  <td class="p-4">
                    <img :src="record.cover_url || `https://placehold.co/60x60/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`" 
                         class="w-12 h-12 object-cover rounded">
                  </td>
                  <td class="p-4 font-semibold" x-text="record.album"></td>
                  <td class="p-4" x-text="record.artist"></td>
                  <td class="p-4">
                    <span :class="'format-' + (record.format?.toLowerCase() || 'cd')" 
                          class="format-badge" x-text="record.format || 'CD'"></span>
                  </td>
                  <td class="p-4" x-text="record.year || '-'"></td>
                  <td class="p-4 text-sm" x-text="record.catalog_number || '-'"></td>
                  <td class="p-4">
                    <div class="flex space-x-2">
                      <button @click="editRecord(record)" 
                              class="text-blue-500 hover:text-blue-700">
                        <i data-lucide="edit" class="w-4 h-4"></i>
                      </button>
                      <button @click="confirmDeleteRecord(record.id)" 
                              class="text-red-500 hover:text-red-700">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        
        <!-- Empty State -->
        <div x-show="collection.length === 0" class="text-center py-20 bg-card rounded-lg">
          <i data-lucide="folder-x" class="mx-auto h-16 w-16 text-muted mb-4"></i>
          <h3 class="text-xl font-semibold">Sua coleção está vazia</h3>
          <p class="text-muted mt-2">Comece adicionando seu primeiro item!</p>
          <button @click="currentView = 'add-record'" class="mt-6 px-6 py-2 rounded-full btn-primary">
            Adicionar Item
          </button>
        </div>
      </div>

      <!-- Form Adicionar -->
      <div x-show="currentView === 'add-record'">
        <h2 class="text-3xl font-bold mb-6">
          <span x-show="!editingRecord">Adicionar Novo Item</span>
          <span x-show="editingRecord">Editar Item</span>
        </h2>
        <form @submit.prevent="confirmAddRecord()" class="max-w-3xl mx-auto bg-card p-8 rounded-lg space-y-6">
          
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Álbum/Título *</label>
              <input x-model="newRecord.album" required 
                     class="w-full p-3 bg-input border border-custom rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Artista *</label>
              <input x-model="newRecord.artist" required 
                     class="w-full p-3 bg-input border border-custom rounded-md">
            </div>
          </div>
          
          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Formato *</label>
              <select x-model="newRecord.format" required
                      class="w-full p-3 bg-input border border-custom rounded-md">
                <option value="">Selecione...</option>
                <option value="CD">CD</option>
                <option value="Vinil">Vinil</option>
                <option value="Cassete">Cassete</option>
                <option value="Digital">Digital</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Ano</label>
              <input x-model="newRecord.year" type="number" min="1900" max="2030"
                     class="w-full p-3 bg-input border border-custom rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Número de Catálogo</label>
              <input x-model="newRecord.catalog_number"
                     class="w-full p-3 bg-input border border-custom rounded-md">
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium mb-1">URL da Capa</label>
            <input x-model="newRecord.cover_url" type="url" 
                   placeholder="https://exemplo.com/capa.jpg"
                   class="w-full p-3 bg-input border border-custom rounded-md">
          </div>
          
          <div class="flex space-x-4">
            <button type="submit" :disabled="!newRecord.album || !newRecord.artist || !newRecord.format"
                    class="flex-1 py-3 btn-primary rounded-md">
              <span x-show="!editingRecord">Adicionar à Coleção</span>
              <span x-show="editingRecord">Salvar Alterações</span>
            </button>
            <button type="button" @click="resetForm()" class="px-6 py-3 btn-secondary rounded-md">
              <span x-show="!editingRecord">Limpar</span>
              <span x-show="editingRecord">Cancelar</span>
            </button>
          </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    // Configuração Firebase (substitua pelas suas credenciais)
const firebaseConfig = {
  apiKey: "AIzaSyAzEu2hLmvPzaFLgQtXUAUkuXvwokD2F-A",
  authDomain: "katalog-1178e.firebaseapp.com",
  projectId: "katalog-1178e",
  storageBucket: "katalog-1178e.firebasestorage.app",
  messagingSenderId: "998961219093",
  appId: "1:998961219093:web:6afddd14ad2ddd9ed3301c"
};

    // Inicializar Firebase se não estiver em demo
    let db, auth;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      auth = firebase.auth();
    } catch (error) {
      console.log('Firebase não configurado, usando modo demo');
    }

    function app() {
      return {
        // Estados
        loading: true,
        user: null,
        darkMode: true,
        currentView: 'collection',
        viewMode: 'grid',
        
        // Auth
        email: '',
        password: '',
        displayName: '',
        showRegister: false,
        authLoading: false,
        newDisplayName: '',
        
        // Modais
        configModal: false,
        
        // Dados
        collection: [],
        filteredCollection: [],
        
        // Busca e filtros
        searchFilter: '',
        sortBy: 'album',
        sortOrder: 'asc',
        
        // Form
        newRecord: {
          album: '',
          artist: '',
          format: '',
          year: '',
          catalog_number: '',
          cover_url: ''
        },
        editingRecord: null,
        
        // Import
        importModal: {
          show: false,
          data: [],
          preview: [],
          loading: false
        },
        
        // Notificações
        notification: {
          show: false,
          message: '',
          type: 'info'
        },

        init() {
          this.loadTheme();
          this.initAuth();
        },

        loadTheme() {
          const saved = localStorage.getItem('darkMode');
          this.darkMode = saved !== null ? JSON.parse(saved) : true;
        },

        saveTheme() {
          localStorage.setItem('darkMode', JSON.stringify(this.darkMode));
        },

        toggleTheme() {
          this.darkMode = !this.darkMode;
          this.saveTheme();
        },

        initAuth() {
          if (auth) {
            auth.onAuthStateChanged((user) => {
              this.user = user;
              if (user) {
                this.loadCollection();
              }
              this.loading = false;
            });
          } else {
            // Modo demo
            setTimeout(() => {
              this.user = { email: 'demo@katalog.com', displayName: 'Usuário Demo' };
              this.loadDemoData();
              this.loading = false;
            }, 1000);
          }
        },

        async login() {
          if (!auth) {
            this.showNotification('Modo demo ativo', 'info');
            return;
          }

          this.authLoading = true;
          try {
            await auth.signInWithEmailAndPassword(this.email, this.password);
            this.showNotification('Login realizado com sucesso!', 'success');
          } catch (error) {
            this.showNotification(this.getAuthErrorMessage(error.code), 'error');
          }
          this.authLoading = false;
        },

        async register() {
          if (!auth) {
            this.showNotification('Modo demo ativo', 'info');
            return;
          }

          if (!this.displayName.trim()) {
            this.showNotification('Nome de usuário é obrigatório', 'error');
            return;
          }

          this.authLoading = true;
          try {
            const result = await auth.createUserWithEmailAndPassword(this.email, this.password);
            await result.user.updateProfile({ displayName: this.displayName });
            this.showNotification('Conta criada com sucesso!', 'success');
          } catch (error) {
            this.showNotification(this.getAuthErrorMessage(error.code), 'error');
          }
          this.authLoading = false;
        },

        async updateDisplayName() {
          if (!this.newDisplayName?.trim()) return;

          if (!auth || !this.user) {
            this.showNotification('Modo demo ativo', 'info');
            return;
          }

          try {
            await this.user.updateProfile({ displayName: this.newDisplayName });
            this.user = { ...this.user, displayName: this.newDisplayName };
            this.newDisplayName = '';
            this.showNotification('Nome atualizado com sucesso!', 'success');
          } catch (error) {
            this.showNotification('Erro ao atualizar nome', 'error');
          }
        },

        confirmLogout() {
          if (confirm('Tem certeza que deseja sair?')) {
            this.logout();
          }
        },

        async logout() {
          if (auth) {
            await auth.signOut();
          } else {
            this.user = null;
            this.collection = [];
            this.filteredCollection = [];
          }
          this.resetForm();
          this.currentView = 'collection';
        },

        confirmDeleteAccount() {
          if (confirm('ATENÇÃO: Esta ação é irreversível!\n\nTem certeza que deseja excluir sua conta e todos os dados?')) {
            this.deleteAccount();
          }
        },

        async deleteAccount() {
          if (!auth || !this.user) {
            this.showNotification('Modo demo ativo', 'info');
            return;
          }

          try {
            // Deletar dados do Firestore
            const batch = db.batch();
            const snapshot = await db.collection('records')
              .where('userId', '==', this.user.uid)
              .get();
            
            snapshot.docs.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            
            // Deletar conta
            await this.user.delete();
            
            this.showNotification('Conta excluída com sucesso', 'success');
            this.configModal = false;
          } catch (error) {
            this.showNotification('Erro ao excluir conta', 'error');
          }
        },

        async loadCollection() {
          if (!db || !this.user) {
            this.loadDemoData();
            return;
          }

          try {
            const snapshot = await db.collection('records')
              .where('userId', '==', this.user.uid)
              .get();
            
            this.collection = snapshot.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            
            this.filterCollection();
          } catch (error) {
            this.showNotification('Erro ao carregar coleção', 'error');
            this.loadDemoData();
          }
        },

        loadDemoData() {
          this.collection = [
            {
              id: '1',
              album: 'Thriller',
              artist: 'Michael Jackson',
              format: 'Vinil',
              year: 1982,
              cover_url: 'https://upload.wikimedia.org/wikipedia/en/5/55/Michael_Jackson_-_Thriller.png'
            },
            {
              id: '2',
              album: 'The Dark Side of the Moon',
              artist: 'Pink Floyd',
              format: 'CD',
              year: 1973,
              cover_url: 'https://upload.wikimedia.org/wikipedia/en/3/3b/Dark_Side_of_the_Moon.png'
            },
            {
              id: '3',
              album: 'Back in Black',
              artist: 'AC/DC',
              format: 'Cassete',
              year: 1980
            }
          ];
          this.filterCollection();
        },

        filterCollection() {
          let filtered = [...this.collection];

          // Aplicar filtro de busca
          if (this.searchFilter.trim()) {
            const search = this.searchFilter.toLowerCase();
            filtered = filtered.filter(record =>
              record.album.toLowerCase().includes(search) ||
              record.artist.toLowerCase().includes(search) ||
              (record.format || '').toLowerCase().includes(search)
            );
          }

          // Aplicar ordenação
          filtered.sort((a, b) => {
            let aVal = a[this.sortBy] || '';
            let bVal = b[this.sortBy] || '';
            
            if (typeof aVal === 'string') {
              aVal = aVal.toLowerCase();
              bVal = bVal.toLowerCase();
            }
            
            if (this.sortOrder === 'asc') {
              return aVal > bVal ? 1 : -1;
            } else {
              return aVal < bVal ? 1 : -1;
            }
          });

          this.filteredCollection = filtered;
        },

        setSortBy(field) {
          if (this.sortBy === field) {
            this.toggleSortOrder();
          } else {
            this.sortBy = field;
            this.sortOrder = 'asc';
          }
          this.filterCollection();
        },

        toggleSortOrder() {
          this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
          this.filterCollection();
        },

        confirmAddRecord() {
          if (this.editingRecord) {
            if (confirm('Salvar as alterações feitas no item?')) {
              this.saveRecord();
            }
          } else {
            if (confirm('Adicionar este item à sua coleção?')) {
              this.addRecord();
            }
          }
        },

        async addRecord() {
          const record = {
            ...this.newRecord,
            userId: this.user?.uid || 'demo',
            createdAt: new Date()
          };

          if (db && this.user) {
            try {
              const docRef = await db.collection('records').add(record);
              record.id = docRef.id;
            } catch (error) {
              this.showNotification('Erro ao salvar no banco de dados', 'error');
              return;
            }
          } else {
            record.id = Date.now().toString();
          }

          this.collection.push(record);
          this.filterCollection();
          this.resetForm();
          this.showNotification('Item adicionado à coleção!', 'success');
          this.currentView = 'collection';
        },

        async saveRecord() {
          if (!this.editingRecord) return;

          const updates = { ...this.newRecord };

          if (db && this.user) {
            try {
              await db.collection('records').doc(this.editingRecord.id).update(updates);
            } catch (error) {
              this.showNotification('Erro ao salvar alterações', 'error');
              return;
            }
          }

          const index = this.collection.findIndex(r => r.id === this.editingRecord.id);
          if (index !== -1) {
            this.collection[index] = { ...this.editingRecord, ...updates };
          }

          this.filterCollection();
          this.resetForm();
          this.showNotification('Item atualizado com sucesso!', 'success');
          this.currentView = 'collection';
        },

        editRecord(record) {
          this.editingRecord = record;
          this.newRecord = { ...record };
          this.currentView = 'add-record';
        },

        confirmDeleteRecord(id) {
          if (confirm('Tem certeza que deseja excluir este item?')) {
            this.deleteRecord(id);
          }
        },

        async deleteRecord(id) {
          if (db && this.user) {
            try {
              await db.collection('records').doc(id).delete();
            } catch (error) {
              this.showNotification('Erro ao excluir do banco de dados', 'error');
              return;
            }
          }

          this.collection = this.collection.filter(r => r.id !== id);
          this.filterCollection();
          this.showNotification('Item excluído da coleção', 'success');
        },

        resetForm() {
          this.newRecord = {
            album: '',
            artist: '',
            format: '',
            year: '',
            catalog_number: '',
            cover_url: ''
          };
          this.editingRecord = null;
        },

        handleFileUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = e.target.result;
              const workbook = XLSX.read(data, { type: 'binary' });
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              const jsonData = XLSX.utils.sheet_to_json(firstSheet);

              const records = jsonData.map(row => ({
                album: row.album || row.Album || '',
                artist: row.artist || row.Artist || '',
                format: row.format || row.Format || 'CD',
                year: row.year || row.Year || '',
                catalog_number: row.catalog_number || row['Catalog Number'] || '',
                cover_url: row.cover_url || row['Cover URL'] || ''
              })).filter(record => record.album && record.artist);

              this.importModal.data = records;
              this.importModal.preview = records;
              
              if (records.length === 0) {
                this.showNotification('Nenhum registro válido encontrado no arquivo', 'error');
              }
            } catch (error) {
              this.showNotification('Erro ao ler o arquivo Excel', 'error');
            }
          };
          reader.readAsBinaryString(file);
        },

        async importRecords() {
          if (this.importModal.data.length === 0) return;

          this.importModal.loading = true;
          let imported = 0;

          try {
            for (const record of this.importModal.data) {
              const newRecord = {
                ...record,
                userId: this.user?.uid || 'demo',
                createdAt: new Date()
              };

              if (db && this.user) {
                const docRef = await db.collection('records').add(newRecord);
                newRecord.id = docRef.id;
              } else {
                newRecord.id = Date.now().toString() + imported;
              }

              this.collection.push(newRecord);
              imported++;
            }

            this.filterCollection();
            this.showNotification(`${imported} itens importados com sucesso!`, 'success');
            this.closeImportModal();
          } catch (error) {
            this.showNotification(`Erro na importação. ${imported} itens foram importados.`, 'error');
          }

          this.importModal.loading = false;
        },

        closeImportModal() {
          this.importModal.show = false;
          this.importModal.data = [];
          this.importModal.preview = [];
          this.importModal.loading = false;
        },

        showNotification(message, type = 'info') {
          this.notification = { show: true, message, type };
          setTimeout(() => {
            this.notification.show = false;
          }, 3000);
        },

        getAuthErrorMessage(code) {
          const messages = {
            'auth/user-not-found': 'Usuário não encontrado',
            'auth/wrong-password': 'Senha incorreta',
            'auth/email-already-in-use': 'Este email já está em uso',
            'auth/weak-password': 'Senha muito fraca (mín. 6 caracteres)',
            'auth/invalid-email': 'Email inválido'
          };
          return messages[code] || 'Erro de autenticação';
        }
      };
    }

    // Inicializar ícones Lucide após o DOM carregar
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    });

    // Re-criar ícones quando o Alpine atualizar o DOM
    document.addEventListener('alpine:updated', () => {
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    });
  </script>
</body>
</html>


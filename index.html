<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Do Vinil ao Digital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  
  <!-- Firebase SDKs - Vers√£o Compat para HTML est√°tico -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #121212; color: #E0E0E0; }
    .bg-card { background-color: #1E1E1E; }
    .bg-input { background-color: #2A2A2A; }
    .border-custom { border-color: #383838; }
    .btn-primary { background-color: #1DB954; color: #FFFFFF; }
    .btn-primary:hover { background-color: #1ED760; }
    .btn-danger { background-color: #dc2626; color: #FFFFFF; }
    .btn-danger:hover { background-color: #b91c1c; }
    .btn-secondary { background-color: #4A4A4A; color: #FFFFFF; }
    .btn-secondary:hover { background-color: #5A5A5A; }
    .btn-primary:disabled, button:disabled { background-color: #555; color: #aaa; cursor: not-allowed; }
    .placeholder-custom::placeholder { color: #888888; }
    [x-cloak] { display: none !important; }
  </style>
</head>
<body x-data="app" x-init="init()" x-cloak>

  <!-- Loading -->
  <div x-show="isInitializing" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="flex flex-col items-center text-center p-4">
      <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
      <p class="text-white mt-4 text-lg">Conectando...</p>
    </div>
  </div>

  <!-- Notifica√ß√£o -->
  <div x-show="notification.show"
       class="fixed top-5 right-5 z-50 p-4 rounded-md shadow-lg text-white max-w-sm"
       :class="{'bg-green-600': notification.type === 'success', 'bg-red-600': notification.type === 'error'}"
       x-transition>
    <p x-text="notification.message"></p>
  </div>

  <!-- Dashboard -->
  <div id="app-dashboard" x-show="!isInitializing" class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-black flex-shrink-0 flex flex-col">
      <div class="p-4 flex items-center space-x-2 border-b border-custom">
        <i data-lucide="disc-3" class="text-green-400"></i>
        <h1 class="text-xl font-bold text-white">Do Vinil ao Digital</h1>
      </div>
      <nav class="flex-1 p-4 space-y-2">
        <a href="#" @click.prevent="appView = 'collection'" 
           :class="{'bg-green-500 text-white': appView === 'collection'}"
           class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700">
           <i data-lucide="album"></i><span>Minha Cole√ß√£o</span>
        </a>
        <a href="#" @click.prevent="appView = 'add-record'" 
           :class="{'bg-green-500 text-white': appView === 'add-record'}"
           class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700">
           <i data-lucide="plus-circle"></i><span>Adicionar Disco</span>
        </a>
      </nav>
      <div class="p-4 border-t border-custom space-y-2">
        <div class="px-3 py-2 text-xs text-gray-400 break-words">
          <span class="font-semibold text-gray-300">ID de Usu√°rio:</span>
          <span x-text="currentUser.id"></span>
        </div>
        <a href="#" @click.prevent="logout()" 
           class="flex items-center space-x-3 px-3 py-2 rounded-md bg-red-600/50 hover:bg-red-800 text-white">
           <i data-lucide="log-out"></i><span>Sair</span>
        </a>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-8 overflow-y-auto">
      <!-- Cole√ß√£o -->
      <div x-show="appView === 'collection'">
        <h2 class="text-3xl font-bold mb-6">Minha Cole√ß√£o (<span x-text="collection.length"></span>)</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6" x-show="collection.length > 0">
          <template x-for="record in collection" :key="record.id">
            <div class="bg-card rounded-lg overflow-hidden shadow-lg group relative">
              <img :src="record.cover_url || `https://placehold.co/300x300/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`" 
                   class="w-full aspect-square object-cover">
              <div class="absolute top-2 right-2">
                <button @click="openDeleteModal(record.id)" 
                        class="bg-red-600 text-white rounded-full p-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </div>
              <div class="p-3">
                <h3 class="font-bold text-white truncate" x-text="record.album"></h3>
                <p class="text-sm text-gray-400 truncate" x-text="record.artist"></p>
              </div>
            </div>
          </template>
        </div>
        <div x-show="collection.length === 0 && !loading" class="text-center py-20 bg-card rounded-lg">
          <i data-lucide="folder-x" class="mx-auto h-16 w-16 text-gray-500 mb-4"></i>
          <h3 class="text-xl font-semibold">Sua cole√ß√£o est√° vazia</h3>
          <p class="text-gray-400 mt-2">Comece adicionando seu primeiro disco!</p>
          <button @click="appView = 'add-record'" class="mt-6 px-6 py-2 rounded-full btn-primary">Adicionar Disco</button>
        </div>
      </div>

      <!-- Form -->
      <div x-show="appView === 'add-record'">
        <h2 class="text-3xl font-bold mb-6">Adicionar Novo Disco</h2>
        <form @submit.prevent="addRecord" class="max-w-xl mx-auto bg-card p-8 rounded-lg space-y-4">
          <div><label class="block text-sm font-medium">√Ålbum</label><input x-model="newRecord.album" required class="w-full mt-1 p-3 bg-input border border-custom rounded-md"></div>
          <div><label class="block text-sm font-medium">Artista</label><input x-model="newRecord.artist" required class="w-full mt-1 p-3 bg-input border border-custom rounded-md"></div>
          <div><label class="block text-sm font-medium">Ano</label><input x-model="newRecord.year" type="number" class="w-full mt-1 p-3 bg-input border border-custom rounded-md"></div>
          <div><label class="block text-sm font-medium">URL da Capa</label><input x-model="newRecord.cover_url" class="w-full mt-1 p-3 bg-input border border-custom rounded-md"></div>
          <button type="submit" :disabled="loading" class="w-full py-3 font-semibold rounded-md btn-primary flex items-center justify-center">
            <span x-show="!loading">Salvar Disco</span>
            <span x-show="loading" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
          </button>
        </form>
      </div>
    </main>
  </div>

  <script>
    // üî• COLOQUE AQUI AS SUAS CONFIGURA√á√ïES DO FIREBASE
    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SEU_PROJECT.firebaseapp.com",
      projectId: "SEU_PROJECT_ID",
      storageBucket: "SEU_PROJECT.appspot.com",
      messagingSenderId: "SEU_SENDER_ID",
      appId: "SEU_APP_ID"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    document.addEventListener('alpine:init', () => {
      Alpine.data('app', () => ({
        isInitializing: true,
        loading: false,
        appView: 'collection',
        collection: [],
        newRecord: { album: '', artist: '', year: '', cover_url: '' },
        currentUser: { id: null },
        notification: { show: false, message: '', type: 'success' },
        collectionListener: null,

        async init() {
          try {
            // Fazer login an√¥nimo
            await auth.signInAnonymously();
            this.setupAuthListener();
          } catch (error) {
            console.error('Erro ao inicializar:', error);
            this.showNotification("Erro ao conectar com Firebase", "error");
            this.isInitializing = false;
          }
          
          // Inicializar √≠cones do Lucide
          this.$nextTick(() => {
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
          });
        },

        setupAuthListener() {
          auth.onAuthStateChanged((user) => {
            if (user) {
              this.currentUser.id = user.uid;
              this.fetchCollection(user.uid);
            }
            this.isInitializing = false;
          });
        },

        fetchCollection(userId) {
          if (!userId) return;
          
          // Cancelar listener anterior se existir
          if (this.collectionListener) {
            this.collectionListener();
          }
          
          // Criar novo listener
          this.collectionListener = db.collection(`users/${userId}/records`)
            .onSnapshot((snapshot) => {
              this.collection = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
            }, (error) => {
              console.error('Erro ao buscar cole√ß√£o:', error);
              this.showNotification("Erro ao carregar cole√ß√£o", "error");
            });
        },

        async addRecord() {
          if (!this.newRecord.album.trim() || !this.newRecord.artist.trim()) {
            this.showNotification("√Ålbum e Artista s√£o obrigat√≥rios", "error");
            return;
          }
          
          this.loading = true;
          
          try {
            const userId = this.currentUser.id;
            const recordData = {
              album: this.newRecord.album.trim(),
              artist: this.newRecord.artist.trim(),
              year: this.newRecord.year ? Number(this.newRecord.year) : null,
              cover_url: this.newRecord.cover_url.trim() || null,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection(`users/${userId}/records`).add(recordData);
            
            this.showNotification("Disco adicionado com sucesso!", "success");
            this.newRecord = { album: '', artist: '', year: '', cover_url: '' };
            this.appView = 'collection';
            
          } catch (error) {
            console.error('Erro ao adicionar disco:', error);
            this.showNotification("Erro ao salvar disco", "error");
          } finally {
            this.loading = false;
          }
        },

        async confirmDelete(id) {
          if (!confirm('Tem certeza que deseja excluir este disco?')) {
            return;
          }
          
          try {
            const userId = this.currentUser.id;
            await db.collection(`users/${userId}/records`).doc(id).delete();
            this.showNotification("Disco exclu√≠do!", "success");
          } catch (error) {
            console.error('Erro ao excluir:', error);
            this.showNotification("Erro ao excluir disco", "error");
          }
        },

        async logout() {
          try {
            await auth.signOut();
            this.currentUser.id = null;
            this.collection = [];
            this.showNotification("Voc√™ saiu da conta", "success");
          } catch (error) {
            console.error('Erro ao sair:', error);
            this.showNotification("Erro ao sair", "error");
          }
        },

        openDeleteModal(id) { 
          this.confirmDelete(id);
        },

        showNotification(message, type = 'success') {
          this.notification = { 
            message: message, 
            type: type, 
            show: true 
          };
          
          setTimeout(() => {
            this.notification.show = false;
          }, 3000);
        }
      }))
    })
  </script>
</body>
</html>

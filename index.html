<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Katalog</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  
  <!-- Firebase SDKs - Vers√£o Compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #121212; color: #E0E0E0; }
    .bg-card { background-color: #1E1E1E; }
    .bg-input { background-color: #2A2A2A; }
    .border-custom { border-color: #383838; }
    .btn-primary { background-color: #1DB954; color: #FFFFFF; }
    .btn-primary:hover { background-color: #1ED760; }
    .btn-danger { background-color: #dc2626; color: #FFFFFF; }
    .btn-danger:hover { background-color: #b91c1c; }
    .btn-secondary { background-color: #4A4A4A; color: #FFFFFF; }
    .btn-secondary:hover { background-color: #5A5A5A; }
    .btn-primary:disabled, button:disabled { background-color: #555; color: #aaa; cursor: not-allowed; }
    .placeholder-custom::placeholder { color: #888888; }
    [x-cloak] { display: none !important; }
    .format-badge {
      @apply px-2 py-1 text-xs font-semibold rounded-full;
    }
    .format-cd { @apply bg-blue-500 text-white; }
    .format-vinil { @apply bg-purple-500 text-white; }
    .format-cassete { @apply bg-orange-500 text-white; }
    .format-digital { @apply bg-green-500 text-white; }
  </style>
</head>
<body x-data="app" x-init="init()" x-cloak>

  <!-- Loading -->
  <div x-show="isLoading" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50">
    <div class="flex flex-col items-center text-center p-4">
      <div class="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
      <p class="text-white mt-4 text-lg" x-text="loadingMessage"></p>
    </div>
  </div>

  <!-- Notifica√ß√£o -->
  <div x-show="notification.show"
       class="fixed top-5 right-5 z-50 p-4 rounded-md shadow-lg text-white max-w-sm"
       :class="{'bg-green-600': notification.type === 'success', 'bg-red-600': notification.type === 'error', 'bg-blue-600': notification.type === 'info'}"
       x-transition>
    <p x-text="notification.message"></p>
  </div>

  <!-- Modal Compartilhar -->
  <div x-show="shareModal.show" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50" @click.self="shareModal.show = false">
    <div class="bg-card p-8 rounded-lg max-w-md w-full mx-4">
      <h3 class="text-xl font-bold mb-4">üéµ Compartilhar Minha Cole√ß√£o</h3>
      <p class="text-gray-400 mb-4">Copie este link para compartilhar sua cole√ß√£o:</p>
      <div class="flex space-x-2">
        <input :value="shareModal.url" readonly 
               class="flex-1 p-3 bg-input border border-custom rounded-md text-sm">
        <button @click="copyShareLink()" class="px-4 py-3 btn-primary rounded-md">
          <i data-lucide="copy" class="w-4 h-4"></i>
        </button>
      </div>
      <div class="flex justify-end mt-4">
        <button @click="shareModal.show = false" class="px-4 py-2 btn-secondary rounded-md">Fechar</button>
      </div>
    </div>
  </div>

  <!-- Tela de Login -->
  <div x-show="!user && !isLoading" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-green-900 to-black">
    <div class="bg-card p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
      <div class="text-center mb-8">
        <i data-lucide="disc-3" class="mx-auto h-16 w-16 text-green-400 mb-4"></i>
        <h1 class="text-3xl font-bold text-white">Katalog</h1>
        <p class="text-gray-400 mt-2">Organize sua cole√ß√£o musical</p>
      </div>
      
      <div class="space-y-4">
        <button @click="loginAnonymous()" 
                :disabled="authLoading"
                class="w-full py-3 px-4 btn-primary rounded-md font-medium flex items-center justify-center">
          <span x-show="!authLoading">üéµ Entrar Rapidamente</span>
          <span x-show="authLoading" class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></span>
        </button>
        
        <div class="relative">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-gray-600"></div>
          </div>
          <div class="relative flex justify-center text-sm">
            <span class="px-2 bg-card text-gray-400">ou</span>
          </div>
        </div>
        
        <div x-show="showEmailForm" class="space-y-3">
          <input x-model="loginEmail" type="email" placeholder="seu@email.com" 
                 class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          <input x-model="loginPassword" type="password" placeholder="Senha" 
                 class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
          <div class="flex space-x-2">
            <button @click="loginWithEmail()" 
                    :disabled="authLoading"
                    class="flex-1 py-2 btn-secondary rounded-md">Entrar</button>
            <button @click="registerWithEmail()" 
                    :disabled="authLoading"
                    class="flex-1 py-2 btn-primary rounded-md">Cadastrar</button>
          </div>
        </div>
        
        <button @click="showEmailForm = !showEmailForm" 
                class="w-full py-2 text-gray-400 hover:text-white">
          <span x-show="!showEmailForm">üìß Criar Conta</span>
          <span x-show="showEmailForm">‚Üê Voltar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Dashboard -->
  <div x-show="user && !isLoading" class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-black flex-shrink-0 flex flex-col">
      <div class="p-4 flex items-center space-x-2 border-b border-custom">
        <i data-lucide="disc-3" class="text-green-400"></i>
        <h1 class="text-xl font-bold text-white">Katalog</h1>
      </div>
      <nav class="flex-1 p-4 space-y-2">
        <a href="#" @click.prevent="appView = 'collection'" 
           :class="{'bg-green-500 text-white': appView === 'collection'}"
           class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700">
           <i data-lucide="album"></i><span>Minha Cole√ß√£o</span>
        </a>
        <a href="#" @click.prevent="appView = 'add-record'" 
           :class="{'bg-green-500 text-white': appView === 'add-record'}"
           class="flex items-center space-x-3 px-3 py-2 rounded-md hover:bg-gray-700">
           <i data-lucide="plus-circle"></i><span>Adicionar Item</span>
        </a>
      </nav>
      <div class="p-4 border-t border-custom space-y-2">
        <button @click="openShareModal()" 
                class="w-full flex items-center space-x-3 px-3 py-2 rounded-md bg-blue-600/50 hover:bg-blue-700 text-white">
          <i data-lucide="share-2"></i><span>Compartilhar</span>
        </button>
        <div class="px-3 py-2 text-xs text-gray-400 break-words">
          <span class="font-semibold text-gray-300">Usu√°rio:</span>
          <span x-text="user?.email || user?.uid.substring(0, 8) + '...'"></span>
        </div>
        <a href="#" @click.prevent="logout()" 
           class="flex items-center space-x-3 px-3 py-2 rounded-md bg-red-600/50 hover:bg-red-800 text-white">
           <i data-lucide="log-out"></i><span>Sair</span>
        </a>
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-8 overflow-y-auto">
      <!-- Cole√ß√£o -->
      <div x-show="appView === 'collection'">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-3xl font-bold">Minha Cole√ß√£o (<span x-text="collection.length"></span>)</h2>
          <div class="flex space-x-2">
            <button @click="viewMode = 'grid'" 
                    :class="{'btn-primary': viewMode === 'grid', 'btn-secondary': viewMode !== 'grid'}"
                    class="px-4 py-2 rounded-md">
              <i data-lucide="grid-3x3"></i>
            </button>
            <button @click="viewMode = 'list'" 
                    :class="{'btn-primary': viewMode === 'list', 'btn-secondary': viewMode !== 'list'}"
                    class="px-4 py-2 rounded-md">
              <i data-lucide="list"></i>
            </button>
          </div>
        </div>
        
        <!-- Controles -->
        <div class="mb-6 space-y-4">
          <!-- Busca -->
          <input x-model="searchFilter" @input="filterCollection()" 
                 placeholder="üîç Buscar por √°lbum, artista, formato..." 
                 class="w-full max-w-md p-3 bg-input border border-custom rounded-md placeholder-custom">
          
          <!-- Filtros e Ordena√ß√£o -->
          <div class="flex flex-wrap gap-4">
            <select x-model="formatFilter" @change="filterCollection()" 
                    class="p-2 bg-input border border-custom rounded-md">
              <option value="">Todos os formatos</option>
              <option value="CD">üìÄ CD</option>
              <option value="Vinil">üéµ Vinil</option>
              <option value="Cassete">üìº Cassete</option>
              <option value="Digital">üíª Digital</option>
            </select>
            
            <select x-model="sortBy" @change="filterCollection()" 
                    class="p-2 bg-input border border-custom rounded-md">
              <option value="newest">Mais recentes</option>
              <option value="oldest">Mais antigos</option>
              <option value="album-asc">√Ålbum (A-Z)</option>
              <option value="album-desc">√Ålbum (Z-A)</option>
              <option value="artist-asc">Artista (A-Z)</option>
              <option value="artist-desc">Artista (Z-A)</option>
            </select>
          </div>
        </div>
        
        <!-- Grid View -->
        <div x-show="viewMode === 'grid' && filteredCollection.length > 0" 
             class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          <template x-for="record in filteredCollection" :key="record.id">
            <div class="bg-card rounded-lg overflow-hidden shadow-lg group relative transform hover:scale-105 transition-transform">
              <img :src="record.cover_url || `https://placehold.co/300x300/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`" 
                   class="w-full aspect-square object-cover"
                   :alt="`Capa do √°lbum ${record.album}`">
              <div class="absolute top-2 left-2">
                <span :class="`format-${record.format?.toLowerCase() || 'cd'}`" 
                      class="format-badge" 
                      x-text="record.format || 'CD'"></span>
              </div>
              <div class="absolute top-2 right-2">
                <button @click="confirmDelete(record.id)" 
                        class="bg-red-600 text-white rounded-full p-2 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-700">
                  <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
              </div>
              <div class="p-3">
                <h3 class="font-bold text-white truncate" x-text="record.album" :title="record.album"></h3>
                <p class="text-sm text-gray-400 truncate" x-text="record.artist" :title="record.artist"></p>
                <div class="flex justify-between items-center mt-1">
                  <p x-show="record.year" class="text-xs text-gray-500" x-text="record.year"></p>
                  <p x-show="record.catalog_number" class="text-xs text-gray-500 font-mono" x-text="record.catalog_number"></p>
                </div>
                <p x-show="record.edition_notes" class="text-xs text-gray-400 mt-1 truncate" 
                   x-text="record.edition_notes" :title="record.edition_notes"></p>
              </div>
            </div>
          </template>
        </div>
        
        <!-- List View -->
        <div x-show="viewMode === 'list' && filteredCollection.length > 0" 
             class="bg-card rounded-lg overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-800">
              <tr>
                <th class="text-left p-4 font-semibold">Capa</th>
                <th class="text-left p-4 font-semibold">√Ålbum</th>
                <th class="text-left p-4 font-semibold">Artista</th>
                <th class="text-left p-4 font-semibold">Formato</th>
                <th class="text-left p-4 font-semibold">Ano</th>
                <th class="text-left p-4 font-semibold">Cat√°logo</th>
                <th class="text-left p-4 font-semibold">A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="record in filteredCollection" :key="record.id">
                <tr class="border-b border-gray-700 hover:bg-gray-800">
                  <td class="p-4">
                    <img :src="record.cover_url || `https://placehold.co/60x60/1E1E1E/E0E0E0?text=${record.album.charAt(0)}`" 
                         class="w-12 h-12 object-cover rounded">
                  </td>
                  <td class="p-4">
                    <div>
                      <p class="font-semibold" x-text="record.album"></p>
                      <p x-show="record.edition_notes" class="text-xs text-gray-400" x-text="record.edition_notes"></p>
                    </div>
                  </td>
                  <td class="p-4" x-text="record.artist"></td>
                  <td class="p-4">
                    <span :class="`format-${record.format?.toLowerCase() || 'cd'}`" 
                          class="format-badge" 
                          x-text="record.format || 'CD'"></span>
                  </td>
                  <td class="p-4" x-text="record.year || '-'"></td>
                  <td class="p-4">
                    <span x-show="record.catalog_number" class="font-mono text-sm" x-text="record.catalog_number"></span>
                    <span x-show="!record.catalog_number" class="text-gray-500">-</span>
                  </td>
                  <td class="p-4">
                    <button @click="confirmDelete(record.id)" 
                            class="text-red-400 hover:text-red-300">
                      <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        
        <!-- Empty State -->
        <div x-show="collection.length === 0" class="text-center py-20 bg-card rounded-lg">
          <i data-lucide="folder-x" class="mx-auto h-16 w-16 text-gray-500 mb-4"></i>
          <h3 class="text-xl font-semibold">Sua cole√ß√£o est√° vazia</h3>
          <p class="text-gray-400 mt-2">Comece adicionando seu primeiro item!</p>
          <button @click="appView = 'add-record'" class="mt-6 px-6 py-2 rounded-full btn-primary">Adicionar Item</button>
        </div>
        
        <!-- No Results -->
        <div x-show="collection.length > 0 && filteredCollection.length === 0" class="text-center py-10">
          <p class="text-gray-400">Nenhum resultado encontrado</p>
          <button @click="clearFilters()" class="mt-2 px-4 py-2 btn-secondary rounded-md">Limpar Filtros</button>
        </div>
      </div>

      <!-- Form Adicionar -->
      <div x-show="appView === 'add-record'">
        <h2 class="text-3xl font-bold mb-6">Adicionar Novo Item</h2>
        <form @submit.prevent="addRecord" class="max-w-3xl mx-auto bg-card p-8 rounded-lg space-y-6">
          
          <!-- Informa√ß√µes B√°sicas -->
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">√Ålbum/T√≠tulo *</label>
              <input x-model="newRecord.album" required 
                     class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Artista *</label>
              <input x-model="newRecord.artist" required 
                     class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
            </div>
          </div>
          
          <!-- Formato e Ano -->
          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Formato *</label>
              <select x-model="newRecord.format" required
                      class="w-full p-3 bg-input border border-custom rounded-md">
                <option value="">Selecione...</option>
                <option value="CD">üìÄ CD</option>
                <option value="Vinil">üéµ Vinil</option>
                <option value="Cassete">üìº Cassete</option>
                <option value="Digital">üíª Digital</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Ano</label>
              <input x-model="newRecord.year" type="number" min="1900" max="2030"
                     class="w-full p-3 bg-input border border-custom rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">N√∫mero de Cat√°logo</label>
              <input x-model="newRecord.catalog_number" placeholder="Ex: EVIL0023"
                     class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom">
            </div>
          </div>

          <!-- Descri√ß√£o da Edi√ß√£o -->
          <div>
            <label class="block text-sm font-medium mb-1">Descri√ß√£o da Edi√ß√£o</label>
            <textarea x-model="newRecord.edition_notes" 
                      placeholder="Ex: Edi√ß√£o limitada com capa dourada, remasterizado..."
                      class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom resize-none"
                      rows="3"></textarea>
          </div>

          <!-- Capa -->
          <div>
            <label class="block text-sm font-medium mb-3">Capa do √Ålbum</label>
            
            <!-- Bot√£o de busca -->
            <div class="mb-4">
              <button type="button" @click="searchCoverOnGoogle()" 
                      :disabled="!newRecord.album || !newRecord.artist || coverSearchLoading"
                      class="px-4 py-2 btn-primary rounded-md flex items-center">
                <i data-lucide="search" class="w-4 h-4 mr-2"></i>
                <span x-show="!coverSearchLoading">üîç Buscar Capa no Google</span>
                <span x-show="coverSearchLoading">Buscando...</span>
              </button>
            </div>
            
            <!-- URL Manual -->
            <input x-model="newRecord.cover_url" placeholder="üåê Cole aqui a URL da capa..."
                   class="w-full p-3 bg-input border border-custom rounded-md placeholder-custom mb-4">
            
            <!-- Preview -->
            <div x-show="newRecord.cover_url" class="mb-4">
              <p class="text-sm text-gray-400 mb-2">Preview:</p>
              <img :src="newRecord.cover_url" class="w-32 h-32 object-cover rounded-md" 
                   @error="newRecord.cover_url = ''" alt="Preview da capa">
            </div>
          </div>
          
          <div class="flex space-x-4">
            <button type="submit" :disabled="formLoading" 
                    class="flex-1 py-3 font-semibold rounded-md btn-primary flex items-center justify-center">
              <span x-show="!formLoading">üíæ Salvar Item</span>
              <span x-show="formLoading" class="flex items-center">
                <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
                Salvando...
              </span>
            </button>
            <button type="button" @click="resetForm()" 
                    class="px-6 py-3 btn-secondary rounded-md">Limpar</button>
          </div>
        </form>
      </div>
    </main>
  </div>

  <script>
    // üî• SUAS CONFIGURA√á√ïES DO FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyAzEu2hLmvPzaFLgQtXUAUkuXvwokD2F-A",
      authDomain: "katalog-1178e.firebaseapp.com",
      projectId: "katalog-1178e",
      storageBucket: "katalog-1178e.firebasestorage.app",
      messagingSenderId: "998961219093",
      appId: "1:998961219093:web:6afddd14ad2ddd9ed3301c"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    document.addEventListener('alpine:init', () => {
      Alpine.data('app', () => ({
        // Estados principais
        isLoading: true,
        loadingMessage: 'Inicializando...',
        user: null,
        authLoading: false,
        formLoading: false,
        coverSearchLoading: false,
        
        // UI
        appView: 'collection',
        viewMode: 'grid',
        showEmailForm: false,
        searchFilter: '',
        formatFilter: '',
        sortBy: 'newest',
        
        // Modals
        shareModal: { show: false, url: '' },
        
        // Dados
        collection: [],
        filteredCollection: [],
        newRecord: { 
          album: '', 
          artist: '', 
          format: '',
          year: '', 
          catalog_number: '',
          edition_notes: '',
          cover_url: '' 
        },
        
        // Auth
        loginEmail: '',
        loginPassword: '',
        
        // Notifica√ß√£o
        notification: { show: false, message: '', type: 'success' },
        collectionListener: null,

        async init() {
          try {
            this.loadingMessage = 'Conectando...';
            
            // Configurar listener de autentica√ß√£o
            auth.onAuthStateChanged((user) => {
              this.user = user;
              if (user) {
                this.setupCollection(user.uid);
              } else {
                this.collection = [];
                this.filteredCollection = [];
              }
              this.isLoading = false;
            });
            
          } catch (error) {
            console.error('Erro ao inicializar:', error);
            this.showNotification("Erro ao inicializar aplica√ß√£o", "error");
            this.isLoading = false;
          }
          
          // Inicializar √≠cones
          this.$nextTick(() => {
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
          });
        },

        // === AUTENTICA√á√ÉO ===
        async loginAnonymous() {
          this.authLoading = true;
          try {
            await auth.signInAnonymously();
            this.showNotification("Bem-vindo ao Katalog! üéµ", "success");
          } catch (error) {
            console.error('Erro no login:', error);
            this.showNotification("Erro ao fazer login", "error");
          } finally {
            this.authLoading = false;
          }
        },

        async loginWithEmail() {
          if (!this.loginEmail || !this.loginPassword) {
            this.showNotification("Preencha email e senha", "error");
            return;
          }
          
          this.authLoading = true;
          try {
            await auth.signInWithEmailAndPassword(this.loginEmail, this.loginPassword);
            this.showNotification("Login realizado com sucesso!", "success");
            this.loginEmail = '';
            this.loginPassword = '';
            this.showEmailForm = false;
          } catch (error) {
            console.error('Erro no login:', error);
            this.showNotification("Email ou senha incorretos", "error");
          } finally {
            this.authLoading = false;
          }
        },

        async registerWithEmail() {
          if (!this.loginEmail || !this.loginPassword) {
            this.showNotification("Preencha email e senha", "error");
            return;
          }
          
          if (this.loginPassword.length < 6) {
            this.showNotification("Senha deve ter pelo menos 6 caracteres", "error");
            return;
          }
          
          this.authLoading = true;
          try {
            await auth.createUserWithEmailAndPassword(this.loginEmail, this.loginPassword);
            this.showNotification("Conta criada com sucesso!", "success");
            this.loginEmail = '';
            this.loginPassword = '';
            this.showEmailForm = false;
          } catch (error) {
            console.error('Erro ao registrar:', error);
            if (error.code === 'auth/email-already-in-use') {
              this.showNotification("Este email j√° est√° em uso", "error");
            } else {
              this.showNotification("Erro ao criar conta", "error");
            }
          } finally {
            this.authLoading = false;
          }
        },

        async logout() {
          try {
            await auth.signOut();
            this.showNotification("Logout realizado com sucesso", "success");
            this.appView = 'collection';
          } catch (error) {
            console.error('Erro ao sair:', error);
            this.showNotification("Erro ao sair", "error");
          }
        },

        // === FIRESTORE ===
        setupCollection(userId) {
          if (this.collectionListener) {
            this.collectionListener();
          }
          
          this.collectionListener = db.collection(`users/${userId}/records`)
            .orderBy('createdAt', 'desc')
            .onSnapshot((snapshot) => {
              this.collection = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
              }));
              this.filterCollection();
            }, (error) => {
              console.error('Erro ao carregar cole√ß√£o:', error);
              this.showNotification("Erro ao carregar cole√ß√£o", "error");
            });
        },

        filterCollection() {
          let filtered = [...this.collection];
          
          // Filtro por texto
          if (this.searchFilter.trim()) {
            const filter = this.searchFilter.toLowerCase();
            filtered = filtered.filter(record => 
              record.album.toLowerCase().includes(filter) ||
              record.artist.toLowerCase().includes(filter) ||
              record.format?.toLowerCase().includes(filter) ||
              record.catalog_number?.toLowerCase().includes(filter) ||
              record.edition_notes?.toLowerCase().includes(filter)
            );
          }
          
          // Filtro por formato
          if (this.formatFilter) {
            filtered = filtered.filter(record => record.format === this.formatFilter);
          }
          
          // Ordena√ß√£o
          switch (this.sortBy) {
            case 'newest':
              filtered.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
              break;
            case 'oldest':
              filtered.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
              break;
            case 'album-asc':
              filtered.sort((a, b) => a.album.localeCompare(b.album));
              break;
            case 'album-desc':
              filtered.sort((a, b) => b.album.localeCompare(a.album));
              break;
            case 'artist-asc':
              filtered.sort((a, b) => a.artist.localeCompare(b.artist));
              break;
            case 'artist-desc':
              filtered.sort((a, b) => b.artist.localeCompare(a.artist));
              break;
          }
          
          this.filteredCollection = filtered;
        },

        clearFilters() {
          this.searchFilter = '';
          this.formatFilter = '';
          this.sortBy = 'newest';
          this.filterCollection();
        },

        async addRecord() {
          if (!this.newRecord.album.trim() || !this.newRecord.artist.trim() || !this.newRecord.format) {
            this.showNotification("√Ålbum, Artista e Formato s√£o obrigat√≥rios", "error");
            return;
          }
          
          this.formLoading = true;
          
          try {
            const recordData = {
              album: this.newRecord.album.trim(),
              artist: this.newRecord.artist.trim(),
              format: this.newRecord.format,
              year: this.newRecord.year ? Number(this.newRecord.year) : null,
              catalog_number: this.newRecord.catalog_number?.trim() || null,
              edition_notes: this.newRecord.edition_notes?.trim() || null,
              cover_url: this.newRecord.cover_url?.trim() || null,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection(`users/${this.user.uid}/records`).add(recordData);
            
            this.showNotification("Item adicionado com sucesso! üéâ", "success");
            this.resetForm();
            this.appView = 'collection';
            
          } catch (error) {
            console.error('Erro ao adicionar item:', error);
            this.showNotification("Erro ao salvar item", "error");
          } finally {
            this.formLoading = false;
          }
        },

        async confirmDelete(id) {
          if (!confirm('Tem certeza que deseja excluir este item da sua cole√ß√£o?')) {
            return;
          }
          
          try {
            await db.collection(`users/${this.user.uid}/records`).doc(id).delete();
            this.showNotification("Item exclu√≠do com sucesso!", "success");
          } catch (error) {
            console.error('Erro ao excluir:', error);
            this.showNotification("Erro ao excluir item", "error");
          }
        },

        // === BUSCA DE CAPA ===
        searchCoverOnGoogle() {
          if (!this.newRecord.album.trim() || !this.newRecord.artist.trim()) {
            this.showNotification("Preencha √°lbum e artista primeiro!", "error");
            return;
          }
          
          const query = `${this.newRecord.artist} ${this.newRecord.album} album cover`;
          const googleUrl = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(query)}`;
          
          window.open(googleUrl, '_blank');
          this.showNotification("Clique com o bot√£o direito na imagem ‚Üí 'Copiar endere√ßo da imagem'", "info");
        },

        // === COMPARTILHAMENTO ===
        openShareModal() {
          // Criar um link p√∫blico para a cole√ß√£o
          const baseUrl = window.location.origin + window.location.pathname;
          const shareUrl = `${baseUrl}?user=${this.user.uid}&view=public`;
          
          this.shareModal = {
            show: true,
            url: shareUrl
          };
        },

        async copyShareLink() {
          try {
            await navigator.clipboard.writeText(this.shareModal.url);
            this.showNotification("Link copiado! üìã", "success");
          } catch (error) {
            // Fallback para navegadores mais antigos
            const textArea = document.createElement('textarea');
            textArea.value = this.shareModal.url;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            this.showNotification("Link copiado! üìã", "success");
          }
        },

        // === UTILIT√ÅRIOS ===
        resetForm() {
          this.newRecord = { 
            album: '', 
            artist: '', 
            format: '',
            year: '', 
            catalog_number: '',
            edition_notes: '',
            cover_url: '' 
          };
        },

        showNotification(message, type = 'success') {
          this.notification = { message, type, show: true };
          setTimeout(() => { this.notification.show = false; }, 4000);
        }
      }))
    });
  </script>
</body>
</html>
